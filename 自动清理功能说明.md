# 🧹 自动清理45天前文件功能说明

## ✅ 功能概述

新增了"自动清理45天前文件"功能，用于定期删除R2存储中超过45天的旧文件，节省存储空间。

---

## 🎯 功能特性

### 1. **自动删除机制**
- **删除策略**：删除文件夹日期超过45天的所有文件
- **删除范围**：仅删除 `package/` 文件夹下的文件
- **保留策略**：保留最近45天的文件
- **安全机制**：双重确认，防止误删

### 2. **智能识别**
- 自动从文件路径解析日期（格式：`package/YYYY-MM/YYYY-MM-DD/...`）
- 按日期分组统计
- 批量删除旧日期文件夹中的所有文件

### 3. **操作反馈**
- 显示删除进度
- 报告删除的文件数量和涉及的日期
- 列出被删除的日期文件夹列表

---

## 📋 使用流程

### 执行清理操作

```
1. 进入"📂 文件管理"页面
   ↓
2. 点击"🧹 自动清理45天前文件"按钮
   ↓
3. 弹出确认提示（显示截止日期）
   ↓
4. 点击"确定"或"取消"
   ↓
5. 如果是"确定"，再次弹出最终确认
   ↓
6. 再次确认后开始执行清理
   ↓
7. 显示清理结果和统计信息
   ↓
8. 自动刷新文件列表
```

### 示例操作界面

**第一次确认：**
```
⚠️ 确定要删除45天之前（2025-09-08之前）的所有文件吗？

此操作将永久删除文件且无法恢复！

[确定] [取消]
```

**第二次确认：**
```
⚠️ 最后确认：此操作不可恢复，确定继续吗？

[确定] [取消]
```

**清理结果：**
```
✅ 清理完成！

删除了 156 个文件
涉及 8 个日期文件夹：
2025-09-01, 2025-09-02, 2025-09-03, 2025-09-04, 2025-09-05, ...
```

---

## 🔍 技术细节

### 删除逻辑

**后端处理（worker.js）：**

```javascript
1. 计算截止日期：当前日期 - 45天
2. 获取所有 package/ 下的文件
3. 按日期分组文件
4. 识别需要删除的日期（< 截止日期）
5. 批量删除该日期下的所有文件
6. 返回删除统计信息
```

**前端处理（package-system.html）：**

```javascript
1. 显示双重确认对话框
2. 调用后端 API: POST /api/package/cleanup-old-files
3. 显示清理进度
4. 展示清理结果
5. 刷新文件列表
```

### API 接口

**请求：**
```http
POST /api/package/cleanup-old-files
Content-Type: application/json
```

**响应：**
```json
{
  "success": true,
  "message": "成功清理 156 个文件",
  "deletedCount": 156,
  "deletedFolders": ["2025-09-01", "2025-09-02", ...],
  "cutoffDate": "2025-09-08T00:00:00.000Z"
}
```

---

## ⚠️ 注意事项

### 1. **不可逆操作**
- 删除的文件无法恢复
- 建议清理前先导出重要文件

### 2. **删除范围**
- 只删除 `package/` 下的文件
- 不删除其他文件夹（如 `database/`、`wide/` 等）
- 不删除同步文件（`package-sync/`）

### 3. **时间计算**
- 基于文件夹日期，而非上传时间
- 例如：文件夹是 `2025-09-01`，只要当前日期 > `2025-10-16` 就会删除

### 4. **批量操作**
- 如果文件很多，清理可能需要几十秒
- 建议在网络良好的情况下执行
- 清理过程中不要刷新页面

### 5. **存储记录**
- 删除R2文件后，本地 `uploadedFiles` Map 可能还有旧记录
- 需要手动刷新文件列表或重新加载页面

---

## 📊 清理示例

### 场景1：正常清理

**当前日期：** 2025-10-23  
**截止日期：** 2025-09-08（45天前）

**存储中的文件：**
```
package/2025-07/2025-07-15/... (删除) ✓
package/2025-08/2025-08-20/... (删除) ✓
package/2025-09/2025-09-05/... (删除) ✓
package/2025-09/2025-09-10/... (保留) ○
package/2025-10/2025-10-01/... (保留) ○
package/2025-10/2025-10-23/... (保留) ○
```

**清理结果：**
```
删除文件：156 个
删除日期：2025-07-15, 2025-08-20, 2025-09-05
保留文件：89 个
```

### 场景2：没有旧文件

**存储中的文件：**
```
package/2025-10/2025-10-20/... (全部保留)
package/2025-10/2025-10-22/...
package/2025-10/2025-10-23/...
```

**清理结果：**
```
ℹ️ 没有需要清理的文件
```

---

## 🎨 界面展示

### 清理按钮

```
文件管理页面顶部工具栏：

[🔄 刷新列表] [🔍 调试文件记录] [📦 导出所有文件] 
[📝 批量修正今日未匹配] [🗑️ 删除文件] 
[🧹 自动清理45天前文件]  ← 新增按钮（橙色警告色）
```

### 清理进度

```
⏳ 正在清理45天之前的文件，请稍候...
```

### 清理结果

```
✅ 清理完成！

删除了 156 个文件
涉及 8 个日期文件夹：
2025-09-01, 2025-09-02, 2025-09-03, 2025-09-04, 2025-09-05
2025-09-06, 2025-09-07, 2025-09-08
```

---

## 🔧 开发说明

### 修改的文件

**1. worker.js**
- 新增 `cleanupOldFiles()` 函数（第984-1083行）
- 添加路由：`/api/package/cleanup-old-files`（第1213-1215行）

**2. package-system.html**
- 新增清理按钮（第978行）
- 新增 `cleanupOldFiles()` 函数（第4085-4144行）

### 关键代码

**后端清理逻辑：**
```javascript
// 计算截止日期
const DAYS_TO_KEEP = 45;
const cutoffDate = new Date();
cutoffDate.setDate(cutoffDate.getDate() - DAYS_TO_KEEP);

// 解析文件路径中的日期
// package/YYYY-MM/YYYY-MM-DD/filename.ext
const [year, month, day] = yearMonthDay.split('-').map(Number);
const folderDate = new Date(year, month - 1, day);

// 判断是否需要删除
if (folderDate.getTime() < cutoffTimestamp) {
  // 删除该日期下的所有文件
}
```

**前端调用逻辑：**
```javascript
// 双重确认
if (!confirm('确定要删除45天之前的文件吗？')) return;
if (!confirm('最后确认：此操作不可恢复，确定继续吗？')) return;

// 调用API
const response = await fetch(`${baseURL}/api/package/cleanup-old-files`, {
  method: 'POST'
});

// 显示结果
const result = await response.json();
showStatus('fileManageStatus', `清理完成！删除了 ${result.deletedCount} 个文件`, 'success');
```

---

## ✅ 功能测试清单

### 手动测试步骤

1. **准备测试数据**
```javascript
// 在R2中创建一些旧日期的测试文件
package/2025-08/2025-08-01/test.jpg
package/2025-09/2025-09-01/test.jpg
package/2025-09/2025-09-15/test.jpg
```

2. **执行清理**
- 点击"🧹 自动清理45天前文件"
- 确认操作
- 查看清理结果

3. **验证结果**
- 检查旧文件是否已删除
- 检查新文件是否保留
- 查看删除统计信息

4. **测试边界情况**
- 没有旧文件的情况
- 所有文件都是旧文件的情况
- 网络异常的情况

---

## 🚀 未来优化建议

### 短期优化
1. **自动清理计划**
   - 添加定时任务（如每天凌晨自动清理）
   - 使用 Cloudflare Workers 的 Cron Triggers

2. **清理前备份**
   - 清理前自动导出文件列表
   - 可选导出重要文件到归档

3. **更灵活的配置**
   - 允许用户自定义保留天数
   - 可按文件夹筛选清理范围

### 长期优化
1. **渐进式清理**
   - 先清理45-60天的文件
   - 再清理30-45天的文件
   - 避免一次性删除过多文件

2. **清理日志**
   - 记录每次清理的详细信息
   - 保存清理历史记录

3. **存储分析**
   - 显示存储空间使用情况
   - 预估清理后节省的空间

---

## 📊 删除示例

### 假设当前日期是 2025-10-23

**保留的文件：**
- package/2025-09/2025-09-09/... (44天前) ✓
- package/2025-09/2025-09-10/... (43天前) ✓
- package/2025-09/2025-10-01/... (22天前) ✓
- package/2025-10/2025-10-23/... (今天) ✓

**删除的文件：**
- package/2025-07/2025-07-15/... (100天前) ✗
- package/2025-08/2025-08-01/... (83天前) ✗
- package/2025-09/2025-09-01/... (52天前) ✗
- package/2025-09/2025-09-08/... (45天前) ✗

### 日期计算逻辑

```javascript
// 计算45天前的日期
const cutoff = new Date('2025-10-23');
cutoff.setDate(cutoff.getDate() - 45);
// cutoff = 2025-09-08

// 文件日期 vs 截止日期
new Date('2025-09-08') < cutoff → 删除 ✗
new Date('2025-09-09') >= cutoff → 保留 ✓
```

---

## ⚙️ 配置参数

### 修改保留天数

**位置：** `worker.js` 第989行

```javascript
const DAYS_TO_KEEP = 45; // 修改这里改变保留天数
```

**示例：**
```javascript
const DAYS_TO_KEEP = 30; // 保留30天
const DAYS_TO_KEEP = 60; // 保留60天
const DAYS_TO_KEEP = 90; // 保留90天
```

---

## 📝 最佳实践

### 1. **定期清理**
- 建议每月执行一次清理
- 可根据存储空间需求调整频率

### 2. **清理前检查**
- 确认重要文件已导出
- 检查待处理的文件状态

### 3. **清理后验证**
- 刷新文件列表
- 确认旧文件已删除
- 确认新文件仍存在

### 4. **备份重要数据**
- 定期导出文件清单
- 备份重要的文件副本

---

**功能状态：** ✅ 已完成  
**测试状态：** ⏳ 待测试  
**文档版本：** v1.0  
**最后更新：** 2025-10-23

