<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯•Excelä¸Šä¼ å’Œæ•°æ®åˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Excelå¯¼å…¥å’Œæ•°æ®åˆ†ææµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>1. åˆ›å»ºæµ‹è¯•Excelæ–‡ä»¶</h3>
            <button class="button" onclick="createTestExcel()">ç”Ÿæˆæµ‹è¯•Excelæ–‡ä»¶</button>
            <div id="excel-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. æ¨¡æ‹Ÿå‰ç«¯Excelè§£æ</h3>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="margin: 10px 0;">
            <button class="button" onclick="parseAndUpload()">è§£æå¹¶ä¸Šä¼ åˆ°Worker</button>
            <div id="upload-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. æµ‹è¯•æ•°æ®åˆ†æAPI</h3>
            <button class="button" onclick="testAnalytics()">æµ‹è¯•é”€å”®åˆ†æ</button>
            <button class="button" onclick="testInventory()">æµ‹è¯•åº“å­˜æ•°æ®</button>
            <button class="button" onclick="testRecords()">æµ‹è¯•å†å²è®°å½•</button>
            <div id="api-result" class="result"></div>
        </div>
    </div>

    <script>
        // é…ç½®Worker URLï¼ˆè¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…URLï¼‰
        const WORKER_URL = 'https://your-worker.your-subdomain.workers.dev';
        
        // åˆ›å»ºæµ‹è¯•Excelæ–‡ä»¶
        function createTestExcel() {
            const testData = [
                ['SKU', 'äº§å“ä¸­æ–‡å', 'ç½‘é¡µé“¾æ¥', 'åˆå§‹åº“å­˜', '2025-09-05', '2025-09-06', '2025-09-07', '2025-09-08', '2025-09-09'],
                ['X000001', 'Arc\'teryx Beta ARå¤¹å…‹ é»‘è‰² M', 'https://arcteryx.com/test1', 100, 95, 90, 85, 80, 75],
                ['X000002', 'Arc\'teryx Atom LTé©¬ç”² è“è‰² L', 'https://arcteryx.com/test2', 80, 78, 75, 70, 65, 60],
                ['X000003', 'Arc\'teryx Gamma SLçŸ­è£¤ ç»¿è‰² S', 'https://arcteryx.com/test3', 60, 58, 55, 50, 45, 40],
                ['X000004', 'Arc\'teryx Beta ARå¤¹å…‹ çº¢è‰² XL', 'https://arcteryx.com/test4', 120, 115, 110, 105, 100, 95],
                ['X000005', 'Arc\'teryx Atom LTé©¬ç”² é»‘è‰² M', 'https://arcteryx.com/test5', 90, 88, 85, 80, 75, 70]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(testData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'åº“å­˜æ•°æ®');
            XLSX.writeFile(wb, 'test-inventory.xlsx');
            
            document.getElementById('excel-result').innerHTML = 
                '<span class="success">âœ… æµ‹è¯•Excelæ–‡ä»¶å·²ç”Ÿæˆï¼štest-inventory.xlsx</span>';
        }
        
        // è§£æExcelå¹¶ä¸Šä¼ 
        async function parseAndUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('upload-result').innerHTML = 
                    '<span class="error">âŒ è¯·å…ˆé€‰æ‹©Excelæ–‡ä»¶</span>';
                return;
            }
            
            try {
                // è§£æExcel
                const arrayBuffer = await file.arrayBuffer();
                const wb = XLSX.read(arrayBuffer, { type: 'array' });
                const sheet = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                
                document.getElementById('upload-result').innerHTML = 
                    `<div>ğŸ“Š è§£ææˆåŠŸï¼š${rows.length} è¡Œæ•°æ®</div>`;
                
                // ä¸Šä¼ åˆ°Worker
                const response = await fetch(`${WORKER_URL}/api/localdb/wide`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: rows })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('upload-result').innerHTML += 
                        `<div class="success">âœ… ä¸Šä¼ æˆåŠŸï¼å®½è¡¨ï¼š${result.wideTableCount} è¡Œï¼Œå†å²è®°å½•ï¼š${result.recordsCount} æ¡</div>`;
                } else {
                    document.getElementById('upload-result').innerHTML += 
                        `<div class="error">âŒ ä¸Šä¼ å¤±è´¥ï¼š${result.error}</div>`;
                }
                
            } catch (error) {
                document.getElementById('upload-result').innerHTML += 
                    `<div class="error">âŒ å¤„ç†å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•é”€å”®åˆ†æAPI
        async function testAnalytics() {
            try {
                const response = await fetch(`${WORKER_URL}/api/analytics/sales`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('api-result').innerHTML = 
                        `<div class="success">âœ… é”€å”®åˆ†æAPIæµ‹è¯•æˆåŠŸ</div>
                         <pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                } else {
                    document.getElementById('api-result').innerHTML = 
                        `<div class="error">âŒ é”€å”®åˆ†æAPIå¤±è´¥ï¼š${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('api-result').innerHTML = 
                    `<div class="error">âŒ APIè°ƒç”¨å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•åº“å­˜æ•°æ®API
        async function testInventory() {
            try {
                const response = await fetch(`${WORKER_URL}/api/inventory/summary`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('api-result').innerHTML = 
                        `<div class="success">âœ… åº“å­˜æ±‡æ€»APIæµ‹è¯•æˆåŠŸï¼Œæ•°æ®æ¡æ•°ï¼š${result.data.length}</div>
                         <pre>${JSON.stringify(result.data.slice(0, 3), null, 2)}</pre>`;
                } else {
                    document.getElementById('api-result').innerHTML = 
                        `<div class="error">âŒ åº“å­˜æ±‡æ€»APIå¤±è´¥ï¼š${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('api-result').innerHTML = 
                    `<div class="error">âŒ APIè°ƒç”¨å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•å†å²è®°å½•API
        async function testRecords() {
            try {
                const response = await fetch(`${WORKER_URL}/api/localdb/records`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('api-result').innerHTML = 
                        `<div class="success">âœ… å†å²è®°å½•APIæµ‹è¯•æˆåŠŸï¼Œè®°å½•æ¡æ•°ï¼š${result.data.length}</div>
                         <pre>${JSON.stringify(result.data.slice(0, 3), null, 2)}</pre>`;
                } else {
                    document.getElementById('api-result').innerHTML = 
                        `<div class="error">âŒ å†å²è®°å½•APIå¤±è´¥ï¼š${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('api-result').innerHTML = 
                    `<div class="error">âŒ APIè°ƒç”¨å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
