<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>å§‹ç¥–é¸Ÿå¤–ç½‘æ•°æ®åˆ†æ - æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="./src/css/layui.css" rel="stylesheet">
  <link href="./src/css/app-header.css" rel="stylesheet">
  <script src="./api-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    body {
      background: #f8f9fa;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header .layui-nav {
      background: transparent;
    }
    .header .layui-nav .layui-nav-item a {
      color: rgba(255,255,255,0.9);
    }
    .header .layui-nav .layui-nav-item a:hover {
      color: white;
    }
    .header .logo {
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
    }
    
    /* ä¸»å¯¼èˆªæ ·å¼ */
    .main-nav {
      flex: 1;
      display: flex;
      justify-content: center;
      margin: 0 20px;
    }
    .main-nav .layui-nav-item {
      margin: 0 5px;
    }
    .main-nav .layui-nav-item a {
      padding: 0 20px;
      border-radius: 20px;
      transition: all 0.3s ease;
    }
    .main-nav .layui-nav-item a:hover {
      background: rgba(255,255,255,0.2);
    }
    .main-nav .layui-this a {
      background: rgba(255,255,255,0.3) !important;
    }

    /* é¡µé¢é¡¶éƒ¨æŒ‰é’®åŒºåŸŸ */
    .top-actions {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    /* é¡µé¢å®¹å™¨ */
    .page-container {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* åˆ†æèŒƒå›´æ§åˆ¶é¢æ¿ */
    .analysis-controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* åŸºç¡€ç»Ÿè®¡å¡ç‰‡ */
    .stats-container {
      margin-bottom: 30px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    .stats-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      text-align: center;
      transition: transform 0.3s ease;
    }
    .stats-card:hover {
      transform: translateY(-5px);
    }
    .stats-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #16baaa;
      margin-bottom: 8px;
    }
    .stats-label {
      color: #666;
      font-size: 14px;
      font-weight: 500;
    }
    .stats-trend {
      margin-top: 10px;
      font-size: 12px;
    }
    .trend-up { color: #52c41a; }
    .trend-down { color: #f5222d; }
    .trend-stable { color: #fa8c16; }
    
    /* å›¾è¡¨å®¹å™¨ */
    .chart-container {
      background: white;
      margin-bottom: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .chart-header {
      padding: 20px 25px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chart-title {
      margin: 0;
      color: #333;
      font-size: 16px;
      font-weight: 600;
    }
    .chart-controls {
      display: flex;
      gap: 8px;
    }
    .chart-content {
      padding: 20px 25px;
    }
    .chart {
      height: 350px;
      width: 100%;
    }
    
    /* è¡¨æ ¼å®¹å™¨ */
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      overflow: hidden;
      margin-bottom: 25px;
    }
    .table-header {
      padding: 20px 25px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .table-header h3 {
      margin: 0;
      color: #333;
      font-size: 16px;
      font-weight: 600;
    }
    .table-header p {
      margin: 5px 0 0 0;
      color: #666;
      font-size: 14px;
    }
    
    /* SKUåˆ†æè¡¨æ ¼æ ·å¼ */
    .analysis-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .analysis-table th,
    .analysis-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }
    .analysis-table th {
      background: #f8f9fa;
      font-weight: bold;
      color: #333;
    }
    .analysis-table tbody tr:hover {
      background: #f5f5f5;
    }
    .analysis-table .sku-cell {
      font-family: 'Courier New', monospace;
      font-weight: bold;
      color: #1890ff;
    }
    
    /* ä¸Šä¸‹æ¶ç®¡ç†ï¼ˆéšè—çŠ¶æ€ï¼Œä¿ç•™ä»£ç ï¼‰ */
    .listing-management-container {
      display: none; /* æš‚æ—¶éšè—ï¼Œä¸ºè™šæ‹Ÿåº“å­˜åŠŸèƒ½ä¿ç•™ */
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      overflow: hidden;
      margin-bottom: 25px;
    }
    .listing-section {
      padding: 20px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .section-controls {
      display: flex;
      gap: 8px;
    }
    .listing-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: white;
      border-radius: 6px;
      overflow: hidden;
    }
    .listing-table th,
    .listing-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }
    .listing-table th {
      background: #f8f9fa;
      font-weight: bold;
      color: #333;
    }
    .listing-table tbody tr:hover {
      background: #f5f5f5;
    }
    .listing-table .sku-cell {
      font-family: 'Courier New', monospace;
      font-weight: bold;
    }
    .listing-table .url-cell {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .listing-table .url-cell a {
      color: #16baaa;
      text-decoration: none;
    }
    .listing-table .url-cell a:hover {
      text-decoration: underline;
    }
    
    /* ç¿»é¡µåŠŸèƒ½æ ·å¼ */
    .table-controls {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      color: #666;
      font-size: 14px;
      margin-top: 10px;
    }
    .table-controls select {
      padding: 4px 8px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      background: white;
    }
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: #fafafa;
      border-top: 1px solid #f0f0f0;
      margin-top: 0;
    }
    .pagination-info {
      color: #666;
      font-size: 14px;
    }
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pagination-controls input {
      padding: 4px 8px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      text-align: center;
    }

    /* çˆ†æ¬¾æ»é”€åˆ†æä¸“ç”¨æ ·å¼ */
    .hot-slow-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .hot-slow-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .hot-slow-number {
      font-size: 2em;
      font-weight: bold;
      color: #1E9FFF;
    }
    .hot-slow-label {
      color: #666;
      margin-top: 5px;
    }
    
    /* äº§å“è¯¦ç»†åˆ—è¡¨ */
    .product-list {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .product-list h3 {
      margin-bottom: 15px;
      color: #333;
    }
    .layui-table {
      margin-top: 0;
    }
    .layui-table th, .layui-table td {
      text-align: center;
    }
    .product-name {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .hot-product { color: #FF5722; font-weight: bold; }
    .slow-product { color: #757575; }
    .normal-product { color: #333; }
  </style>
</head>
<body>
  <div class="layui-header header">
    <div class="logo">
      ğŸ“Š æ•°æ®ç®¡ç†ç³»ç»Ÿ
    </div>
    <div class="main-nav">
      <ul class="layui-nav">
        <li class="layui-nav-item"><a href="unified-index.html">é¦–é¡µæ€»è§ˆ</a></li>
        <li class="layui-nav-item"><a href="local-database.html">æœ¬åœ°æ•°æ®åº“</a></li>
        <li class="layui-nav-item layui-this"><a href="arcteryx-data-analysis.html">å§‹ç¥–é¸Ÿå¤–ç½‘æ•°æ®åˆ†æ</a></li>
        <li class="layui-nav-item"><a href="tmall-database.html">å¤©çŒ«æ•°æ®åº“</a></li>
        <li class="layui-nav-item"><a href="package-system.html">å‘åŒ…ç³»ç»Ÿ</a></li>
        <li class="layui-nav-item"><a href="user-management.html">ç”¨æˆ·ç®¡ç†</a></li>
      </ul>
    </div>
    <div class="layui-nav">
      <li class="layui-nav-item">
        <a href="javascript:;" id="userInfo">
          <img src="//unpkg.com/outicons@1.0.0/icons/user-circle.svg" style="width: 20px; margin-right: 5px;">
          <span id="username">ç”¨æˆ·</span>
        </a>
        <dl class="layui-nav-child">
          <dd><a href="profile.html">ä¸ªäººè®¾ç½®</a></dd>
          <dd><a href="javascript:;" onclick="logout()">é€€å‡ºç™»å½•</a></dd>
        </dl>
      </li>
    </div>
  </div>

  <div class="page-container">
    <!-- é¡¶éƒ¨æ“ä½œæŒ‰é’® -->
    <div class="top-actions">
      <button class="layui-btn layui-btn-normal" onclick="window.location.href='tmall-hot-slow-analysis.html'">
        <i class="layui-icon layui-icon-chart"></i> å¤©çŒ«æ•°æ®åˆ†æ
      </button>
      <button class="layui-btn layui-btn-primary" onclick="refreshAllData()">
        <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°æ•°æ®
      </button>
      <button class="layui-btn layui-btn-primary" onclick="exportAnalysisReport()">
        <i class="layui-icon layui-icon-download-circle"></i> å¯¼å‡ºæŠ¥å‘Š
      </button>
    </div>

    <!-- åˆ†ææ§åˆ¶é¢æ¿ -->
    <div class="analysis-controls">
      <form class="layui-form" lay-filter="analysisFilter">
        <div class="layui-form-item">
          <div class="layui-inline">
            <label class="layui-form-label">åˆ†æèŒƒå›´</label>
            <div class="layui-input-inline">
              <select name="timeRange" lay-filter="timeRange">
                <option value="7">æœ€è¿‘7å¤©</option>
                <option value="15">æœ€è¿‘15å¤©</option>
                <option value="30" selected>æœ€è¿‘30å¤©</option>
                <option value="90">æœ€è¿‘3ä¸ªæœˆ</option>
                <option value="180">æœ€è¿‘åŠå¹´</option>
                <option value="365">æœ€è¿‘1å¹´</option>
                <option value="0">å…¨éƒ¨æ•°æ®</option>
              </select>
            </div>
          </div>
          <div class="layui-inline">
            <label class="layui-form-label">æ˜¾ç¤ºæ•°é‡</label>
            <div class="layui-input-inline">
              <select name="limit">
                <option value="10">å‰10å</option>
                <option value="20" selected>å‰20å</option>
                <option value="50">å‰50å</option>
              </select>
            </div>
          </div>
          <div class="layui-inline">
            <button type="submit" class="layui-btn" lay-submit lay-filter="updateAnalysis">
              <i class="layui-icon layui-icon-search"></i> æ›´æ–°åˆ†æ
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- åŸºç¡€æ•°æ®ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-container">
      <h2 style="margin-bottom: 20px; color: #333;">ğŸ“Š åŸºç¡€æ•°æ®æ¦‚è§ˆ</h2>
      <div class="stats-grid">
        <div class="stats-card">
          <div class="stats-value">0</div>
          <div class="stats-label">æ€»SKUæ•°</div>
          <div class="stats-trend trend-up">â†— è¾ƒæ˜¨æ—¥ +0</div>
        </div>
        <div class="stats-card">
          <div class="stats-value">0%</div>
          <div class="stats-label">åº“å­˜å¥åº·ç‡</div>
          <div class="stats-trend trend-stable">â†’ è¾ƒæ˜¨æ—¥ +0%</div>
        </div>
        <div class="stats-card">
          <div class="stats-value">0</div>
          <div class="stats-label">å¹³å‡å‘¨è½¬ç‡</div>
          <div class="stats-trend trend-up">â†— è¾ƒæ˜¨æ—¥ +0</div>
        </div>
        <div class="stats-card">
          <div class="stats-value">0</div>
          <div class="stats-label">åº“å­˜é¢„è­¦</div>
          <div class="stats-trend trend-down">â†˜ è¾ƒæ˜¨æ—¥ -0</div>
        </div>
        <div class="stats-card">
          <div class="stats-value">0</div>
          <div class="stats-label">å†å²è®°å½•</div>
          <div class="stats-trend trend-up">â†— è¾ƒæ˜¨æ—¥ +0</div>
        </div>
      </div>
    </div>

    <!-- åº“å­˜è¶‹åŠ¿å›¾è¡¨ -->
    <div class="chart-container">
      <div class="chart-header">
        <h3 class="chart-title">ğŸ“ˆ åº“å­˜è¶‹åŠ¿åˆ†æ</h3>
        <div class="chart-controls">
          <button class="layui-btn layui-btn-xs" onclick="exportChart('stock')">
            <i class="layui-icon layui-icon-download-circle"></i> å¯¼å‡º
          </button>
          <button class="layui-btn layui-btn-xs layui-btn-primary" onclick="refreshChart('stock')">
            <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°
          </button>
        </div>
      </div>
      <div class="chart-content">
        <div id="stockChart" class="chart"></div>
      </div>
    </div>

    <!-- é”€å”®è¶‹åŠ¿å›¾è¡¨ -->
    <div class="chart-container">
      <div class="chart-header">
        <h3 class="chart-title">ğŸ“ˆ é”€å”®è¶‹åŠ¿åˆ†æ</h3>
        <div class="chart-controls">
          <button class="layui-btn layui-btn-xs" onclick="exportChart('sales')">
            <i class="layui-icon layui-icon-download-circle"></i> å¯¼å‡º
          </button>
          <button class="layui-btn layui-btn-xs layui-btn-primary" onclick="refreshChart('sales')">
            <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°
          </button>
        </div>
      </div>
      <div class="chart-content">
        <div id="salesChart" class="chart"></div>
      </div>
    </div>

    <!-- çˆ†æ¬¾æ»é”€åˆ†æéƒ¨åˆ† -->
    <div style="margin: 40px 0;">
      <h2 style="margin-bottom: 20px; color: #333;">ğŸ”¥ çˆ†æ¬¾æ»é”€åˆ†æ</h2>
      
      <!-- çˆ†æ¬¾æ»é”€ç»Ÿè®¡å¡ç‰‡ -->
      <div class="hot-slow-stats">
        <div class="hot-slow-card">
          <div class="hot-slow-number" id="totalProducts">0</div>
          <div class="hot-slow-label">æ€»äº§å“æ•°</div>
        </div>
        <div class="hot-slow-card">
          <div class="hot-slow-number" id="hotProducts">0</div>
          <div class="hot-slow-label">çˆ†å“æ•°é‡</div>
        </div>
        <div class="hot-slow-card">
          <div class="hot-slow-number" id="slowProducts">0</div>
          <div class="hot-slow-label">æ»é”€å“æ•°é‡</div>
        </div>
        <div class="hot-slow-card">
          <div class="hot-slow-number" id="totalSales">0</div>
          <div class="hot-slow-label">æ€»é”€é‡</div>
        </div>
      </div>

      <!-- æ¯æ—¥æ€»é”€é‡è¶‹åŠ¿ -->
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ“Š æ¯æ—¥æ€»é”€é‡è¶‹åŠ¿</h3>
        </div>
        <div class="chart-content">
          <div id="dailyTotalSalesChart" class="chart"></div>
        </div>
      </div>

      <!-- é”€é‡è¶‹åŠ¿åˆ†æ -->
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ“ˆ é”€é‡è¶‹åŠ¿åˆ†æ</h3>
        </div>
        <div class="chart-content">
          <div id="salesTrendChart" class="chart"></div>
        </div>
      </div>

      <!-- çˆ†å“é”€é‡æ’è¡Œ -->
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ”¥ çˆ†å“é”€é‡æ’è¡Œ</h3>
        </div>
        <div class="chart-content">
          <div id="hotProductsChart" class="chart"></div>
        </div>
      </div>

      <!-- çˆ†å“åˆ†çº§åˆ†æ -->
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ”¥ çˆ†å“åˆ†çº§åˆ†æ</h3>
        </div>
        <div class="chart-content">
          <div id="hotLevelChartsContainer"></div>
        </div>
      </div>

      <!-- æ»é”€å“åˆ†æ -->
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ“‰ æ»é”€å“åˆ†æ</h3>
        </div>
        <div class="chart-content">
          <div id="slowProductsChart" class="chart"></div>
        </div>
      </div>

      <!-- äº§å“è¯¦ç»†åˆ†æ -->
      <div class="product-list">
        <h3>ğŸ“‹ äº§å“è¯¦ç»†åˆ†æ</h3>
        <table class="layui-table" id="productTable">
          <thead>
            <tr>
              <th>æ’å</th>
              <th>äº§å“åç§°</th>
              <th>SKU</th>
              <th>æ€»é”€é‡</th>
              <th>å½“å‰åº“å­˜</th>
              <th>å¹³å‡æ—¥é”€é‡</th>
              <th>ç½‘å€</th>
            </tr>
          </thead>
          <tbody>
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- SKUè¯¦ç»†åˆ†æè¡¨æ ¼ -->
    <div class="table-container">
      <div class="table-header">
        <h3>ğŸ” SKUè¯¦ç»†åˆ†æ</h3>
        <p>æ˜¾ç¤ºåº“å­˜å’Œé”€å”®è¡¨ç°æœ€çªå‡ºçš„äº§å“</p>
        <div class="table-controls">
          <span>æ¯é¡µæ˜¾ç¤ºï¼š</span>
          <select id="skuPageSize" onchange="changePageSize()">
            <option value="10">10æ¡</option>
            <option value="20" selected>20æ¡</option>
            <option value="50">50æ¡</option>
            <option value="100">100æ¡</option>
          </select>
          <span style="margin-left: 20px;">å…± <span id="totalCount">0</span> æ¡æ•°æ®</span>
        </div>
      </div>
      <div style="overflow-x: auto; padding: 20px;">
        <table class="analysis-table">
          <thead>
            <tr>
              <th>æ’å</th>
              <th>SKUç¼–ç </th>
              <th>äº§å“åç§°</th>
              <th>å½“å‰åº“å­˜</th>
              <th>æ€»é”€é‡</th>
              <th>æœ€åæ›´æ–°</th>
              <th>åº“å­˜çŠ¶æ€</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="skuTableBody">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>
      <div class="pagination-container">
        <div class="pagination-info">
          æ˜¾ç¤ºç¬¬ <span id="currentStart">0</span>-<span id="currentEnd">0</span> æ¡ï¼Œå…± <span id="totalCountBottom">0</span> æ¡
        </div>
        <div class="pagination-controls">
          <button class="layui-btn layui-btn-sm" onclick="goToPage(1)" id="firstPageBtn">é¦–é¡µ</button>
          <button class="layui-btn layui-btn-sm" onclick="goToPrevPage()" id="prevPageBtn">ä¸Šä¸€é¡µ</button>
          <span style="margin: 0 10px;">ç¬¬ <span id="currentPageNum">1</span> é¡µï¼Œå…± <span id="totalPages">1</span> é¡µ</span>
          <button class="layui-btn layui-btn-sm" onclick="goToNextPage()" id="nextPageBtn">ä¸‹ä¸€é¡µ</button>
          <button class="layui-btn layui-btn-sm" onclick="goToLastPage()" id="lastPageBtn">æœ«é¡µ</button>
          <span style="margin-left: 20px;">è·³è½¬åˆ°ï¼š</span>
          <input type="number" id="jumpPageInput" style="width: 60px; text-align: center;" min="1">
          <button class="layui-btn layui-btn-sm layui-btn-primary" onclick="jumpToPage()">è·³è½¬</button>
        </div>
      </div>
    </div>

    <!-- ä¸Šä¸‹æ¶ç®¡ç†åŒºåŸŸï¼ˆéšè—ï¼Œä¿ç•™ä»£ç ï¼‰ -->
    <div class="listing-management-container">
      <div class="table-header">
        <h3>ğŸ“‹ å•†å“ä¸Šä¸‹æ¶ç®¡ç†</h3>
        <p>åŸºäºåº“å­˜çŠ¶æ€çš„æ™ºèƒ½ä¸Šä¸‹æ¶å»ºè®®</p>
        <div class="section-controls">
          <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="loadListingCandidates()">
            <i class="layui-icon layui-icon-upload"></i> æŸ¥çœ‹å¾…ä¸Šæ¶
          </button>
          <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="loadDelistingCandidates()">
            <i class="layui-icon layui-icon-download"></i> æŸ¥çœ‹å¾…ä¸‹æ¶
          </button>
        </div>
      </div>
      
      <!-- å¾…ä¸Šæ¶å•†å“åˆ—è¡¨ -->
      <div id="listingSection" class="listing-section" style="display: none;">
        <div class="section-header">
          <h4 style="color: #52c41a;">ğŸ“ˆ å»ºè®®ä¸Šæ¶å•†å“ï¼ˆåº“å­˜ > 10ï¼‰</h4>
          <div class="section-controls">
            <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="selectAllListing()">å…¨é€‰</button>
            <button class="layui-btn layui-btn-sm" onclick="clearListingSelection()">å–æ¶ˆå…¨é€‰</button>
            <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="confirmListing()">ç¡®è®¤ä¸Šæ¶</button>
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table class="listing-table">
            <thead>
              <tr>
                <th width="60"><input type="checkbox" id="listingSelectAll" onchange="toggleAllListing(this)"></th>
                <th>SKUç¼–ç </th>
                <th>äº§å“åç§°</th>
                <th>å½“å‰åº“å­˜</th>
                <th>æœ€è¿‘é”€é‡</th>
                <th>ä¸‹æ¶æ—¶é—´</th>
                <th>ç½‘é¡µé“¾æ¥</th>
              </tr>
            </thead>
            <tbody id="listingTableBody">
              <!-- åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- å¾…ä¸‹æ¶å•†å“åˆ—è¡¨ -->
      <div id="delistingSection" class="listing-section" style="display: none;">
        <div class="section-header">
          <h4 style="color: #f5222d;">ğŸ“‰ å»ºè®®ä¸‹æ¶å•†å“ï¼ˆåº“å­˜ = 0ï¼‰</h4>
          <div class="section-controls">
            <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="selectAllDelisting()">å…¨é€‰</button>
            <button class="layui-btn layui-btn-sm" onclick="clearDelistingSelection()">å–æ¶ˆå…¨é€‰</button>
            <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="confirmDelisting()">ç¡®è®¤ä¸‹æ¶</button>
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table class="listing-table">
            <thead>
              <tr>
                <th width="60"><input type="checkbox" id="delistingSelectAll" onchange="toggleAllDelisting(this)"></th>
                <th>SKUç¼–ç </th>
                <th>äº§å“åç§°</th>
                <th>å½“å‰åº“å­˜</th>
                <th>æœ€è¿‘é”€é‡</th>
                <th>ç¼ºè´§å¤©æ•°</th>
                <th>ç½‘é¡µé“¾æ¥</th>
              </tr>
            </thead>
            <tbody id="delistingTableBody">
              <!-- åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="./src/layui.js"></script>
  <script>
    layui.use(['form', 'layer'], function(){
      var form = layui.form;
      var layer = layui.layer;
      
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      checkLoginStatus();
      
      // åˆå§‹åŒ–é¡µé¢
      initCharts();
      loadAnalysisData();
      
      // çˆ†æ¬¾æ»é”€åˆ†æå˜é‡
      var allWideData = [];
      var allRecordData = [];
      var currentTimeRange = 30;
      var currentLimit = 20;
      
      // å›¾è¡¨å®ä¾‹
      var stockChartInstance = null;
      var salesChartInstance = null;
      var dailyTotalSalesChart = null;
      var salesTrendChart = null;
      var hotProductsChart = null;
      var slowProductsChart = null;
      
      // SKUè¡¨æ ¼ç¿»é¡µå˜é‡
      let skuTableData = [];
      let currentPage = 1;
      let pageSize = 20;
      
      // è¡¨å•æäº¤äº‹ä»¶
      form.on('submit(updateAnalysis)', function(data){
        currentTimeRange = parseInt(data.field.timeRange || 30);
        currentLimit = parseInt(data.field.limit || 20);
        loadHotSlowAnalysisData();
        return false;
      });
      
      // åˆå§‹åŒ–å›¾è¡¨
      function initCharts() {
        window.stockChartInstance = echarts.init(document.getElementById('stockChart'));
        window.salesChartInstance = echarts.init(document.getElementById('salesChart'));
      }
      
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      function checkLoginStatus() {
        const token = localStorage.getItem('token');
        const userInfo = localStorage.getItem('userInfo');
        
        // ä¸å¼ºåˆ¶è¦æ±‚ç™»å½•ï¼Œä½†å¦‚æœæœ‰ç”¨æˆ·ä¿¡æ¯å°±æ˜¾ç¤º
        if (userInfo) {
          try {
            const user = JSON.parse(userInfo);
            document.getElementById('username').textContent = user.username || 'ç”¨æˆ·';
          } catch (e) {
            console.warn('ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥:', e);
            document.getElementById('username').textContent = 'ç”¨æˆ·';
          }
        } else {
          document.getElementById('username').textContent = 'ç”¨æˆ·';
        }
      }
      
      // é€€å‡ºç™»å½•
      window.logout = function() {
        layer.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', function(index){
          localStorage.removeItem('token');
          localStorage.removeItem('userInfo');
          layer.close(index);
          window.location.href = 'login.html';
        });
      };
      
      // åŠ è½½åŸºç¡€åˆ†ææ•°æ®
      function loadAnalysisData() {
        const token = localStorage.getItem('token');
        if (!token) return;
        
        // åŠ è½½é”€å”®åˆ†æ
        fetch(window.apiConfig.baseURL + '/api/analytics/sales', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateStatsCards(data.data);
          }
        })
        .catch(error => {
          console.error('åŠ è½½é”€å”®åˆ†æå¤±è´¥:', error);
        });
        
        // åŠ è½½åº“å­˜è¶‹åŠ¿
        fetch(window.apiConfig.baseURL + '/api/analytics/trends', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderStockChart(data.data);
          }
        })
        .catch(error => {
          console.error('åŠ è½½åº“å­˜è¶‹åŠ¿å¤±è´¥:', error);
        });
        
        // åŠ è½½é”€å”®è¶‹åŠ¿
        fetch(window.apiConfig.baseURL + '/api/inventory/data', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderSalesChart(data.data);
          }
        })
        .catch(error => {
          console.error('åŠ è½½é”€å”®è¶‹åŠ¿å¤±è´¥:', error);
        });
        
        // åŠ è½½SKUè¯¦ç»†åˆ†æ
        fetch(window.apiConfig.baseURL + '/api/inventory/summary', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderSkuTable(data.data);
          }
        })
        .catch(error => {
          console.error('åŠ è½½SKUåˆ†æå¤±è´¥:', error);
        });
        
        // åŠ è½½çˆ†æ¬¾æ»é”€åˆ†ææ•°æ®
        loadHotSlowAnalysisData();
      }
      
      // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
      function updateStatsCards(data) {
        const cards = document.querySelectorAll('.stats-card');
        if (cards.length >= 5) {
          // æ€»SKUæ•°
          cards[0].querySelector('.stats-value').textContent = data.totalSku || 0;
          // åº“å­˜å¥åº·ç‡
          cards[1].querySelector('.stats-value').textContent = (data.healthRate || 0) + '%';
          // å¹³å‡å‘¨è½¬ç‡
          cards[2].querySelector('.stats-value').textContent = data.avgTurnover || 0;
          // åº“å­˜é¢„è­¦
          cards[3].querySelector('.stats-value').textContent = data.warningCount || 0;
          // åº“å­˜ä»·å€¼ï¼ˆç§»é™¤é‡‘é¢æ˜¾ç¤ºï¼Œæ”¹ä¸ºè®°å½•æ€»æ•°ï¼‰
          cards[4].querySelector('.stats-value').textContent = data.totalRecords || 0;
          cards[4].querySelector('.stats-label').textContent = 'å†å²è®°å½•';
        }
      }
      
      // æ¸²æŸ“åº“å­˜è¶‹åŠ¿å›¾è¡¨
      function renderStockChart(data) {
        const stockOption = {
          title: {
            text: 'åº“å­˜è¶‹åŠ¿å˜åŒ–',
            left: 'center',
            textStyle: { fontSize: 16, color: '#333' }
          },
          tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255,255,255,0.9)',
            borderColor: '#ddd',
            textStyle: { color: '#333' }
          },
          legend: {
            data: ['æ€»åº“å­˜', 'æ­£å¸¸åº“å­˜', 'é¢„è­¦åº“å­˜', 'ç¼ºè´§SKU'],
            bottom: 10
          },
          grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
          },
          xAxis: {
            type: 'category',
            boundaryGap: false,
            data: data.dates || []
          },
          yAxis: {
            type: 'value',
            name: 'æ•°é‡'
          },
          series: [
            {
              name: 'æ€»åº“å­˜',
              type: 'line',
              data: data.series.total || [],
              itemStyle: { color: '#16baaa' },
              smooth: true
            },
            {
              name: 'æ­£å¸¸åº“å­˜',
              type: 'line',
              data: data.series.healthy || [],
              itemStyle: { color: '#52c41a' },
              smooth: true
            },
            {
              name: 'é¢„è­¦åº“å­˜',
              type: 'line',
              data: data.series.warning || [],
              itemStyle: { color: '#fa8c16' },
              smooth: true
            },
            {
              name: 'ç¼ºè´§SKU',
              type: 'line',
              data: data.series.outOfStock || [],
              itemStyle: { color: '#f5222d' },
              smooth: true
            }
          ]
        };
        window.stockChartInstance.setOption(stockOption);
      }
      
      // æ¸²æŸ“é”€å”®è¶‹åŠ¿å›¾è¡¨
      function renderSalesChart(data) {
        const salesOption = {
          title: {
            text: 'é”€å”®è¶‹åŠ¿åˆ†æ',
            left: 'center',
            textStyle: { fontSize: 16, color: '#333' }
          },
          tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255,255,255,0.9)',
            borderColor: '#ddd',
            textStyle: { color: '#333' }
          },
          legend: {
            data: ['æ—¥é”€é‡', 'å‘¨å¹³å‡', 'æœˆç´¯è®¡'],
            bottom: 10
          },
          grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
          },
          xAxis: {
            type: 'category',
            boundaryGap: false,
            data: data.dates || []
          },
          yAxis: {
            type: 'value',
            name: 'é”€é‡'
          },
          series: [
            {
              name: 'æ—¥é”€é‡',
              type: 'bar',
              data: data.series.daily || [],
              itemStyle: { color: '#1890ff' }
            },
            {
              name: 'å‘¨å¹³å‡',
              type: 'line',
              data: data.series.weekly || [],
              itemStyle: { color: '#52c41a' },
              smooth: true
            },
            {
              name: 'æœˆç´¯è®¡',
              type: 'line',
              data: data.series.monthly || [],
              itemStyle: { color: '#fa8c16' },
              smooth: true
            }
          ]
        };
        window.salesChartInstance.setOption(salesOption);
      }
      
      // æ¸²æŸ“SKUåˆ†æè¡¨æ ¼
      function renderSkuTable(data) {
        skuTableData = data || [];
        currentPage = 1;
        updateSkuTableDisplay();
      }
      
      // æ›´æ–°SKUè¡¨æ ¼æ˜¾ç¤º
      function updateSkuTableDisplay() {
        const tbody = document.getElementById('skuTableBody');
        if (!tbody) return;
        
        const totalCount = skuTableData.length;
        const totalPages = Math.ceil(totalCount / pageSize);
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalCount);
        const currentPageData = skuTableData.slice(startIndex, endIndex);
        
        // æ›´æ–°è¡¨æ ¼å†…å®¹
        tbody.innerHTML = currentPageData.map((item, index) => {
          const globalIndex = startIndex + index + 1;
          const statusColor = getStockStatusColor(item.currentStock);
          const statusText = getStockStatusText(item.currentStock);
          
          return `
            <tr>
              <td>${globalIndex}</td>
              <td class="sku-cell">${item.sku}</td>
              <td>${item.productName || 'æœªçŸ¥äº§å“'}</td>
              <td><span style="color: ${statusColor}; font-weight: bold;">${item.currentStock}</span></td>
              <td>${item.totalSales || 0}</td>
              <td>${item.lastUpdate || 'æœªçŸ¥'}</td>
              <td><span style="color: ${statusColor};">${statusText}</span></td>
              <td>
                ${item.url ? `<a href="${item.url}" target="_blank" style="color: #16baaa;">æŸ¥çœ‹å•†å“</a>` : 'æ— é“¾æ¥'}
              </td>
            </tr>
          `;
        }).join('');
        
        // æ›´æ–°ç¿»é¡µä¿¡æ¯
        updatePaginationInfo(totalCount, totalPages, startIndex + 1, endIndex);
      }
      
      // æ›´æ–°ç¿»é¡µä¿¡æ¯æ˜¾ç¤º
      function updatePaginationInfo(totalCount, totalPages, startIndex, endIndex) {
        document.getElementById('totalCount').textContent = totalCount;
        document.getElementById('totalCountBottom').textContent = totalCount;
        document.getElementById('currentStart').textContent = startIndex;
        document.getElementById('currentEnd').textContent = endIndex;
        document.getElementById('currentPageNum').textContent = currentPage;
        document.getElementById('totalPages').textContent = totalPages;
        document.getElementById('jumpPageInput').max = totalPages;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('firstPageBtn').disabled = currentPage === 1;
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
        document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
      }
      
      // è·å–åº“å­˜çŠ¶æ€é¢œè‰²
      function getStockStatusColor(stock) {
        if (stock === 0) return '#f5222d';
        if (stock < 10) return '#fa8c16';
        return '#52c41a';
      }
      
      // è·å–åº“å­˜çŠ¶æ€æ–‡æœ¬
      function getStockStatusText(stock) {
        if (stock === 0) return 'ç¼ºè´§';
        if (stock < 10) return 'é¢„è­¦';
        return 'æ­£å¸¸';
      }
      
      // ç¿»é¡µåŠŸèƒ½å‡½æ•°
      window.changePageSize = function() {
        pageSize = parseInt(document.getElementById('skuPageSize').value);
        currentPage = 1;
        updateSkuTableDisplay();
      };
      
      window.goToPage = function(page) {
        const totalPages = Math.ceil(skuTableData.length / pageSize);
        if (page >= 1 && page <= totalPages) {
          currentPage = page;
          updateSkuTableDisplay();
        }
      };
      
      window.goToPrevPage = function() {
        if (currentPage > 1) {
          currentPage--;
          updateSkuTableDisplay();
        }
      };
      
      window.goToNextPage = function() {
        const totalPages = Math.ceil(skuTableData.length / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          updateSkuTableDisplay();
        }
      };
      
      window.goToLastPage = function() {
        const totalPages = Math.ceil(skuTableData.length / pageSize);
        currentPage = totalPages;
        updateSkuTableDisplay();
      };
      
      window.jumpToPage = function() {
        const targetPage = parseInt(document.getElementById('jumpPageInput').value);
        const totalPages = Math.ceil(skuTableData.length / pageSize);
        if (targetPage >= 1 && targetPage <= totalPages) {
          currentPage = targetPage;
          updateSkuTableDisplay();
          document.getElementById('jumpPageInput').value = '';
        } else {
          layer.msg('é¡µç è¶…å‡ºèŒƒå›´ï¼', {icon: 2});
        }
      };
      
      // çˆ†æ¬¾æ»é”€åˆ†ææ•°æ®åŠ è½½
      function loadHotSlowAnalysisData() {
        layer.msg('æ­£åœ¨åŠ è½½æœ¬åœ°å®½è¡¨å’Œæ˜ç»†æ•°æ®...', {icon: 16, time: 1000});
        var token = localStorage.getItem('token');
        var headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        
        $.when(
          $.ajax({url: window.apiConfig.baseURL + '/api/localdb/wide', headers: headers}),
          $.ajax({url: window.apiConfig.baseURL + '/api/localdb/records', headers: headers})
        ).done(function(wideRes, recordRes) {
          allWideData = wideRes[0].data || [];
          allRecordData = recordRes[0].data || [];
          processHotSlowData();
        }).fail(function() {
          layer.msg('æ•°æ®åŠ è½½å¤±è´¥', {icon:2});
        });
      }
      
      function processHotSlowData() {
        // 1. è¿‡æ»¤æ—¶é—´èŒƒå›´
        var now = new Date();
        var startDate = new Date(now);
        if (currentTimeRange > 0) {
          startDate.setDate(now.getDate() - currentTimeRange + 1);
        } else {
          // å…¨éƒ¨æ•°æ®ï¼šè®¾ç½®ä¸ºå¾ˆæ—©çš„æ—¥æœŸ
          startDate = new Date('2020-01-01');
        }
        // 2. èšåˆå®½è¡¨æ¯æ—¥é”€é‡
        var dateMap = {};
        var skuMap = {};
        allWideData.forEach(row => {
          var sku = row['SKU'];
          var name = row['äº§å“ä¸­æ–‡å'] || row['äº§å“åç§°'] || '';
          if (!sku) return;
          
          // æå–æ‰€æœ‰æ—¥æœŸåˆ—çš„é”€é‡æ•°æ®
          for (var key in row) {
            if (key.includes('é”€é‡') || key.includes('2024') || key.includes('2023')) {
              var sales = parseInt(row[key]) || 0;
              if (sales > 0) {
                var dateStr = extractDateFromKey(key);
                if (dateStr && new Date(dateStr) >= startDate) {
                  if (!dateMap[dateStr]) dateMap[dateStr] = 0;
                  dateMap[dateStr] += sales;
                  
                  if (!skuMap[sku]) {
                    skuMap[sku] = {
                      sku: sku,
                      name: name,
                      url: row['ç½‘é¡µé“¾æ¥'] || '',
                      totalSales: 0,
                      currentStock: parseInt(row['åº“å­˜']) || 0
                    };
                  }
                  skuMap[sku].totalSales += sales;
                }
              }
            }
          }
        });
        
        // 3. å¤„ç†å†å²è®°å½•
        allRecordData.forEach(record => {
          var sku = record['SKU'];
          var sales = parseInt(record['é”€é‡']) || 0;
          var dateStr = record['æ—¥æœŸ'];
          
          if (sales > 0 && dateStr && new Date(dateStr) >= startDate) {
            if (!dateMap[dateStr]) dateMap[dateStr] = 0;
            dateMap[dateStr] += sales;
            
            if (!skuMap[sku]) {
              skuMap[sku] = {
                sku: sku,
                name: record['äº§å“ä¸­æ–‡å'] || '',
                url: record['ç½‘é¡µé“¾æ¥'] || '',
                totalSales: 0,
                currentStock: parseInt(record['åº“å­˜']) || 0
              };
            }
            skuMap[sku].totalSales += sales;
          }
        });
        
        // 4. è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
        var skuArr = Object.values(skuMap).sort((a, b) => b.totalSales - a.totalSales);
        var dateArr = Object.keys(dateMap).sort().map(date => ({
          date: date,
          sales: dateMap[date]
        }));
        
        // 5. åˆ†ç±»çˆ†å“å’Œæ»é”€å“
        var hotArr = skuArr.filter(item => item.totalSales >= 5);
        var slowArr = skuArr.filter(item => item.totalSales === 0 && item.currentStock > 0);
        
        // 6. æ›´æ–°ç»Ÿè®¡
        $('#totalProducts').text(skuArr.length);
        $('#hotProducts').text(hotArr.length);
        $('#slowProducts').text(slowArr.length);
        $('#totalSales').text(skuArr.reduce((sum, item) => sum + item.totalSales, 0));
        
        // 7. ç”Ÿæˆå›¾è¡¨
        generateDailyTotalSalesChart(dateArr);
        generateSalesTrendChart(skuArr, currentTimeRange);
        generateHotProductsChart(skuArr);
        generateHotLevelCharts(skuArr);
        generateSlowProductsChart(slowArr);
        generateProductTableWithPagination(skuArr);
        
        layer.msg('çˆ†å“æ»é”€å“åˆ†æå®Œæˆï¼', {icon: 1});
      }
      
      // æå–æ—¥æœŸå­—ç¬¦ä¸²
      function extractDateFromKey(key) {
        var match = key.match(/(\d{4}-\d{2}-\d{2})/);
        return match ? match[1] : null;
      }
      
      // ç”Ÿæˆæ¯æ—¥æ€»é”€é‡è¶‹åŠ¿å›¾
      function generateDailyTotalSalesChart(data) {
        const chartDom = document.getElementById('dailyTotalSalesChart');
        if (dailyTotalSalesChart) {
          dailyTotalSalesChart.dispose();
        }
        dailyTotalSalesChart = echarts.init(chartDom);
        
        const option = {
          title: {
            text: 'æ¯æ—¥æ€»é”€é‡è¶‹åŠ¿',
            left: 'center'
          },
          tooltip: {
            trigger: 'axis'
          },
          xAxis: {
            type: 'category',
            data: data.map(item => item.date)
          },
          yAxis: {
            type: 'value'
          },
          series: [{
            data: data.map(item => item.sales),
            type: 'line',
            smooth: true,
            itemStyle: {
              color: '#1E9FFF'
            }
          }]
        };
        dailyTotalSalesChart.setOption(option);
      }
      
      // ç”Ÿæˆé”€é‡è¶‹åŠ¿å›¾
      function generateSalesTrendChart(data, timeRange) {
        const chartDom = document.getElementById('salesTrendChart');
        if (salesTrendChart) {
          salesTrendChart.dispose();
        }
        salesTrendChart = echarts.init(chartDom);
        
        // æŒ‰é”€é‡æ’åºï¼Œå–å‰10å
        const topProducts = data.slice(0, 10);
        
        const option = {
          title: {
            text: 'é”€é‡è¶‹åŠ¿åˆ†æ',
            left: 'center'
          },
          tooltip: {
            trigger: 'axis'
          },
          legend: {
            data: ['æ€»é”€é‡', 'æ—¥å‡é”€é‡'],
            bottom: 10
          },
          xAxis: {
            type: 'category',
            data: topProducts.map(item => item.name || item.sku)
          },
          yAxis: {
            type: 'value'
          },
          series: topProducts.map((item, index) => ({
            name: item.name,
            type: 'bar',
            data: [item.totalSales, timeRange > 0 ? Math.round(item.totalSales / timeRange * 10) / 10 : Math.round(item.totalSales / 30 * 10) / 10],
            itemStyle: {
              color: index < 3 ? '#FF5722' : '#1E9FFF'
            }
          }))
        };
        
        salesTrendChart.setOption(option);
      }
      
      // ç”Ÿæˆçˆ†å“å›¾è¡¨
      function generateHotProductsChart(data) {
        const chartDom = document.getElementById('hotProductsChart');
        if (hotProductsChart) {
          hotProductsChart.dispose();
        }
        hotProductsChart = echarts.init(chartDom);
        
        const hotProducts = data.filter(item => item.totalSales >= 5).slice(0, currentLimit);
        
        const option = {
          title: {
            text: 'çˆ†å“é”€é‡æ’è¡Œ',
            left: 'center'
          },
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'shadow'
            }
          },
          grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
          },
          xAxis: {
            type: 'value',
            boundaryGap: [0, 0.01]
          },
          yAxis: {
            type: 'category',
            data: hotProducts.map(item => item.name || item.sku)
          },
          series: [{
            name: 'é”€é‡',
            type: 'bar',
            data: hotProducts.map(item => item.totalSales),
            itemStyle: {
              color: '#FF5722'
            }
          }]
        };
        
        hotProductsChart.setOption(option);
      }
      
      // ç”Ÿæˆçˆ†å“åˆ†çº§å›¾è¡¨
      function generateHotLevelCharts(data) {
        const container = document.getElementById('hotLevelChartsContainer');
        container.innerHTML = '';
        
        const levels = [
          { name: 'è¶…çº§çˆ†å“', min: 20, color: '#FF1744' },
          { name: 'çƒ­é”€çˆ†å“', min: 10, max: 19, color: '#FF5722' },
          { name: 'ä¸€èˆ¬çˆ†å“', min: 5, max: 9, color: '#FF9800' }
        ];
        
        levels.forEach((level, index) => {
          const chartDiv = document.createElement('div');
          chartDiv.style.height = '300px';
          chartDiv.style.marginBottom = '20px';
          container.appendChild(chartDiv);
          
          const chart = echarts.init(chartDiv);
          const levelData = data.filter(item => {
            return item.totalSales >= level.min && (!level.max || item.totalSales <= level.max);
          }).slice(0, 10);
          
          const option = {
            title: {
              text: level.name + 'ï¼ˆ' + levelData.length + 'ä¸ªï¼‰',
              left: 'center'
            },
            tooltip: {
              trigger: 'item'
            },
            series: [{
              name: level.name,
              type: 'pie',
              radius: '50%',
              data: levelData.map(item => ({
                value: item.totalSales,
                name: item.name || item.sku
              })),
              itemStyle: {
                color: level.color
              },
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
              }
            }]
          };
          
          chart.setOption(option);
        });
      }
      
      // ç”Ÿæˆæ»é”€å“å›¾è¡¨
      function generateSlowProductsChart(data) {
        const chartDom = document.getElementById('slowProductsChart');
        if (slowProductsChart) {
          slowProductsChart.dispose();
        }
        slowProductsChart = echarts.init(chartDom);
        
        const slowProducts = data.slice(0, currentLimit);
        
        const option = {
          title: {
            text: 'æ»é”€å“åº“å­˜åˆ†å¸ƒ',
            left: 'center'
          },
          tooltip: {
            trigger: 'item'
          },
          series: [{
            name: 'åº“å­˜',
            type: 'pie',
            radius: '50%',
            data: slowProducts.map(item => ({
              value: item.currentStock,
              name: item.name || item.sku
            })),
            itemStyle: {
              color: '#757575'
            },
            emphasis: {
              itemStyle: {
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
              }
            }
          }]
        };
        
        slowProductsChart.setOption(option);
      }
      
      // ç”Ÿæˆäº§å“è¯¦ç»†è¡¨æ ¼
      function generateProductTableWithPagination(data) {
        const tbody = document.querySelector('#productTable tbody');
        if (!tbody) return;
        
        const displayData = data.slice(0, currentLimit);
        tbody.innerHTML = displayData.map((item, index) => {
          const rowClass = item.totalSales >= 5 ? 'hot-product' : 
                          item.totalSales === 0 ? 'slow-product' : 'normal-product';
          
          return `
            <tr class="${rowClass}">
              <td>${index + 1}</td>
              <td class="product-name" title="${item.name || item.sku}">${item.name || item.sku}</td>
              <td>${item.sku}</td>
              <td>${item.totalSales}</td>
              <td>${item.currentStock}</td>
              <td>${(item.totalSales / currentTimeRange).toFixed(2)}</td>
              <td>
                ${item.url ? `<a href="${item.url}" target="_blank">æŸ¥çœ‹</a>` : 'æ— é“¾æ¥'}
              </td>
            </tr>
          `;
        }).join('');
      }
      
      // å·¥å…·å‡½æ•°
      window.refreshAllData = function() {
        loadAnalysisData();
      };
      
      window.exportAnalysisReport = function() {
        layer.msg('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', {icon: 16});
      };
      
      window.exportChart = function(type) {
        layer.msg(`å¯¼å‡º${type}å›¾è¡¨åŠŸèƒ½å¼€å‘ä¸­...`, {icon: 16});
      };
      
      window.refreshChart = function(type) {
        if (type === 'stock') {
          // é‡æ–°åŠ è½½åº“å­˜è¶‹åŠ¿
          const token = localStorage.getItem('token');
          fetch(window.apiConfig.baseURL + '/api/analytics/trends', {
            headers: { 'Authorization': 'Bearer ' + token }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              renderStockChart(data.data);
              layer.msg('åº“å­˜è¶‹åŠ¿å›¾å·²åˆ·æ–°', {icon: 1});
            }
          });
        } else if (type === 'sales') {
          // é‡æ–°åŠ è½½é”€å”®è¶‹åŠ¿
          const token = localStorage.getItem('token');
          fetch(window.apiConfig.baseURL + '/api/inventory/data', {
            headers: { 'Authorization': 'Bearer ' + token }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              renderSalesChart(data.data);
              layer.msg('é”€å”®è¶‹åŠ¿å›¾å·²åˆ·æ–°', {icon: 1});
            }
          });
        }
      };
      
      // ä¸Šä¸‹æ¶ç®¡ç†åŠŸèƒ½ï¼ˆä¿ç•™ä»£ç ï¼‰
      window.loadListingCandidates = function() {
        const token = localStorage.getItem('token');
        if (!token) return;
        
        fetch(window.apiConfig.baseURL + '/api/listing/candidates', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderListingTable(data.data);
            document.getElementById('listingSection').style.display = 'block';
            document.getElementById('delistingSection').style.display = 'none';
          }
        })
        .catch(error => {
          console.error('åŠ è½½ä¸Šæ¶å€™é€‰å¤±è´¥:', error);
          layer.msg('åŠ è½½ä¸Šæ¶å€™é€‰å¤±è´¥', {icon: 2});
        });
      };
      
      window.loadDelistingCandidates = function() {
        const token = localStorage.getItem('token');
        if (!token) return;
        
        fetch(window.apiConfig.baseURL + '/api/delisting/candidates', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderDelistingTable(data.data);
            document.getElementById('delistingSection').style.display = 'block';
            document.getElementById('listingSection').style.display = 'none';
          }
        })
        .catch(error => {
          console.error('åŠ è½½ä¸‹æ¶å€™é€‰å¤±è´¥:', error);
          layer.msg('åŠ è½½ä¸‹æ¶å€™é€‰å¤±è´¥', {icon: 2});
        });
      };
      
      // æ¸²æŸ“ä¸Šæ¶è¡¨æ ¼
      function renderListingTable(data) {
        const tbody = document.getElementById('listingTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = data.map(item => `
          <tr>
            <td><input type="checkbox" name="listingSku" value="${item.sku}"></td>
            <td class="sku-cell">${item.sku}</td>
            <td>${item.name || 'æœªçŸ¥å•†å“'}</td>
            <td><span style="color: #52c41a; font-weight: bold;">${item.currentStock}</span></td>
            <td>${item.totalSales || 0}</td>
            <td>${item.delistedDate || 'æœªçŸ¥'}</td>
            <td class="url-cell">
              ${item.url ? `<a href="${item.url}" target="_blank">æŸ¥çœ‹å•†å“</a>` : 'æ— é“¾æ¥'}
            </td>
          </tr>
        `).join('');
      }
      
      // æ¸²æŸ“ä¸‹æ¶è¡¨æ ¼
      function renderDelistingTable(data) {
        const tbody = document.getElementById('delistingTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = data.map(item => `
          <tr>
            <td><input type="checkbox" name="delistingSku" value="${item.sku}"></td>
            <td class="sku-cell">${item.sku}</td>
            <td>${item.name || 'æœªçŸ¥å•†å“'}</td>
            <td><span style="color: #f5222d; font-weight: bold;">${item.currentStock}</span></td>
            <td>${item.totalSales || 0}</td>
            <td>${item.outOfStockDays || 0} å¤©</td>
            <td class="url-cell">
              ${item.url ? `<a href="${item.url}" target="_blank">æŸ¥çœ‹å•†å“</a>` : 'æ— é“¾æ¥'}
            </td>
          </tr>
        `).join('');
      }
      
      // ä¸Šä¸‹æ¶ç®¡ç†å…¶ä»–åŠŸèƒ½ï¼ˆä¿ç•™ä»£ç ï¼‰
      window.toggleAllListing = function(checkbox) {
        const checkboxes = document.querySelectorAll('input[name="listingSku"]');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
      };
      
      window.selectAllListing = function() {
        document.getElementById('listingSelectAll').checked = true;
        toggleAllListing(document.getElementById('listingSelectAll'));
      };
      
      window.clearListingSelection = function() {
        document.getElementById('listingSelectAll').checked = false;
        toggleAllListing(document.getElementById('listingSelectAll'));
      };
      
      window.confirmListing = function() {
        const selectedSkus = Array.from(document.querySelectorAll('input[name="listingSku"]:checked'))
          .map(cb => cb.value);
        
        if (selectedSkus.length === 0) {
          layer.msg('è¯·é€‰æ‹©è¦ä¸Šæ¶çš„å•†å“', {icon: 2});
          return;
        }
        
        layer.confirm(`ç¡®å®šè¦ä¸Šæ¶é€‰ä¸­çš„ ${selectedSkus.length} ä¸ªå•†å“å—ï¼Ÿ`, function(index){
          const token = localStorage.getItem('token');
          fetch(window.apiConfig.baseURL + '/api/listing/confirm', {
            method: 'POST',
            headers: { 
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ skus: selectedSkus })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              layer.msg('ä¸Šæ¶æ“ä½œå®Œæˆ', {icon: 1});
              loadListingCandidates(); // åˆ·æ–°åˆ—è¡¨
              loadAnalysisData(); // åˆ·æ–°åˆ†ææ•°æ®
            } else {
              layer.msg('ä¸Šæ¶æ“ä½œå¤±è´¥', {icon: 2});
            }
          })
          .catch(error => {
            console.error('ä¸Šæ¶æ“ä½œå¤±è´¥:', error);
            layer.msg('ä¸Šæ¶æ“ä½œå¤±è´¥', {icon: 2});
          });
          
          layer.close(index);
        });
      };
      
      // ç±»ä¼¼çš„ä¸‹æ¶åŠŸèƒ½...
      window.toggleAllDelisting = function(checkbox) {
        const checkboxes = document.querySelectorAll('input[name="delistingSku"]');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
      };
      
      window.selectAllDelisting = function() {
        document.getElementById('delistingSelectAll').checked = true;
        toggleAllDelisting(document.getElementById('delistingSelectAll'));
      };
      
      window.clearDelistingSelection = function() {
        document.getElementById('delistingSelectAll').checked = false;
        toggleAllDelisting(document.getElementById('delistingSelectAll'));
      };
      
      window.confirmDelisting = function() {
        const selectedSkus = Array.from(document.querySelectorAll('input[name="delistingSku"]:checked'))
          .map(cb => cb.value);
        
        if (selectedSkus.length === 0) {
          layer.msg('è¯·é€‰æ‹©è¦ä¸‹æ¶çš„å•†å“', {icon: 2});
          return;
        }
        
        layer.confirm(`ç¡®å®šè¦ä¸‹æ¶é€‰ä¸­çš„ ${selectedSkus.length} ä¸ªå•†å“å—ï¼Ÿ`, function(index){
          const token = localStorage.getItem('token');
          fetch(window.apiConfig.baseURL + '/api/delisting/confirm', {
            method: 'POST',
            headers: { 
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ skus: selectedSkus })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              layer.msg('ä¸‹æ¶æ“ä½œå®Œæˆ', {icon: 1});
              loadDelistingCandidates(); // åˆ·æ–°åˆ—è¡¨
              loadAnalysisData(); // åˆ·æ–°åˆ†ææ•°æ®
            } else {
              layer.msg('ä¸‹æ¶æ“ä½œå¤±è´¥', {icon: 2});
            }
          })
          .catch(error => {
            console.error('ä¸‹æ¶æ“ä½œå¤±è´¥:', error);
            layer.msg('ä¸‹æ¶æ“ä½œå¤±è´¥', {icon: 2});
          });
          
          layer.close(index);
        });
      };
    });
  </script>
</body>
</html>
