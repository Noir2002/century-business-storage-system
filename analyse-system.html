<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataInsight V2 - 跨境电商分析看板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .chart-container { height: 400px; width: 100%; }
        .card { @apply bg-white rounded-xl shadow-sm p-5 border border-slate-200 transition-all duration-300 hover:shadow-md; }
        .upload-area { border: 2px dashed #cbd5e1; }
        .upload-area:hover { border-color: #3b82f6; background-color: #eff6ff; }
        
        /* 粒度按钮样式 */
        .grain-btn { @apply px-3 py-1 text-xs font-medium rounded-md border transition-colors; }
        .grain-btn.active { @apply bg-blue-600 text-white border-blue-600; }
        .grain-btn.inactive { @apply bg-white text-gray-600 border-gray-300 hover:bg-gray-50; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen pb-10">
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center mr-2">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-slate-800">DataInsight <span class="text-blue-600">Pro</span></span>
                </div>
                <div class="flex items-center space-x-4">
                    <div v-if="rawData.length > 0" class="text-sm text-gray-600">
                        已分析 <span class="font-bold text-blue-600">{{ filteredData.length }}</span> / {{ rawData.length }} 条订单
                    </div>
                    <button @click="resetData" v-if="rawData.length > 0" class="text-sm text-red-500 hover:text-red-700 font-medium flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        清空数据
                    </button>
                    <button class="hidden md:inline-flex text-sm text-slate-500 hover:text-slate-700" onclick="window.location.href='index.html'">
                        返回首页
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        
        <!-- 上传引导区域 -->
        <div v-if="rawData.length === 0" class="flex flex-col items-center justify-center h-[500px] card upload-area cursor-pointer bg-slate-50" @drop.prevent="handleDrop" @dragover.prevent @click="$refs.fileInput.click()">
            <input type="file" ref="fileInput" class="hidden" accept=".xlsx, .xls" @change="handleFileUpload">
            <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-6">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-semibold text-slate-700">导入 Excel 数据源</h3>
            <p class="text-slate-500 mt-2">支持 .xlsx / .xls 格式，本地解析不上传服务器</p>
            <div class="mt-8 text-sm text-slate-400 bg-white border border-slate-200 p-4 rounded-lg shadow-sm">
                <p class="font-bold text-slate-600 mb-2">必需表头 (Excel 第一行):</p>
                <div class="flex flex-wrap gap-2">
                    <span class="px-2 py-1 bg-slate-100 rounded text-xs border">店铺订单时间</span>
                    <span class="px-2 py-1 bg-slate-100 rounded text-xs border">SKU</span>
                    <span class="px-2 py-1 bg-slate-100 rounded text-xs border">尺码</span>
                    <span class="px-2 py-1 bg-slate-100 rounded text-xs border">商品名称</span>
                    <span class="px-2 py-1 bg-slate-100 rounded text-xs border">品牌名称</span>
                    <span class="px-2 py-1 bg-slate-100 rounded text-xs border">商品数量</span>
                    <span class="px-2 py-1 bg-slate-100 rounded text-xs border">订单金额</span>
                </div>
            </div>
        </div>

        <!-- 看板主体 -->
        <div v-else>
            
            <!-- 筛选器 -->
            <div class="card mb-6 bg-white border-blue-100">
                <div class="flex items-center mb-3">
                    <svg class="w-4 h-4 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    <span class="text-sm font-bold text-slate-700">多维筛选器</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4">
                    <div class="lg:col-span-2 flex space-x-2">
                        <div class="flex-1">
                            <label class="block text-xs text-slate-500 mb-1">开始日期</label>
                            <input type="date" v-model="filters.startDate" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs text-slate-500 mb-1">结束日期</label>
                            <input type="date" v-model="filters.endDate" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs text-slate-500 mb-1">品牌</label>
                        <select v-model="filters.brand" class="w-full border border-gray-300 rounded px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="ALL">全部品牌</option>
                            <option v-for="b in uniqueOptions.brands" :key="b" :value="b">{{ b }}</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs text-slate-500 mb-1">尺码</label>
                        <select v-model="filters.size" class="w-full border border-gray-300 rounded px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="ALL">全部尺码</option>
                            <option v-for="s in uniqueOptions.sizes" :key="s" :value="s">{{ s }}</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs text-slate-500 mb-1">SKU 搜索</label>
                        <input type="text" v-model="filters.sku" placeholder="输入SKU..." class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>

                    <div>
                        <label class="block text-xs text-slate-500 mb-1">品类</label>
                        <select v-model="filters.category" class="w-full border border-gray-300 rounded px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="ALL">全部品类</option>
                            <option v-for="c in uniqueOptions.categories" :key="c" :value="c">{{ c }}</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs text-slate-500 mb-1">性别</label>
                        <select v-model="filters.gender" class="w-full border border-gray-300 rounded px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="ALL">全部</option>
                            <option v-for="g in uniqueOptions.genders" :key="g" :value="g">{{ g }}</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- KPI 卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div class="card bg-gradient-to-br from-blue-600 to-indigo-700 text-white border-none shadow-lg">
                    <p class="text-blue-100 text-xs font-medium uppercase tracking-wider">总销售额 (GMV)</p>
                    <h2 class="text-2xl font-bold mt-1">€ {{ formatNumber(kpi.totalAmount) }}</h2>
                </div>
                <div class="card">
                    <p class="text-gray-500 text-xs font-medium uppercase tracking-wider">总订单量</p>
                    <h2 class="text-2xl font-bold text-slate-800 mt-1">{{ kpi.totalOrders }}</h2>
                </div>
                <div class="card">
                    <p class="text-gray-500 text-xs font-medium uppercase tracking-wider">销售商品总数</p>
                    <h2 class="text-2xl font-bold text-slate-800 mt-1">{{ kpi.totalItems }}</h2>
                </div>
                <div class="card">
                    <p class="text-gray-500 text-xs font-medium uppercase tracking-wider">平均客单价 (AOV)</p>
                    <h2 class="text-2xl font-bold text-slate-800 mt-1">€ {{ formatNumber(kpi.aov) }}</h2>
                </div>
                <div class="card border-l-4 border-orange-500">
                    <div class="flex justify-between items-start">
                        <p class="text-gray-500 text-xs font-medium uppercase tracking-wider">日均流速</p>
                        <span class="text-[10px] bg-orange-100 text-orange-600 px-1 rounded">件/天</span>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mt-1">{{ kpi.velocity }}</h2>
                    <p class="text-xs text-gray-400 mt-1">在 {{ kpi.days }} 天内</p>
                </div>
            </div>

            <!-- 图表区域 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="card col-span-1 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center">
                            <span class="w-1 h-5 bg-blue-600 mr-2 rounded-full"></span>销售趋势
                        </h3>
                        <div class="flex space-x-1 bg-slate-100 p-1 rounded-lg">
                            <button v-for="type in ['day', 'week', 'month']" 
                                :key="type"
                                @click="filters.timeGrain = type"
                                :class="['grain-btn', filters.timeGrain === type ? 'active' : 'inactive']">
                                {{ type === 'day' ? '按日' : (type === 'week' ? '按周' : '按月') }}
                            </button>
                        </div>
                    </div>
                    <div ref="trendChart" class="chart-container"></div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                        <span class="w-1 h-5 bg-purple-500 mr-2 rounded-full"></span>品牌销售占比
                    </h3>
                    <div ref="brandChart" class="chart-container"></div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                        <span class="w-1 h-5 bg-green-500 mr-2 rounded-full"></span>尺码销售分布
                    </h3>
                    <div ref="sizeChart" class="chart-container"></div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                        <span class="w-1 h-5 bg-pink-500 mr-2 rounded-full"></span>品类销售占比
                    </h3>
                    <div ref="categoryChart" class="chart-container"></div>
                </div>

                <div class="card col-span-1 lg:col-span-2">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                        <span class="w-1 h-5 bg-orange-500 mr-2 rounded-full"></span>TOP 10 热销商品 (按销售额)
                    </h3>
                    <div ref="topProductChart" class="chart-container" style="height: 500px;"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    const { createApp, ref, computed, watch, nextTick } = Vue;

    createApp({
        setup() {
            const rawData = ref([]);
            const filters = ref({
                brand: 'ALL',
                size: 'ALL',
                category: 'ALL',
                gender: 'ALL',
                sku: '',
                startDate: '',
                endDate: '',
                timeGrain: 'day' // day, week, month
            });

            // 图表 DOM
            const trendChart = ref(null);
            const brandChart = ref(null);
            const sizeChart = ref(null);
            const categoryChart = ref(null);
            const topProductChart = ref(null);
            
            let chartInstances = { trend: null, brand: null, size: null, category: null, topProduct: null };

            // 映射关系
            const KEY_MAP = {
                '店铺订单时间': 'date',
                'SKU': 'sku',
                '尺码': 'size',
                '商品名称': 'name',
                '品牌名称': 'brand',
                '商品数量': 'quantity',
                '订单金额': 'amount'
            };

            const handleFileUpload = (e) => processFile(e.target.files[0]);
            const handleDrop = (e) => processFile(e.dataTransfer.files[0]);

            // 根据商品标题提取品类
            const getCategoryFromName = (name) => {
                if (!name) return '其他';
                const n = String(name);
                // 先判断包
                if (n.includes('包')) return '包';
                // 配件：围巾，腰带，手套，头带，袜子
                if (n.includes('围巾') || n.toLowerCase().includes('scarf') ||
                    n.includes('腰带') || n.toLowerCase().includes('belt') ||
                    n.includes('手套') || n.toLowerCase().includes('glove') ||
                    n.includes('头带') || n.toLowerCase().includes('headband') ||
                    n.includes('袜')   || n.toLowerCase().includes('sock')) {
                    return '配件';
                }
                if (n.includes('鞋') || n.toLowerCase().includes('shoe') || n.toLowerCase().includes('sneaker')) return '鞋';
                if (n.includes('夹克') || n.toLowerCase().includes('jacket')) return '夹克';
                if (n.includes('大衣') || n.includes('外套') || n.toLowerCase().includes('coat') || n.toLowerCase().includes('parka')) return '大衣';
                if (n.includes('T恤') || n.toUpperCase().includes('TEE') || n.toLowerCase().includes('t-shirt')) return 'T恤';
                if (n.includes('背心') || n.toLowerCase().includes('tank')) return '背心';
                if (n.includes('裤')) return '裤';
                if (n.includes('连帽') || n.toLowerCase().includes('hoodie')) return '连帽衣';
                if (n.includes('衫') || n.toLowerCase().includes('shirt')) return '衫';
                return '其他';
            };

            // 根据标题推断性别：男装 / 女装 / Unisex
            const getGenderFromName = (name) => {
                if (!name) return 'Unisex';
                const n = String(name);
                const hasMen = n.includes('男') || /men/i.test(n) || /male/i.test(n);
                const hasWomen = n.includes('女') || /women/i.test(n) || /female/i.test(n);
                if ((n.includes('中性') || /unisex/i.test(n) || n.includes('男女')) && !(hasMen && !hasWomen) && !(hasWomen && !hasMen)) {
                    return 'Unisex';
                }
                if (hasMen && !hasWomen) return '男装';
                if (hasWomen && !hasMen) return '女装';
                return 'Unisex';
            };

            const processFile = (file) => {
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                        if (!jsonData.length) { alert("文件数据为空"); return; }

                        const cleanData = jsonData.map(row => {
                            let newRow = {};
                            Object.keys(row).forEach(k => {
                                const cleanKey = k.trim();
                                if (KEY_MAP[cleanKey]) newRow[KEY_MAP[cleanKey]] = row[k];
                            });

                            newRow.amount = parseFloat(newRow.amount) || 0;
                            newRow.quantity = parseInt(newRow.quantity) || 0;
                            newRow.brand = newRow.brand || 'Unknown';
                            
                            // 尺码格式化：如果是数字，则保留1位小数；如果是文本，保持原样
                            let sizeVal = newRow.size;
                            if (sizeVal !== undefined && sizeVal !== null) {
                                if (!isNaN(sizeVal) && typeof sizeVal !== 'boolean') {
                                    newRow.size = parseFloat(sizeVal).toFixed(1);
                                } else {
                                    newRow.size = String(sizeVal).trim();
                                }
                            } else {
                                newRow.size = '均码';
                            }
                            
                            // 日期标准化，统一为 yyyy-MM-dd，避免 input[type=date] 报错
                            try {
                                let d = newRow.date;
                                if (d && !isNaN(d) && !(d instanceof Date)) {
                                    // 可能是 Excel 序列号
                                    d = XLSX.SSF.parse_date_code(d);
                                }
                                if (d && (d.y || d instanceof Date)) {
                                    const dateObj = d instanceof Date ? d : new Date(d.y, d.m-1, d.d);
                                    newRow.dateObj = dateObj; // 保留对象用于后续粒度计算
                                    newRow.dateStr = dateObj.toISOString().split('T')[0]; // yyyy-MM-dd
                                } else if (typeof newRow.date === 'string') {
                                    // 直接来自字符串的日期，可能是 2025/09/16 或 2025.09.16 格式
                                    let base = newRow.date.split(' ')[0].trim();
                                    base = base.replace(/[./]/g, '-'); // 全部换成 -
                                    // 如果是 yyyy/M/d 这种，补零
                                    const parts = base.split('-');
                                    if (parts.length === 3 && parts[0].length === 4) {
                                        const m = parts[1].padStart(2, '0');
                                        const d2 = parts[2].padStart(2, '0');
                                        base = `${parts[0]}-${m}-${d2}`;
                                    }
                                    newRow.dateStr = base;
                                    newRow.dateObj = new Date(base);
                                }
                            } catch(e) { 
                                newRow.dateStr = null; 
                            }

                            // 品类与性别分类
                            newRow.category = getCategoryFromName(newRow.name);
                            newRow.gender = getGenderFromName(newRow.name);

                            return newRow;
                        }).filter(item => item.dateStr && item.amount >= 0);

                        if (!cleanData.length) { alert("未找到有效数据"); return; }
                        
                        // 按日期排序，方便后续处理
                        cleanData.sort((a, b) => a.dateStr.localeCompare(b.dateStr));

                        rawData.value = cleanData;

                        // 初始化筛选器范围（格式为 yyyy-MM-dd，适配 input[type=date]）
                        const dates = rawData.value.map(d => d.dateStr);
                        filters.value.startDate = dates[0];
                        filters.value.endDate = dates[dates.length - 1];
                        
                        nextTick(() => initCharts());

                    } catch (error) {
                        console.error(error);
                        alert("解析失败，请检查文件格式");
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            // 联动筛选逻辑
            const filteredData = computed(() => {
                return rawData.value.filter(item => {
                    const matchBrand = filters.value.brand === 'ALL' || item.brand === filters.value.brand;
                    const matchSize = filters.value.size === 'ALL' || item.size === filters.value.size;
                    const matchCategory = filters.value.category === 'ALL' || item.category === filters.value.category;
                    const matchGender = filters.value.gender === 'ALL' || item.gender === filters.value.gender;
                    const matchSku = !filters.value.sku || (item.sku && String(item.sku).toLowerCase().includes(filters.value.sku.toLowerCase()));
                    const matchDate = (!filters.value.startDate || item.dateStr >= filters.value.startDate) &&
                                      (!filters.value.endDate || item.dateStr <= filters.value.endDate);
                    return matchBrand && matchSize && matchCategory && matchGender && matchSku && matchDate;
                });
            });

            // 动态生成下拉选项
            const uniqueOptions = computed(() => {
                const brands = new Set();
                const sizes = new Set();
                const categories = new Set();
                const genders = new Set();
                rawData.value.forEach(item => {
                    if(item.brand) brands.add(item.brand);
                    if(item.size) sizes.add(item.size);
                    if(item.category) categories.add(item.category);
                    if(item.gender) genders.add(item.gender);
                });
                // 尺码自定义排序：尝试数字排序，否则字母排序
                const sortedSizes = [...sizes].sort((a, b) => {
                    const numA = parseFloat(a);
                    const numB = parseFloat(b);
                    if(!isNaN(numA) && !isNaN(numB)) return numA - numB;
                    return String(a).localeCompare(String(b));
                });

                return {
                    brands: [...brands].sort(),
                    sizes: sortedSizes,
                    categories: [...categories].sort(),
                    genders: [...genders].sort()
                };
            });

            // KPI 计算
            const kpi = computed(() => {
                const data = filteredData.value;
                const totalAmount = data.reduce((sum, item) => sum + item.amount, 0);
                const totalOrders = data.length;
                const totalItems = data.reduce((sum, item) => sum + item.quantity, 0);
                
                // 流速计算：总销量 / (结束日期 - 开始日期 + 1)
                let velocity = 0;
                let days = 1;
                if (filters.value.startDate && filters.value.endDate) {
                    const start = new Date(filters.value.startDate);
                    const end = new Date(filters.value.endDate);
                    const diffTime = Math.abs(end - start);
                    days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // 包含当天
                    velocity = days > 0 ? totalItems / days : 0;
                }

                return {
                    totalAmount: totalAmount.toFixed(2),
                    totalOrders,
                    totalItems,
                    aov: totalOrders ? (totalAmount / totalOrders).toFixed(2) : 0,
                    velocity: velocity.toFixed(1),
                    days
                };
            });

            // 辅助函数：获取日期的周/月 Key
            const getDateKey = (dateObj, grain) => {
                const y = dateObj.getFullYear();
                const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                const d = String(dateObj.getDate()).padStart(2, '0');
                
                if (grain === 'month') return `${y}-${m}`;
                if (grain === 'week') {
                    // 简单的按周一开始日期计算
                    const tmp = new Date(dateObj.getTime());
                    const day = tmp.getDay() || 7; // getDay 0 is Sunday
                    if(day !== 1) tmp.setDate(tmp.getDate() - (day - 1));
                    return `${tmp.toISOString().split('T')[0]} (周)`;
                }
                return `${y}-${m}-${d}`;
            };

            const updateCharts = () => {
                if (!chartInstances.trend) return;
                const data = filteredData.value;
                if (!data.length) {
                    Object.values(chartInstances).forEach(c => c && c.clear());
                    return;
                }

                // 1. 趋势分析 (支持粒度)
                const trendMap = {};
                data.forEach(item => {
                    const key = getDateKey(new Date(item.dateObj), filters.value.timeGrain);
                    if (!trendMap[key]) trendMap[key] = { amount: 0, qty: 0 };
                    trendMap[key].amount += item.amount;
                    trendMap[key].qty += item.quantity;
                });
                const sortedKeys = Object.keys(trendMap).sort();

                chartInstances.trend.setOption({
                    tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                    legend: { data: ['销售额', '销量'] },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'category', data: sortedKeys },
                    yAxis: [
                        { type: 'value', name: '销售额', axisLabel: { formatter: '€{value}' } },
                        { type: 'value', name: '销量', splitLine: { show: false } }
                    ],
                    series: [
                        { 
                            name: '销售额', type: 'line', smooth: true, 
                            data: sortedKeys.map(d => trendMap[d].amount.toFixed(2)),
                            itemStyle: { color: '#2563eb' },
                            areaStyle: { opacity: 0.1, color: '#2563eb' }
                        },
                        { 
                            name: '销量', type: 'bar', yAxisIndex: 1,
                            data: sortedKeys.map(d => trendMap[d].qty),
                            itemStyle: { color: '#94a3b8', borderRadius: [2, 2, 0, 0] },
                            barMaxWidth: 40
                        }
                    ]
                });

                // 2. 品牌 (Top 10 + 其他)
                const brandMap = {};
                data.forEach(item => {
                    const b = item.brand;
                    brandMap[b] = (brandMap[b] || 0) + item.amount;
                });
                let brandArr = Object.entries(brandMap).sort((a,b) => b[1] - a[1]);
                if (brandArr.length > 8) {
                    const otherSum = brandArr.slice(8).reduce((sum, i) => sum + i[1], 0);
                    brandArr = brandArr.slice(0, 8);
                    brandArr.push(['其他', otherSum]);
                }

                chartInstances.brand.setOption({
                    tooltip: { trigger: 'item', formatter: '{b}: €{c} ({d}%)' },
                    series: [{
                        type: 'pie',
                        radius: ['40%', '70%'],
                        itemStyle: { borderRadius: 4, borderColor: '#fff', borderWidth: 2 },
                        data: brandArr.map(i => ({ name: i[0], value: parseFloat(i[1].toFixed(2)) }))
                    }]
                });

                // 3. 尺码 (按数量排序)
                const sizeMap = {};
                data.forEach(item => {
                    sizeMap[item.size] = (sizeMap[item.size] || 0) + item.quantity;
                });
                const sizeArr = Object.entries(sizeMap).sort((a,b) => b[1] - a[1]); // 数量降序

                chartInstances.size.setOption({
                    tooltip: { trigger: 'axis' },
                    grid: { bottom: '10%', top: '10%' },
                    xAxis: { type: 'category', data: sizeArr.map(i => i[0]), axisLabel: { interval: 0 } },
                    yAxis: { type: 'value' },
                    series: [{
                        type: 'bar',
                        data: sizeArr.map(i => i[1]),
                        itemStyle: { color: '#10b981' }
                    }]
                });

                // 4. 品类饼图（按销售额）
                const categoryMap = {};
                data.forEach(item => {
                    const c = item.category || '其他';
                    categoryMap[c] = (categoryMap[c] || 0) + item.amount;
                });
                const categoryArr = Object.entries(categoryMap).sort((a,b) => b[1] - a[1]);

                chartInstances.category.setOption({
                    tooltip: { trigger: 'item', formatter: '{b}: €{c} ({d}%)' },
                    series: [{
                        type: 'pie',
                        radius: ['40%', '70%'],
                        itemStyle: { borderRadius: 4, borderColor: '#fff', borderWidth: 2 },
                        data: categoryArr.map(i => ({ name: i[0], value: parseFloat(i[1].toFixed(2)) }))
                    }]
                });

                // 5. Top 商品
                const productMap = {};
                data.forEach(item => {
                    productMap[item.name] = (productMap[item.name] || 0) + item.amount;
                });
                const topProducts = Object.entries(productMap)
                    .sort((a,b) => b[1] - a[1])
                    .slice(0, 10);

                chartInstances.topProduct.setOption({
                    tooltip: { trigger: 'axis', formatter: params => `${params[0].name}: €${Number(params[0].value).toFixed(2)}` },
                    grid: { left: '3%', right: '5%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'value' },
                    yAxis: { 
                        type: 'category', 
                        data: topProducts.map(i => i[0].length > 20 ? i[0].substring(0,20)+'...' : i[0]) 
                    },
                    series: [{
                        type: 'bar',
                        data: topProducts.map(i => Number(i[1].toFixed(2))),
                        itemStyle: { color: '#f97316' },
                        label: { show: true, position: 'right', formatter: params => `€${Number(params.value).toFixed(2)}` }
                    }]
                });
            };

            const initCharts = () => {
                if(trendChart.value) {
                    chartInstances.trend = echarts.init(trendChart.value);
                    chartInstances.brand = echarts.init(brandChart.value);
                    chartInstances.size = echarts.init(sizeChart.value);
                    chartInstances.category = echarts.init(categoryChart.value);
                    chartInstances.topProduct = echarts.init(topProductChart.value);
                    updateCharts();
                    window.addEventListener('resize', () => Object.values(chartInstances).forEach(c => c && c.resize()));
                }
            };

            const resetData = () => {
                rawData.value = [];
                filters.value = { brand: 'ALL', size: 'ALL', category: 'ALL', gender: 'ALL', sku: '', startDate: '', endDate: '', timeGrain: 'day' };
                chartInstances = { trend: null, brand: null, size: null, category: null, topProduct: null };
            };

            const formatNumber = (num) => Number(num).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            watch(filters, updateCharts, { deep: true });

            return {
                rawData, filters, filteredData, uniqueOptions, kpi,
                trendChart, brandChart, sizeChart, categoryChart, topProductChart,
                handleFileUpload, handleDrop, resetData, formatNumber
            };
        }
    }).mount('#app');
</script>
</body>
</html>


