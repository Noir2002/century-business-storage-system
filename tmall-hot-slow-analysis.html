<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>天猫爆品滞销品分析 - 数据管理系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="src/css/layui.css">
  <script src="src/modules/jquery.js"></script>
  <script src="src/layui.js"></script>
  <script src="./api-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .analysis-container { padding: 20px; background: #f8f9fa; min-height: 100vh; }
    .analysis-header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
    .stat-number { font-size: 2em; font-weight: bold; color: #1E9FFF; }
    .stat-label { color: #666; margin-top: 5px; }
    .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .chart { height: 400px; width: 100%; }
    .product-list { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .filter-bar { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .hot-product { color: #FF5722; font-weight: bold; }
    .slow-product { color: #FFB800; font-weight: bold; }
    .normal-product { color: #5FB878; font-weight: bold; }
    .back-btn { margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="analysis-container">
    <div class="back-btn">
      <button class="layui-btn layui-btn-primary" onclick="window.location.href='data-analysis.html'">
        <i class="layui-icon layui-icon-left"></i> 返回数据分析
      </button>
    </div>
    <div class="analysis-header">
      <h1>📊 天猫爆品滞销品分析</h1>
      <p>智能分析天猫明细表，识别爆品和滞销品，支持时间范围和前N名筛选</p>
    </div>
    <div class="filter-bar">
      <form class="layui-form" lay-filter="analysisFilter">
        <div class="layui-form-item">
          <div class="layui-inline">
            <label class="layui-form-label">分析范围</label>
            <div class="layui-input-inline">
              <select name="timeRange" lay-filter="timeRange">
                <option value="7">最近7天</option>
                <option value="30" selected>最近30天</option>
                <option value="90">最近90天</option>
                <option value="180">最近半年</option>
                <option value="365">最近一年</option>
              </select>
            </div>
          </div>
          <div class="layui-inline">
            <label class="layui-form-label">显示数量</label>
            <div class="layui-input-inline">
              <select name="limit">
                <option value="10">前10名</option>
                <option value="20" selected>前20名</option>
                <option value="50">前50名</option>
              </select>
            </div>
          </div>
          <div class="layui-inline">
            <button class="layui-btn" lay-submit lay-filter="updateAnalysis">
              <i class="layui-icon layui-icon-refresh"></i> 更新分析
            </button>
          </div>
        </div>
      </form>
    </div>
    <div class="stats-cards">
      <div class="stat-card"><div class="stat-number" id="totalSku">0</div><div class="stat-label">总SKU数</div></div>
      <div class="stat-card"><div class="stat-number" id="hotCount">0</div><div class="stat-label">爆品数量</div></div>
      <div class="stat-card"><div class="stat-number" id="slowCount">0</div><div class="stat-label">滞销品数量</div></div>
      <div class="stat-card"><div class="stat-number" id="totalSales">0</div><div class="stat-label">总销量</div></div>
    </div>
    <div class="chart-container">
      <h3>📊 每日总销量趋势</h3>
      <div id="dailyTotalSalesChart" class="chart"></div>
    </div>
    <div class="chart-container">
      <h3>📈 销量趋势分析</h3>
      <div id="salesTrendChart" class="chart"></div>
    </div>
    <div class="chart-container">
      <h3>🔥 爆品销量排行</h3>
      <div id="hotProductsChart" class="chart"></div>
    </div>
    <div class="chart-container">
      <h3>🔥 爆品分级分析</h3>
      <div id="hotLevelChartsContainer"></div>
    </div>
    <div class="chart-container">
      <h3>📉 滞销品分析</h3>
      <div id="slowProductsChart" class="chart"></div>
    </div>
    <div class="product-list">
      <h3>📋 SKU详细分析</h3>
      <table class="layui-table" id="productTable">
        <thead>
          <tr>
            <th>排名</th>
            <th>SKU</th>
            <th>总销量</th>
            <th>平均日销量</th>
            <th>销量明细</th>
          </tr>
        </thead>
        <tbody id="productTableBody"></tbody>
      </table>
      <div id="productTablePagination"></div>
    </div>
  </div>
  <script>
    layui.use(['form', 'layer', 'table', 'jquery'], function(){
      var form = layui.form;
      var layer = layui.layer;
      var $ = layui.jquery;
      var salesTrendChart = null;
      var hotProductsChart = null;
      var slowProductsChart = null;
      var allData = [];
      var currentTimeRange = 30;
      var currentLimit = 20;
      // 初始化
      initPage();
      function initPage() {
        loadData();
        form.on('submit(updateAnalysis)', function(data){
          currentTimeRange = parseInt(data.field.timeRange || 30);
          currentLimit = parseInt(data.field.limit || 20);
          loadData();
          return false;
        });
      }
      function loadData() {
        layer.msg('正在加载天猫明细数据...', {icon: 16, time: 1000});
        var token = localStorage.getItem('token');
        var headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        $.ajax({
          url: window.apiConfig.baseURL + '/api/tmall-orders/wide',
          type: 'GET',
          headers: headers,
          success: function(res) {
            if(res.success) {
              allData = res.data || [];
              processData();
            } else {
              layer.msg('数据加载失败', {icon:2});
            }
          },
          error: function() { layer.msg('数据加载失败', {icon:2}); }
        });
      }
      function processData() {
        // 1. 过滤时间范围
        var now = new Date();
        var startDate = new Date(now);
        startDate.setDate(now.getDate() - currentTimeRange + 1);
        // 2. 聚合SKU销量
        var skuMap = {};
        allData.forEach(row => {
          var sku = row['SKU'];
          var timeRaw = row['店铺订单时间'] || row['订单时间'] || row['时间'];
          var qty = parseInt(row['商品数量'] || row['数量'] || 0);
          if (!sku || !timeRaw || !qty) return;
          var dateStr = '';
          try {
            var d = new Date(timeRaw.replace(/[./]/g, '-'));
            if (!isNaN(d)) dateStr = d.toISOString().split('T')[0];
          } catch(e) {}
          if (!dateStr) return;
          if (new Date(dateStr) < startDate) return;
          if (!skuMap[sku]) skuMap[sku] = { sku: sku, totalSales: 0, salesByDate: {}, salesList: [] };
          skuMap[sku].totalSales += qty;
          skuMap[sku].salesByDate[dateStr] = (skuMap[sku].salesByDate[dateStr] || 0) + qty;
          skuMap[sku].salesList.push({ date: dateStr, qty: qty });
        });
        var skuArr = Object.values(skuMap);
        // 3. 统计卡片
        $('#totalSku').text(skuArr.length);
        $('#totalSales').text(skuArr.reduce((sum, s) => sum + s.totalSales, 0));
        // 4. 排序
        skuArr.sort((a, b) => b.totalSales - a.totalSales);
        var hotArr = skuArr.slice(0, currentLimit);
        var slowArr = skuArr.filter(s => s.totalSales <= 5);
        $('#hotCount').text(hotArr.length);
        $('#slowCount').text(slowArr.length);
        // 5. 销量趋势图
        renderSalesTrendChart(skuArr);
        renderDailyTotalSalesChart(skuArr);
        // 6. 爆品排行
        renderHotProductsChart(hotArr);
        // 7. 爆品分级
        renderHotLevelCharts(skuArr);
        // 8. 滞销品
        renderSlowProductsChart(slowArr);
        // 9. 详细表格
        renderProductTable(skuArr);
      }
      function renderDailyTotalSalesChart(skuArr) {
        var chartDom = document.getElementById('dailyTotalSalesChart');
        var chart = echarts.init(chartDom);
        // 聚合所有SKU的每日销量
        var dateMap = {};
        skuArr.forEach(s => {
          Object.entries(s.salesByDate).forEach(([date, qty]) => {
            dateMap[date] = (dateMap[date] || 0) + qty;
          });
        });
        var dates = Object.keys(dateMap).sort();
        var values = dates.map(d => dateMap[d]);
        var option = {
          title: { text: '每日总销量趋势', left: 'center' },
          tooltip: { trigger: 'axis' },
          xAxis: { type: 'category', data: dates },
          yAxis: { type: 'value' },
          series: [{ name: '总销量', type: 'line', data: values, smooth: true, itemStyle: { color: '#1E9FFF' } }]
        };
        chart.setOption(option);
      }
      function renderSalesTrendChart(skuArr) {
        var chartDom = document.getElementById('salesTrendChart');
        if (salesTrendChart) salesTrendChart.dispose();
        salesTrendChart = echarts.init(chartDom);
        // 取前10爆品
        var top = skuArr.slice(0, 10);
        var x = ['总销量', '平均日销量'];
        var option = {
          title: { text: '销量趋势分析', left: 'center' },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          legend: { data: top.map(s => s.sku), type: 'scroll', bottom: 10 },
          grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
          xAxis: { type: 'category', data: x },
          yAxis: { type: 'value' },
          series: top.map((s, i) => ({
            name: s.sku,
            type: 'bar',
            data: [s.totalSales, Math.round(s.totalSales / currentTimeRange * 10) / 10],
            itemStyle: { color: i < 3 ? '#FF5722' : '#1E9FFF' }
          }))
        };
        salesTrendChart.setOption(option);
      }
      function renderHotProductsChart(hotArr) {
        var chartDom = document.getElementById('hotProductsChart');
        if (hotProductsChart) hotProductsChart.dispose();
        hotProductsChart = echarts.init(chartDom);
        var option = {
          title: { text: '爆品销量排行', left: 'center' },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
          xAxis: { type: 'value' },
          yAxis: { type: 'category', data: hotArr.map(s => s.sku) },
          series: [{ name: '销量', type: 'bar', data: hotArr.map(s => s.totalSales), itemStyle: { color: '#FF5722' } }]
        };
        hotProductsChart.setOption(option);
      }
      function renderHotLevelCharts(skuArr) {
        var chartContainer = document.getElementById('hotLevelChartsContainer');
        chartContainer.innerHTML = '';
        var buttonGroup = document.createElement('div');
        buttonGroup.style.textAlign = 'center';
        buttonGroup.style.marginBottom = '20px';
        buttonGroup.innerHTML = `
          <button class="layui-btn layui-btn-sm layui-btn-primary" data-level="10">前10</button>
          <button class="layui-btn layui-btn-sm" data-level="20">前20</button>
          <button class="layui-btn layui-btn-sm" data-level="50">前50</button>
          <button class="layui-btn layui-btn-sm" data-level="100">前100</button>
        `;
        chartContainer.appendChild(buttonGroup);
        var chartDiv = document.createElement('div');
        chartDiv.style.height = '400px';
        chartDiv.id = 'hotLevelChart';
        chartContainer.appendChild(chartDiv);
        var chart = echarts.init(chartDiv);
        function updateChart(level) {
          var data = skuArr.slice(0, level);
          var option = {
            title: { text: `爆品销量排行（前${level}）`, left: 'center' },
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'value' },
            yAxis: { type: 'category', data: data.map(s => s.sku) },
            series: [{ name: '销量', type: 'bar', data: data.map(s => s.totalSales), itemStyle: { color: '#FF5722' } }]
          };
          chart.setOption(option);
        }
        updateChart(10);
        buttonGroup.addEventListener('click', function(e) {
          if (e.target.tagName === 'BUTTON') {
            var level = parseInt(e.target.getAttribute('data-level'));
            buttonGroup.querySelectorAll('button').forEach(btn => btn.className = 'layui-btn layui-btn-sm');
            e.target.className = 'layui-btn layui-btn-sm layui-btn-primary';
            updateChart(level);
          }
        });
      }
      function renderSlowProductsChart(slowArr) {
        var chartDom = document.getElementById('slowProductsChart');
        if (slowProductsChart) slowProductsChart.dispose();
        slowProductsChart = echarts.init(chartDom);
        var data = slowArr.slice(0, 10);
        var option = {
          title: { text: '滞销品（销量≤5）前10', left: 'center' },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
          xAxis: { type: 'value' },
          yAxis: { type: 'category', data: data.map(s => s.sku) },
          series: [{ name: '销量', type: 'bar', data: data.map(s => s.totalSales), itemStyle: { color: '#FFB800' } }]
        };
        slowProductsChart.setOption(option);
      }
      function renderProductTable(skuArr) {
        var tbody = $('#productTableBody');
        tbody.empty();
        skuArr.slice(0, currentLimit).forEach((s, idx) => {
          var salesDetail = Object.entries(s.salesByDate).map(([date, qty]) => `${date}: ${qty}`).join('<br>');
          var row = `<tr>
            <td>${idx+1}</td>
            <td>${s.sku}</td>
            <td>${s.totalSales}</td>
            <td>${Math.round(s.totalSales / currentTimeRange * 10) / 10}</td>
            <td>${salesDetail}</td>
          </tr>`;
          tbody.append(row);
        });
      }
      window.addEventListener('resize', function() {
        if (salesTrendChart) salesTrendChart.resize();
        if (hotProductsChart) hotProductsChart.resize();
        if (slowProductsChart) slowProductsChart.resize();
      });
      function goBack() { window.location.href = 'data-analysis.html'; }
    });
  </script>
</body>
</html> 