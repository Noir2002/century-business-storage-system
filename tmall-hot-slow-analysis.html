<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>å¤©çŒ«çˆ†å“æ»é”€å“åˆ†æ - æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="src/css/layui.css">
  <script src="src/modules/jquery.js"></script>
  <script src="src/layui.js"></script>
  <script src="./api-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .analysis-container { padding: 20px; background: #f8f9fa; min-height: 100vh; }
    .analysis-header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
    .stat-number { font-size: 2em; font-weight: bold; color: #1E9FFF; }
    .stat-label { color: #666; margin-top: 5px; }
    .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .chart { height: 400px; width: 100%; }
    .product-list { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .filter-bar { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .hot-product { color: #FF5722; font-weight: bold; }
    .slow-product { color: #FFB800; font-weight: bold; }
    .normal-product { color: #5FB878; font-weight: bold; }
    .back-btn { margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="analysis-container">
    <div class="back-btn">
      <button class="layui-btn layui-btn-primary" onclick="window.location.href='data-analysis.html'">
        <i class="layui-icon layui-icon-left"></i> è¿”å›æ•°æ®åˆ†æ
      </button>
    </div>
    <div class="analysis-header">
      <h1>ğŸ“Š å¤©çŒ«çˆ†å“æ»é”€å“åˆ†æ</h1>
      <p>æ™ºèƒ½åˆ†æå¤©çŒ«æ˜ç»†è¡¨ï¼Œè¯†åˆ«çˆ†å“å’Œæ»é”€å“ï¼Œæ”¯æŒæ—¶é—´èŒƒå›´å’Œå‰Nåç­›é€‰</p>
    </div>
    <div class="filter-bar">
      <form class="layui-form" lay-filter="analysisFilter">
        <div class="layui-form-item">
          <div class="layui-inline">
            <label class="layui-form-label">åˆ†æèŒƒå›´</label>
            <div class="layui-input-inline">
              <select name="timeRange" lay-filter="timeRange">
                <option value="7">æœ€è¿‘7å¤©</option>
                <option value="30" selected>æœ€è¿‘30å¤©</option>
                <option value="90">æœ€è¿‘90å¤©</option>
                <option value="180">æœ€è¿‘åŠå¹´</option>
                <option value="365">æœ€è¿‘ä¸€å¹´</option>
              </select>
            </div>
          </div>
          <div class="layui-inline">
            <label class="layui-form-label">æ˜¾ç¤ºæ•°é‡</label>
            <div class="layui-input-inline">
              <select name="limit">
                <option value="10">å‰10å</option>
                <option value="20" selected>å‰20å</option>
                <option value="50">å‰50å</option>
              </select>
            </div>
          </div>
          <div class="layui-inline">
            <button class="layui-btn" lay-submit lay-filter="updateAnalysis">
              <i class="layui-icon layui-icon-refresh"></i> æ›´æ–°åˆ†æ
            </button>
          </div>
        </div>
      </form>
    </div>
    <div class="stats-cards">
      <div class="stat-card"><div class="stat-number" id="totalSku">0</div><div class="stat-label">æ€»SKUæ•°</div></div>
      <div class="stat-card"><div class="stat-number" id="hotCount">0</div><div class="stat-label">çˆ†å“æ•°é‡</div></div>
      <div class="stat-card"><div class="stat-number" id="slowCount">0</div><div class="stat-label">æ»é”€å“æ•°é‡</div></div>
      <div class="stat-card"><div class="stat-number" id="totalSales">0</div><div class="stat-label">æ€»é”€é‡</div></div>
    </div>
    <div class="chart-container">
      <h3>ğŸ“Š æ¯æ—¥æ€»é”€é‡è¶‹åŠ¿</h3>
      <div id="dailyTotalSalesChart" class="chart"></div>
    </div>
    <div class="chart-container">
      <h3>ğŸ“ˆ é”€é‡è¶‹åŠ¿åˆ†æ</h3>
      <div id="salesTrendChart" class="chart"></div>
    </div>
    <div class="chart-container">
      <h3>ğŸ”¥ çˆ†å“é”€é‡æ’è¡Œ</h3>
      <div id="hotProductsChart" class="chart"></div>
    </div>
    <div class="chart-container">
      <h3>ğŸ”¥ çˆ†å“åˆ†çº§åˆ†æ</h3>
      <div id="hotLevelChartsContainer"></div>
    </div>
    <div class="chart-container">
      <h3>ğŸ“‰ æ»é”€å“åˆ†æ</h3>
      <div id="slowProductsChart" class="chart"></div>
    </div>
    <div class="product-list">
      <h3>ğŸ“‹ SKUè¯¦ç»†åˆ†æ</h3>
      <table class="layui-table" id="productTable">
        <thead>
          <tr>
            <th>æ’å</th>
            <th>SKU</th>
            <th>æ€»é”€é‡</th>
            <th>å¹³å‡æ—¥é”€é‡</th>
            <th>é”€é‡æ˜ç»†</th>
          </tr>
        </thead>
        <tbody id="productTableBody"></tbody>
      </table>
      <div id="productTablePagination"></div>
    </div>
  </div>
  <script>
    layui.use(['form', 'layer', 'table', 'jquery'], function(){
      var form = layui.form;
      var layer = layui.layer;
      var $ = layui.jquery;
      var salesTrendChart = null;
      var hotProductsChart = null;
      var slowProductsChart = null;
      var allData = [];
      var currentTimeRange = 30;
      var currentLimit = 20;
      // åˆå§‹åŒ–
      initPage();
      function initPage() {
        loadData();
        form.on('submit(updateAnalysis)', function(data){
          currentTimeRange = parseInt(data.field.timeRange || 30);
          currentLimit = parseInt(data.field.limit || 20);
          loadData();
          return false;
        });
      }
      function loadData() {
        layer.msg('æ­£åœ¨åŠ è½½å¤©çŒ«æ˜ç»†æ•°æ®...', {icon: 16, time: 1000});
        var token = localStorage.getItem('token');
        var headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        $.ajax({
          url: window.apiConfig.baseURL + '/api/tmall-orders/wide',
          type: 'GET',
          headers: headers,
          success: function(res) {
            if(res.success) {
              allData = res.data || [];
              processData();
            } else {
              layer.msg('æ•°æ®åŠ è½½å¤±è´¥', {icon:2});
            }
          },
          error: function() { layer.msg('æ•°æ®åŠ è½½å¤±è´¥', {icon:2}); }
        });
      }
      function processData() {
        // 1. è¿‡æ»¤æ—¶é—´èŒƒå›´
        var now = new Date();
        var startDate = new Date(now);
        startDate.setDate(now.getDate() - currentTimeRange + 1);
        // 2. èšåˆSKUé”€é‡
        var skuMap = {};
        allData.forEach(row => {
          var sku = row['SKU'];
          var timeRaw = row['åº—é“ºè®¢å•æ—¶é—´'] || row['è®¢å•æ—¶é—´'] || row['æ—¶é—´'];
          var qty = parseInt(row['å•†å“æ•°é‡'] || row['æ•°é‡'] || 0);
          if (!sku || !timeRaw || !qty) return;
          var dateStr = '';
          try {
            var d = new Date(timeRaw.replace(/[./]/g, '-'));
            if (!isNaN(d)) dateStr = d.toISOString().split('T')[0];
          } catch(e) {}
          if (!dateStr) return;
          if (new Date(dateStr) < startDate) return;
          if (!skuMap[sku]) skuMap[sku] = { sku: sku, totalSales: 0, salesByDate: {}, salesList: [] };
          skuMap[sku].totalSales += qty;
          skuMap[sku].salesByDate[dateStr] = (skuMap[sku].salesByDate[dateStr] || 0) + qty;
          skuMap[sku].salesList.push({ date: dateStr, qty: qty });
        });
        var skuArr = Object.values(skuMap);
        // 3. ç»Ÿè®¡å¡ç‰‡
        $('#totalSku').text(skuArr.length);
        $('#totalSales').text(skuArr.reduce((sum, s) => sum + s.totalSales, 0));
        // 4. æ’åº
        skuArr.sort((a, b) => b.totalSales - a.totalSales);
        var hotArr = skuArr.slice(0, currentLimit);
        var slowArr = skuArr.filter(s => s.totalSales <= 5);
        $('#hotCount').text(hotArr.length);
        $('#slowCount').text(slowArr.length);
        // 5. é”€é‡è¶‹åŠ¿å›¾
        renderSalesTrendChart(skuArr);
        renderDailyTotalSalesChart(skuArr);
        // 6. çˆ†å“æ’è¡Œ
        renderHotProductsChart(hotArr);
        // 7. çˆ†å“åˆ†çº§
        renderHotLevelCharts(skuArr);
        // 8. æ»é”€å“
        renderSlowProductsChart(slowArr);
        // 9. è¯¦ç»†è¡¨æ ¼
        renderProductTable(skuArr);
      }
      function renderDailyTotalSalesChart(skuArr) {
        var chartDom = document.getElementById('dailyTotalSalesChart');
        var chart = echarts.init(chartDom);
        // èšåˆæ‰€æœ‰SKUçš„æ¯æ—¥é”€é‡
        var dateMap = {};
        skuArr.forEach(s => {
          Object.entries(s.salesByDate).forEach(([date, qty]) => {
            dateMap[date] = (dateMap[date] || 0) + qty;
          });
        });
        var dates = Object.keys(dateMap).sort();
        var values = dates.map(d => dateMap[d]);
        var option = {
          title: { text: 'æ¯æ—¥æ€»é”€é‡è¶‹åŠ¿', left: 'center' },
          tooltip: { trigger: 'axis' },
          xAxis: { type: 'category', data: dates },
          yAxis: { type: 'value' },
          series: [{ name: 'æ€»é”€é‡', type: 'line', data: values, smooth: true, itemStyle: { color: '#1E9FFF' } }]
        };
        chart.setOption(option);
      }
      function renderSalesTrendChart(skuArr) {
        var chartDom = document.getElementById('salesTrendChart');
        if (salesTrendChart) salesTrendChart.dispose();
        salesTrendChart = echarts.init(chartDom);
        // å–å‰10çˆ†å“
        var top = skuArr.slice(0, 10);
        var x = ['æ€»é”€é‡', 'å¹³å‡æ—¥é”€é‡'];
        var option = {
          title: { text: 'é”€é‡è¶‹åŠ¿åˆ†æ', left: 'center' },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          legend: { data: top.map(s => s.sku), type: 'scroll', bottom: 10 },
          grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
          xAxis: { type: 'category', data: x },
          yAxis: { type: 'value' },
          series: top.map((s, i) => ({
            name: s.sku,
            type: 'bar',
            data: [s.totalSales, Math.round(s.totalSales / currentTimeRange * 10) / 10],
            itemStyle: { color: i < 3 ? '#FF5722' : '#1E9FFF' }
          }))
        };
        salesTrendChart.setOption(option);
      }
      function renderHotProductsChart(hotArr) {
        var chartDom = document.getElementById('hotProductsChart');
        if (hotProductsChart) hotProductsChart.dispose();
        hotProductsChart = echarts.init(chartDom);
        var option = {
          title: { text: 'çˆ†å“é”€é‡æ’è¡Œ', left: 'center' },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
          xAxis: { type: 'value' },
          yAxis: { type: 'category', data: hotArr.map(s => s.sku) },
          series: [{ name: 'é”€é‡', type: 'bar', data: hotArr.map(s => s.totalSales), itemStyle: { color: '#FF5722' } }]
        };
        hotProductsChart.setOption(option);
      }
      function renderHotLevelCharts(skuArr) {
        var chartContainer = document.getElementById('hotLevelChartsContainer');
        chartContainer.innerHTML = '';
        var buttonGroup = document.createElement('div');
        buttonGroup.style.textAlign = 'center';
        buttonGroup.style.marginBottom = '20px';
        buttonGroup.innerHTML = `
          <button class="layui-btn layui-btn-sm layui-btn-primary" data-level="10">å‰10</button>
          <button class="layui-btn layui-btn-sm" data-level="20">å‰20</button>
          <button class="layui-btn layui-btn-sm" data-level="50">å‰50</button>
          <button class="layui-btn layui-btn-sm" data-level="100">å‰100</button>
        `;
        chartContainer.appendChild(buttonGroup);
        var chartDiv = document.createElement('div');
        chartDiv.style.height = '400px';
        chartDiv.id = 'hotLevelChart';
        chartContainer.appendChild(chartDiv);
        var chart = echarts.init(chartDiv);
        function updateChart(level) {
          var data = skuArr.slice(0, level);
          var option = {
            title: { text: `çˆ†å“é”€é‡æ’è¡Œï¼ˆå‰${level}ï¼‰`, left: 'center' },
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'value' },
            yAxis: { type: 'category', data: data.map(s => s.sku) },
            series: [{ name: 'é”€é‡', type: 'bar', data: data.map(s => s.totalSales), itemStyle: { color: '#FF5722' } }]
          };
          chart.setOption(option);
        }
        updateChart(10);
        buttonGroup.addEventListener('click', function(e) {
          if (e.target.tagName === 'BUTTON') {
            var level = parseInt(e.target.getAttribute('data-level'));
            buttonGroup.querySelectorAll('button').forEach(btn => btn.className = 'layui-btn layui-btn-sm');
            e.target.className = 'layui-btn layui-btn-sm layui-btn-primary';
            updateChart(level);
          }
        });
      }
      function renderSlowProductsChart(slowArr) {
        var chartDom = document.getElementById('slowProductsChart');
        if (slowProductsChart) slowProductsChart.dispose();
        slowProductsChart = echarts.init(chartDom);
        var data = slowArr.slice(0, 10);
        var option = {
          title: { text: 'æ»é”€å“ï¼ˆé”€é‡â‰¤5ï¼‰å‰10', left: 'center' },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
          xAxis: { type: 'value' },
          yAxis: { type: 'category', data: data.map(s => s.sku) },
          series: [{ name: 'é”€é‡', type: 'bar', data: data.map(s => s.totalSales), itemStyle: { color: '#FFB800' } }]
        };
        slowProductsChart.setOption(option);
      }
      function renderProductTable(skuArr) {
        var tbody = $('#productTableBody');
        tbody.empty();
        skuArr.slice(0, currentLimit).forEach((s, idx) => {
          var salesDetail = Object.entries(s.salesByDate).map(([date, qty]) => `${date}: ${qty}`).join('<br>');
          var row = `<tr>
            <td>${idx+1}</td>
            <td>${s.sku}</td>
            <td>${s.totalSales}</td>
            <td>${Math.round(s.totalSales / currentTimeRange * 10) / 10}</td>
            <td>${salesDetail}</td>
          </tr>`;
          tbody.append(row);
        });
      }
      window.addEventListener('resize', function() {
        if (salesTrendChart) salesTrendChart.resize();
        if (hotProductsChart) hotProductsChart.resize();
        if (slowProductsChart) slowProductsChart.resize();
      });
      function goBack() { window.location.href = 'data-analysis.html'; }
    });
  </script>
</body>
</html> 