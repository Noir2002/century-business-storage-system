<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>数据分析 - 数据管理系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="./src/css/layui.css" rel="stylesheet">
  <link href="./src/css/app-header.css" rel="stylesheet">
  <script src="./api-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    body {
      background: #f8f9fa;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header .layui-nav {
      background: transparent;
    }
    .header .layui-nav .layui-nav-item a {
      color: rgba(255,255,255,0.9);
    }
    .header .layui-nav .layui-nav-item a:hover {
      color: white;
    }
    .header .logo {
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
    }
    
    /* 主导航样式 */
    .main-nav {
      flex: 1;
      display: flex;
      justify-content: center;
      margin: 0 20px;
    }
    .main-nav .layui-nav-item {
      margin: 0 5px;
    }
    .main-nav .layui-nav-item a {
      padding: 0 20px;
      border-radius: 6px;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .main-nav .layui-nav-item a:hover,
    .main-nav .layui-nav-item.layui-this a {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    .main-nav .layui-nav-item a i {
      margin-right: 6px;
    }
    
    .header .user-info {
      white-space: nowrap;
    }
    
    /* 用户下拉菜单样式 */
    .user-info .layui-nav-child dd a {
      padding: 10px 15px;
      color: #666;
      transition: all 0.3s ease;
    }
    .user-info .layui-nav-child dd a:hover {
      background: #f8f9fa;
      color: #16baaa;
    }
    .user-info .layui-nav-child dd a i {
      margin-right: 8px;
      font-size: 14px;
    }
    
    .content-wrapper {
      padding: 20px;
    }
    
    .page-header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .page-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin: 0;
    }
    .page-subtitle {
      color: #666;
      margin-top: 5px;
    }
    .breadcrumb {
      color: #999;
      font-size: 14px;
      margin-top: 10px;
    }
    .breadcrumb a {
      color: #16baaa;
      text-decoration: none;
    }
    
    .filter-panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .filter-title {
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }
    
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .stats-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .stats-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
    }
    .stats-card.blue::before { background: #16baaa; }
    .stats-card.green::before { background: #52c41a; }
    .stats-card.orange::before { background: #fa8c16; }
    .stats-card.red::before { background: #f5222d; }
    .stats-card.purple::before { background: #722ed1; }
    
    .stats-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .stats-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .stats-label {
      color: #666;
      font-size: 14px;
    }
    .stats-trend {
      font-size: 12px;
      margin-top: 5px;
    }
    .trend-up { color: #52c41a; }
    .trend-down { color: #f5222d; }
    
    .chart-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .chart-header {
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
      background: #fafafa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chart-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin: 0;
    }
    .chart-controls {
      display: flex;
      gap: 10px;
    }
    .chart-content {
      padding: 20px;
    }
    .chart {
      width: 100%;
      height: 400px;
    }
    
    .table-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .table-header {
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
      background: #fafafa;
    }
    .analysis-table {
      width: 100%;
      font-size: 13px;
    }
    .analysis-table th {
      background: #f8f9fa;
      font-weight: bold;
      text-align: center;
      padding: 12px 8px;
      border-bottom: 1px solid #e6e6e6;
    }
    .analysis-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f0f0f0;
      text-align: center;
    }
    .analysis-table tbody tr:hover {
      background: #f8f9fa;
    }
    
    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    .no-data-icon {
      font-size: 48px;
      margin-bottom: 15px;
      display: block;
    }
    
    /* 新增：爆品滞销品分析按钮 */
    .hot-slow-btn {
      background: linear-gradient(135deg, #FF5722 0%, #FF9800 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .hot-slow-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
    }
    
    /* 上下架管理样式 */
    .listing-management-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    
    .management-controls {
      margin-top: 15px;
      text-align: right;
    }
    
    .management-controls .layui-btn {
      margin-left: 10px;
    }
    
    .listing-section {
      background: #fafafa;
      border-radius: 8px;
      margin-top: 20px;
      padding: 15px;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e8e8e8;
    }
    
    .section-header h4 {
      margin: 0;
      font-size: 16px;
    }
    
    .section-controls .layui-btn {
      margin-left: 8px;
    }
    
    .listing-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .listing-table th,
    .listing-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .listing-table th {
      background: #f8f9fa;
      font-weight: bold;
      color: #333;
    }
    
    .listing-table tbody tr:hover {
      background: #f5f5f5;
    }
    
    .listing-table .sku-cell {
      font-family: 'Courier New', monospace;
      font-weight: bold;
    }
    
    .listing-table .url-cell {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .listing-table .url-cell a {
      color: #16baaa;
      text-decoration: none;
    }
    
    .listing-table .url-cell a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="layui-header header">
    <div class="logo">
      📊 数据管理系统
    </div>

    <!-- 主导航按钮 -->
    <ul class="layui-nav main-nav">
      <li class="layui-nav-item">
        <a href="dashboard.html">
          <i class="layui-icon layui-icon-home"></i> 数据仪表盘
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="table-management.html">
          <i class="layui-icon layui-icon-table"></i> 表格管理
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="data-upload.html">
          <i class="layui-icon layui-icon-upload-drag"></i> 数据导入
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="virtual-inventory.html">
          <i class="layui-icon layui-icon-engine"></i> 虚拟库存
        </a>
      </li>
      <li class="layui-nav-item layui-this">
        <a href="data-analysis.html">
          <i class="layui-icon layui-icon-chart"></i> 数据分析
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="local-database.html">
          <i class="layui-icon layui-icon-database"></i> 本地数据库
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="tmall-database.html">
          <i class="layui-icon layui-icon-cart"></i> 天猫数据库
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="tmall-order.html">
          <i class="layui-icon layui-icon-list"></i> 天猫订单
        </a>
      </li>
      <li class="layui-nav-item" id="adminOnlyTopNav" style="display: none;">
        <a href="user-management.html">
          <i class="layui-icon layui-icon-username"></i> 用户管理
        </a>
      </li>
    </ul>
    
    
  </div>
  
  <div class="content-wrapper">
    <!-- 页面头部 -->
    <div class="page-header">
      <h1 class="page-title">📈 数据分析</h1>
      <p class="page-subtitle">库存和销售数据的深度分析与洞察</p>
      <div class="breadcrumb">
        <a href="dashboard.html">首页</a> / 数据分析
      </div>
    </div>
    
    <!-- 爆品滞销品分析按钮 -->
    <button class="hot-slow-btn" onclick="goToHotSlowAnalysis()">
      <i class="layui-icon layui-icon-fire"></i>
      爆品滞销品分析
    </button>
    <button class="hot-slow-btn" style="background: linear-gradient(135deg, #1E9FFF 0%, #16baaa 100%);" onclick="goToTmallHotSlowAnalysis()">
      <i class="layui-icon layui-icon-cart"></i>
      天猫数据分析
    </button>
    
    <!-- 筛选面板 -->
    <div class="filter-panel">
      <div class="filter-title">🔍 分析筛选</div>
      <form class="layui-form" lay-filter="analysisFilter">
        <div class="layui-row layui-col-space15">
          <div class="layui-col-md3">
            <label class="layui-form-label">时间范围</label>
            <div class="layui-input-block">
              <select name="timeRange">
                <option value="7d">最近7天</option>
                <option value="30d" selected>最近30天</option>
                <option value="90d">最近90天</option>
                <option value="custom">自定义</option>
              </select>
            </div>
          </div>
          <div class="layui-col-md3">
            <label class="layui-form-label">分析维度</label>
            <div class="layui-input-block">
              <select name="dimension">
                <option value="sku">按SKU分析</option>
                <option value="category">按分类分析</option>
                <option value="time">按时间分析</option>
              </select>
            </div>
          </div>
          <div class="layui-col-md3">
            <label class="layui-form-label">数据类型</label>
            <div class="layui-input-block">
              <select name="dataType">
                <option value="all">全部数据</option>
                <option value="stock">仅库存数据</option>
                <option value="sales">仅销售数据</option>
              </select>
            </div>
          </div>
          <div class="layui-col-md3">
            <label class="layui-form-label">操作</label>
            <div class="layui-input-block">
              <button type="button" class="layui-btn layui-btn-normal" onclick="updateAnalysis()">
                <i class="layui-icon layui-icon-search"></i> 更新分析
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- 统计卡片 -->
    <div class="stats-cards">
      <div class="stats-card blue">
        <div class="stats-icon">📦</div>
        <div class="stats-value">1,234</div>
        <div class="stats-label">总SKU数量</div>
        <div class="stats-trend trend-up">↗ +5.2%</div>
      </div>
      <div class="stats-card green">
        <div class="stats-icon">📈</div>
        <div class="stats-value">89.2%</div>
        <div class="stats-label">库存健康率</div>
        <div class="stats-trend trend-up">↗ +2.1%</div>
      </div>
      <div class="stats-card orange">
        <div class="stats-icon">🔄</div>
        <div class="stats-value">24.5</div>
        <div class="stats-label">平均周转率</div>
        <div class="stats-trend trend-down">↘ -1.3%</div>
      </div>
      <div class="stats-card red">
        <div class="stats-icon">⚠️</div>
        <div class="stats-value">12</div>
        <div class="stats-label">库存预警</div>
        <div class="stats-trend trend-down">↘ -4</div>
      </div>
      <div class="stats-card purple">
        <div class="stats-icon">💰</div>
        <div class="stats-value">¥456.7万</div>
        <div class="stats-label">库存价值</div>
        <div class="stats-trend trend-up">↗ +8.9%</div>
      </div>
    </div>

    <!-- 库存趋势图表 -->
    <div class="chart-container">
      <div class="chart-header">
        <h3 class="chart-title">📊 库存趋势分析</h3>
        <div class="chart-controls">
          <button class="layui-btn layui-btn-xs" onclick="exportChart('stock')">
            <i class="layui-icon layui-icon-download-circle"></i> 导出
          </button>
          <button class="layui-btn layui-btn-xs layui-btn-primary" onclick="refreshChart('stock')">
            <i class="layui-icon layui-icon-refresh"></i> 刷新
          </button>
        </div>
      </div>
      <div class="chart-content">
        <div id="stockChart" class="chart"></div>
      </div>
    </div>

    <!-- 销售趋势图表 -->
    <div class="chart-container">
      <div class="chart-header">
        <h3 class="chart-title">📈 销售趋势分析</h3>
        <div class="chart-controls">
          <button class="layui-btn layui-btn-xs" onclick="exportChart('sales')">
            <i class="layui-icon layui-icon-download-circle"></i> 导出
          </button>
          <button class="layui-btn layui-btn-xs layui-btn-primary" onclick="refreshChart('sales')">
            <i class="layui-icon layui-icon-refresh"></i> 刷新
          </button>
        </div>
      </div>
      <div class="chart-content">
        <div id="salesChart" class="chart"></div>
      </div>
    </div>

    <!-- SKU分析表格 -->
    <div class="table-container">
      <div class="table-header">
        <h3>🔍 SKU详细分析</h3>
        <p>显示库存和销售表现最突出的产品</p>
      </div>
      <div style="overflow-x: auto; padding: 20px;">
        <table class="analysis-table">
          <thead>
            <tr>
              <th>排名</th>
              <th>SKU编码</th>
              <th>当前库存</th>
              <th>30天销量</th>
              <th>周转率</th>
              <th>库存状态</th>
              <th>销售趋势</th>
              <th>建议操作</th>
            </tr>
          </thead>
          <tbody>
            <!-- 动态生成 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 上下架管理区域 -->
    <div class="listing-management-container">
      <div class="table-header">
        <h3>📋 商品上下架管理</h3>
        <p>管理商品的上架和下架状态</p>
        <div class="management-controls">
          <button class="layui-btn layui-btn-normal" onclick="showListingCandidates()">
            <i class="layui-icon layui-icon-search"></i> 检查待上架商品
          </button>
          <button class="layui-btn layui-btn-warm" onclick="showDelistingCandidates()">
            <i class="layui-icon layui-icon-close"></i> 检查待下架商品
          </button>
          <button class="layui-btn layui-btn-primary" onclick="refreshListingData()">
            <i class="layui-icon layui-icon-refresh"></i> 刷新数据
          </button>
        </div>
      </div>
      
      <!-- 待上架商品列表 -->
      <div id="listingSection" class="listing-section" style="display: none;">
        <div class="section-header">
          <h4 style="color: #52c41a;">📈 建议上架商品（库存 > 10）</h4>
          <div class="section-controls">
            <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="selectAllListing()">全选</button>
            <button class="layui-btn layui-btn-sm" onclick="clearListingSelection()">取消全选</button>
            <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="confirmListing()">确认上架</button>
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table class="listing-table">
            <thead>
              <tr>
                <th width="60"><input type="checkbox" id="listingSelectAll" onchange="toggleAllListing(this)"></th>
                <th>SKU编码</th>
                <th>产品名称</th>
                <th>当前库存</th>
                <th>最近销量</th>
                <th>下架时间</th>
                <th>网页链接</th>
              </tr>
            </thead>
            <tbody id="listingTableBody">
              <!-- 动态生成 -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 待下架商品列表 -->
      <div id="delistingSection" class="listing-section" style="display: none;">
        <div class="section-header">
          <h4 style="color: #f5222d;">📉 建议下架商品（库存 = 0）</h4>
          <div class="section-controls">
            <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="selectAllDelisting()">全选</button>
            <button class="layui-btn layui-btn-sm" onclick="clearDelistingSelection()">取消全选</button>
            <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="confirmDelisting()">确认下架</button>
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table class="listing-table">
            <thead>
              <tr>
                <th width="60"><input type="checkbox" id="delistingSelectAll" onchange="toggleAllDelisting(this)"></th>
                <th>SKU编码</th>
                <th>产品名称</th>
                <th>当前库存</th>
                <th>最近销量</th>
                <th>缺货天数</th>
                <th>网页链接</th>
              </tr>
            </thead>
            <tbody id="delistingTableBody">
              <!-- 动态生成 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="./src/layui.js"></script>
  <script>
    layui.use(['form', 'layer'], function(){
      var form = layui.form;
      var layer = layui.layer;
      
      var userInfo = JSON.parse(localStorage.getItem('currentUser') || '{}');
      
      // 初始化页面
      initPage();
      
      function initPage() {
        // 检查登录状态
        if (!userInfo.username) {
          layer.msg('请先登录！', {icon: 2}, function(){
            window.location.href = 'login.html';
          });
          return;
        }
        
        // 显示用户信息（可选）
        var cu = document.getElementById('currentUser');
        if (cu) cu.textContent = userInfo.realname || userInfo.username;
        
        // 显示管理员专用导航
        if (userInfo.role === 'admin') {
          document.getElementById('adminOnlyTopNav').style.display = 'block';
        }
        
        // 初始化图表
        initCharts();
        
        // 显示加载完成消息
        setTimeout(function(){
          layer.msg('数据分析加载完成！', {icon: 1, time: 2000});
        }, 1000);
        
        // 响应式处理
        window.addEventListener('resize', function() {
          if (window.stockChartInstance) {
            window.stockChartInstance.resize();
          }
          if (window.salesChartInstance) {
            window.salesChartInstance.resize();
          }
        });
      }
      
      function initCharts() {
        // 加载统计数据
        loadAnalysisData();
        
        // 库存趋势图表
        var stockChart = echarts.init(document.getElementById('stockChart'));
        window.stockChartInstance = stockChart;
        
        // 销售趋势图表
        var salesChart = echarts.init(document.getElementById('salesChart'));
        window.salesChartInstance = salesChart;
      }
      
      // 加载分析数据
      function loadAnalysisData() {
        const token = localStorage.getItem('token');
        if (!token) {
          layer.msg('请先登录！', {icon: 2}, function(){
            window.location.href = 'login.html';
          });
          return;
        }
        
        // 加载统计概览
        fetch(window.apiConfig.baseURL + '/api/analytics/sales', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateStatsCards(data.data);
          }
        })
        .catch(error => {
          console.error('加载统计数据失败:', error);
        });
        
        // 加载库存趋势
        fetch(window.apiConfig.baseURL + '/api/analytics/trends', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderStockChart(data.data);
          }
        })
        .catch(error => {
          console.error('加载库存趋势失败:', error);
        });
        
        // 加载销售趋势
        fetch(window.apiConfig.baseURL + '/api/inventory/data', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderSalesChart(data.data);
          }
        })
        .catch(error => {
          console.error('加载销售趋势失败:', error);
        });
        
        // 加载SKU详细分析
        fetch(window.apiConfig.baseURL + '/api/inventory/summary', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderSkuTable(data.data);
          }
        })
        .catch(error => {
          console.error('加载SKU分析失败:', error);
        });
      }
      
      // 更新统计卡片
      function updateStatsCards(data) {
        const cards = document.querySelectorAll('.stats-card');
        if (cards.length >= 5) {
          // 总SKU数
          cards[0].querySelector('.stats-value').textContent = data.totalSku || 0;
          // 库存健康率
          cards[1].querySelector('.stats-value').textContent = (data.healthRate || 0) + '%';
          // 平均周转率
          cards[2].querySelector('.stats-value').textContent = data.avgTurnover || 0;
          // 库存预警
          cards[3].querySelector('.stats-value').textContent = data.warningCount || 0;
          // 库存价值（移除金额显示，改为记录总数）
          cards[4].querySelector('.stats-value').textContent = data.totalRecords || 0;
          cards[4].querySelector('.stats-label').textContent = '历史记录';
        }
      }
      
      // 渲染库存趋势图表
      function renderStockChart(data) {
        const stockOption = {
          title: {
            text: '库存趋势变化',
            left: 'center',
            textStyle: { fontSize: 16, color: '#333' }
          },
          tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255,255,255,0.9)',
            borderColor: '#ddd',
            textStyle: { color: '#333' }
          },
          legend: {
            data: ['总库存', '正常库存', '预警库存', '缺货SKU'],
            bottom: 10
          },
          grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
          },
          xAxis: {
            type: 'category',
            boundaryGap: false,
            data: data.dates || []
          },
          yAxis: {
            type: 'value',
            name: '数量'
          },
          series: [
            {
              name: '总库存',
              type: 'line',
              data: data.series.total || [],
              itemStyle: { color: '#16baaa' },
              smooth: true
            },
            {
              name: '正常库存',
              type: 'line',
              data: data.series.healthy || [],
              itemStyle: { color: '#52c41a' },
              smooth: true
            },
            {
              name: '预警库存',
              type: 'line',
              data: data.series.warning || [],
              itemStyle: { color: '#fa8c16' },
              smooth: true
            },
            {
              name: '缺货SKU',
              type: 'line',
              data: data.series.outOfStock || [],
              itemStyle: { color: '#f5222d' },
              smooth: true
            }
          ]
        };
        window.stockChartInstance.setOption(stockOption);
      }
      
      // 渲染销售趋势图表
      function renderSalesChart(data) {
        const salesOption = {
          title: {
            text: '销售趋势分析',
            left: 'center',
            textStyle: { fontSize: 16, color: '#333' }
          },
          tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255,255,255,0.9)',
            borderColor: '#ddd',
            textStyle: { color: '#333' }
          },
          legend: {
            data: ['销售数量'],
            bottom: 10
          },
          grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
          },
          xAxis: {
            type: 'category',
            data: data.dates || []
          },
          yAxis: {
            type: 'value',
            name: '数量'
          },
          series: [
            {
              name: '销售数量',
              type: 'bar',
              data: data.series.quantity || [],
              itemStyle: { color: '#16baaa' }
            }
          ]
        };
        window.salesChartInstance.setOption(salesOption);
      }
      
      // 渲染SKU分析表格
      function renderSkuTable(data) {
        const tbody = document.querySelector('.analysis-table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = data.map((item, index) => {
          const statusColor = getStatusColor(item.status);
          const trendColor = getTrendColor(item.trend);
          const skuClass = item.status === 'offline' ? 'style="color: #f5222d; font-weight: bold;"' : '';
          
          return `
            <tr>
              <td>${index + 1}</td>
              <td ${skuClass}>${item.sku}</td>
              <td>${item.currentStock}</td>
              <td>${item.totalSales}</td>
              <td>${item.turnover}</td>
              <td><span style="color: ${statusColor};">${getStatusText(item.status)}</span></td>
              <td><span style="color: ${trendColor};">${getTrendText(item.trend)}</span></td>
              <td>${item.suggestion}</td>
            </tr>
          `;
        }).join('');
      }
      
      // 获取状态颜色
      function getStatusColor(status) {
        switch(status) {
          case 'healthy': return '#52c41a';
          case 'warning': return '#fa8c16';
          case 'outOfStock': return '#f5222d';
          case 'offline': return '#f5222d';
          default: return '#666';
        }
      }
      
      // 获取状态文本
      function getStatusText(status) {
        switch(status) {
          case 'healthy': return '正常';
          case 'warning': return '预警';
          case 'outOfStock': return '缺货';
          case 'offline': return '已下架';
          default: return '未知';
        }
      }
      
      // 获取趋势颜色
      function getTrendColor(trend) {
        switch(trend) {
          case 'up': return '#52c41a';
          case 'down': return '#f5222d';
          case 'stable': return '#fa8c16';
          default: return '#666';
        }
      }
      
      // 获取趋势文本
      function getTrendText(trend) {
        switch(trend) {
          case 'up': return '↗ 上升';
          case 'down': return '↘ 下降';
          case 'stable': return '→ 平稳';
          default: return '→ 平稳';
        }
      }
      
      // 更新分析
      window.updateAnalysis = function() {
        layer.msg('正在更新分析数据...', {icon: 16, time: 1000});
        loadAnalysisData();
        setTimeout(function() {
          layer.msg('分析数据更新完成！', {icon: 1});
        }, 1000);
      };
      
      // 导出图表
      window.exportChart = function(type) {
        var chart = type === 'stock' ? window.stockChartInstance : window.salesChartInstance;
        var url = chart.getDataURL({
          type: 'png',
          backgroundColor: '#fff'
        });
        
        var link = document.createElement('a');
        link.href = url;
        link.download = (type === 'stock' ? '库存趋势' : '销售趋势') + '_' + new Date().getTime() + '.png';
        link.click();
        
        layer.msg('图表导出成功！', {icon: 1});
      };
      
      // 刷新图表
      window.refreshChart = function(type) {
        layer.msg('正在刷新图表数据...', {icon: 16, time: 1500});
        
        setTimeout(function() {
          if (type === 'stock') {
            window.stockChartInstance.resize();
          } else {
            window.salesChartInstance.resize();
          }
          layer.msg('图表刷新完成！', {icon: 1});
        }, 1500);
      };
    });
    
    // 退出登录
    function logout() {
      layer.confirm('确定要退出登录吗？', {icon: 3, title: '提示'}, function(index){
        localStorage.removeItem('currentUser');
        layer.close(index);
        layer.msg('已安全退出！', {icon: 1}, function(){
          window.location.href = 'login.html';
        });
      });
    }
    
    // 切换账户
    function switchAccount() {
      layer.confirm('切换账户将退出当前登录，是否继续？', {
        icon: 3, 
        title: '切换账户',
        btn: ['确定', '取消']
      }, function(index) {
        localStorage.removeItem('currentUser');
        layer.close(index);
        layer.msg('正在切换账户...', {icon: 16, time: 1000}, function(){
          window.location.href = 'login.html';
        });
      });
    }
    
    // 跳转到爆品滞销品分析页面
    function goToHotSlowAnalysis() {
      window.location.href = 'hot-slow-analysis.html';
    }

    // 跳转到天猫数据分析页面
    function goToTmallHotSlowAnalysis() {
      window.location.href = 'tmall-hot-slow-analysis.html';
    }
    
    // ============= 上下架管理功能 =============
    
    // 显示待上架商品
    window.showListingCandidates = function() {
      document.getElementById('delistingSection').style.display = 'none';
      const listingSection = document.getElementById('listingSection');
      listingSection.style.display = 'block';
      loadListingCandidates();
    };
    
    // 显示待下架商品
    window.showDelistingCandidates = function() {
      document.getElementById('listingSection').style.display = 'none';
      const delistingSection = document.getElementById('delistingSection');
      delistingSection.style.display = 'block';
      loadDelistingCandidates();
    };
    
    // 刷新上下架数据
    window.refreshListingData = function() {
      layer.msg('正在刷新数据...', {icon: 16, time: 1000});
      const listingSection = document.getElementById('listingSection');
      const delistingSection = document.getElementById('delistingSection');
      
      if (listingSection.style.display === 'block') {
        loadListingCandidates();
      }
      if (delistingSection.style.display === 'block') {
        loadDelistingCandidates();
      }
      
      setTimeout(() => {
        layer.msg('数据刷新完成！', {icon: 1});
      }, 1000);
    };
    
    // 加载待上架商品
    function loadListingCandidates() {
      const token = localStorage.getItem('token');
      if (!token) return;
      
      fetch('/api/listing/candidates', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderListingTable(data.data);
        } else {
          layer.msg('加载待上架商品失败: ' + data.error, {icon: 2});
        }
      })
      .catch(error => {
        console.error('加载待上架商品失败:', error);
        layer.msg('加载失败', {icon: 2});
      });
    }
    
    // 加载待下架商品
    function loadDelistingCandidates() {
      const token = localStorage.getItem('token');
      if (!token) return;
      
      fetch('/api/delisting/candidates', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderDelistingTable(data.data);
        } else {
          layer.msg('加载待下架商品失败: ' + data.error, {icon: 2});
        }
      })
      .catch(error => {
        console.error('加载待下架商品失败:', error);
        layer.msg('加载失败', {icon: 2});
      });
    }
    
    // 渲染上架表格
    function renderListingTable(data) {
      const tbody = document.getElementById('listingTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = data.map(item => `
        <tr>
          <td><input type="checkbox" name="listingSku" value="${item.sku}"></td>
          <td class="sku-cell">${item.sku}</td>
          <td>${item.name || '未知商品'}</td>
          <td><span style="color: #52c41a; font-weight: bold;">${item.currentStock}</span></td>
          <td>${item.totalSales || 0}</td>
          <td>${item.delistedDate || '未知'}</td>
          <td class="url-cell">
            ${item.url ? `<a href="${item.url}" target="_blank">查看商品</a>` : '无链接'}
          </td>
        </tr>
      `).join('');
    }
    
    // 渲染下架表格
    function renderDelistingTable(data) {
      const tbody = document.getElementById('delistingTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = data.map(item => `
        <tr>
          <td><input type="checkbox" name="delistingSku" value="${item.sku}"></td>
          <td class="sku-cell">${item.sku}</td>
          <td>${item.name || '未知商品'}</td>
          <td><span style="color: #f5222d; font-weight: bold;">${item.currentStock}</span></td>
          <td>${item.totalSales || 0}</td>
          <td>${item.outOfStockDays || 0} 天</td>
          <td class="url-cell">
            ${item.url ? `<a href="${item.url}" target="_blank">查看商品</a>` : '无链接'}
          </td>
        </tr>
      `).join('');
    }
    
    // 全选/取消全选 - 上架
    window.toggleAllListing = function(checkbox) {
      const checkboxes = document.querySelectorAll('input[name="listingSku"]');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
    };
    
    window.selectAllListing = function() {
      document.getElementById('listingSelectAll').checked = true;
      toggleAllListing(document.getElementById('listingSelectAll'));
    };
    
    window.clearListingSelection = function() {
      document.getElementById('listingSelectAll').checked = false;
      toggleAllListing(document.getElementById('listingSelectAll'));
    };
    
    // 全选/取消全选 - 下架
    window.toggleAllDelisting = function(checkbox) {
      const checkboxes = document.querySelectorAll('input[name="delistingSku"]');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
    };
    
    window.selectAllDelisting = function() {
      document.getElementById('delistingSelectAll').checked = true;
      toggleAllDelisting(document.getElementById('delistingSelectAll'));
    };
    
    window.clearDelistingSelection = function() {
      document.getElementById('delistingSelectAll').checked = false;
      toggleAllDelisting(document.getElementById('delistingSelectAll'));
    };
    
    // 确认上架
    window.confirmListing = function() {
      const selectedSkus = Array.from(document.querySelectorAll('input[name="listingSku"]:checked'))
        .map(cb => cb.value);
      
      if (selectedSkus.length === 0) {
        layer.msg('请选择要上架的商品', {icon: 2});
        return;
      }
      
      layer.confirm(`确定要上架选中的 ${selectedSkus.length} 个商品吗？`, {
        icon: 3,
        title: '确认上架'
      }, function(index) {
        const token = localStorage.getItem('token');
        fetch('/api/listing/confirm', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ skus: selectedSkus })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            layer.msg(`成功上架 ${data.count} 个商品！`, {icon: 1});
            loadListingCandidates(); // 重新加载
            loadAnalysisData(); // 刷新分析数据
          } else {
            layer.msg('上架失败: ' + data.error, {icon: 2});
          }
        })
        .catch(error => {
          console.error('上架失败:', error);
          layer.msg('上架失败', {icon: 2});
        });
        layer.close(index);
      });
    };
    
    // 确认下架
    window.confirmDelisting = function() {
      const selectedSkus = Array.from(document.querySelectorAll('input[name="delistingSku"]:checked'))
        .map(cb => cb.value);
      
      if (selectedSkus.length === 0) {
        layer.msg('请选择要下架的商品', {icon: 2});
        return;
      }
      
      layer.confirm(`确定要下架选中的 ${selectedSkus.length} 个商品吗？`, {
        icon: 3,
        title: '确认下架'
      }, function(index) {
        const token = localStorage.getItem('token');
        fetch('/api/delisting/confirm', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ skus: selectedSkus })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            layer.msg(`成功下架 ${data.count} 个商品！`, {icon: 1});
            loadDelistingCandidates(); // 重新加载
            loadAnalysisData(); // 刷新分析数据
          } else {
            layer.msg('下架失败: ' + data.error, {icon: 2});
          }
        })
        .catch(error => {
          console.error('下架失败:', error);
          layer.msg('下架失败', {icon: 2});
        });
        layer.close(index);
      });
    };
  </script>
</body>
</html> 