<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æ•°æ®åˆ†æ - æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="./src/css/layui.css" rel="stylesheet">
  <link href="./src/css/app-header.css" rel="stylesheet">
  <script src="./api-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    body {
      background: #f8f9fa;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header .layui-nav {
      background: transparent;
    }
    .header .layui-nav .layui-nav-item a {
      color: rgba(255,255,255,0.9);
    }
    .header .layui-nav .layui-nav-item a:hover {
      color: white;
    }
    .header .logo {
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
    }
    
    /* ä¸»å¯¼èˆªæ ·å¼ */
    .main-nav {
      flex: 1;
      display: flex;
      justify-content: center;
      margin: 0 20px;
    }
    .main-nav .layui-nav-item {
      margin: 0 5px;
    }
    .main-nav .layui-nav-item a {
      padding: 0 20px;
      border-radius: 6px;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .main-nav .layui-nav-item a:hover,
    .main-nav .layui-nav-item.layui-this a {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    .main-nav .layui-nav-item a i {
      margin-right: 6px;
    }
    
    .header .user-info {
      white-space: nowrap;
    }
    
    /* ç”¨æˆ·ä¸‹æ‹‰èœå•æ ·å¼ */
    .user-info .layui-nav-child dd a {
      padding: 10px 15px;
      color: #666;
      transition: all 0.3s ease;
    }
    .user-info .layui-nav-child dd a:hover {
      background: #f8f9fa;
      color: #16baaa;
    }
    .user-info .layui-nav-child dd a i {
      margin-right: 8px;
      font-size: 14px;
    }
    
    .content-wrapper {
      padding: 20px;
    }
    
    .page-header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .page-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin: 0;
    }
    .page-subtitle {
      color: #666;
      margin-top: 5px;
    }
    .breadcrumb {
      color: #999;
      font-size: 14px;
      margin-top: 10px;
    }
    .breadcrumb a {
      color: #16baaa;
      text-decoration: none;
    }
    
    .filter-panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .filter-title {
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }
    
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .stats-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .stats-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
    }
    .stats-card.blue::before { background: #16baaa; }
    .stats-card.green::before { background: #52c41a; }
    .stats-card.orange::before { background: #fa8c16; }
    .stats-card.red::before { background: #f5222d; }
    .stats-card.purple::before { background: #722ed1; }
    
    .stats-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .stats-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .stats-label {
      color: #666;
      font-size: 14px;
    }
    .stats-trend {
      font-size: 12px;
      margin-top: 5px;
    }
    .trend-up { color: #52c41a; }
    .trend-down { color: #f5222d; }
    
    .chart-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .chart-header {
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
      background: #fafafa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chart-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin: 0;
    }
    .chart-controls {
      display: flex;
      gap: 10px;
    }
    .chart-content {
      padding: 20px;
    }
    .chart {
      width: 100%;
      height: 400px;
    }
    
    .table-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .table-header {
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
      background: #fafafa;
    }
    .analysis-table {
      width: 100%;
      font-size: 13px;
    }
    .analysis-table th {
      background: #f8f9fa;
      font-weight: bold;
      text-align: center;
      padding: 12px 8px;
      border-bottom: 1px solid #e6e6e6;
    }
    .analysis-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f0f0f0;
      text-align: center;
    }
    .analysis-table tbody tr:hover {
      background: #f8f9fa;
    }
    
    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    .no-data-icon {
      font-size: 48px;
      margin-bottom: 15px;
      display: block;
    }
    
    /* æ–°å¢ï¼šçˆ†å“æ»é”€å“åˆ†ææŒ‰é’® */
    .hot-slow-btn {
      background: linear-gradient(135deg, #FF5722 0%, #FF9800 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .hot-slow-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
    }
    
    /* ä¸Šä¸‹æ¶ç®¡ç†æ ·å¼ */
    .listing-management-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    
    .management-controls {
      margin-top: 15px;
      text-align: right;
    }
    
    .management-controls .layui-btn {
      margin-left: 10px;
    }
    
    .listing-section {
      background: #fafafa;
      border-radius: 8px;
      margin-top: 20px;
      padding: 15px;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e8e8e8;
    }
    
    .section-header h4 {
      margin: 0;
      font-size: 16px;
    }
    
    .section-controls .layui-btn {
      margin-left: 8px;
    }
    
    .listing-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .listing-table th,
    .listing-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .listing-table th {
      background: #f8f9fa;
      font-weight: bold;
      color: #333;
    }
    
    .listing-table tbody tr:hover {
      background: #f5f5f5;
    }
    
    .listing-table .sku-cell {
      font-family: 'Courier New', monospace;
      font-weight: bold;
    }
    
    .listing-table .url-cell {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .listing-table .url-cell a {
      color: #16baaa;
      text-decoration: none;
    }
    
    .listing-table .url-cell a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="layui-header header">
    <div class="logo">
      ğŸ“Š æ•°æ®ç®¡ç†ç³»ç»Ÿ
    </div>

    <!-- ä¸»å¯¼èˆªæŒ‰é’® -->
    <ul class="layui-nav main-nav">
      <li class="layui-nav-item">
        <a href="dashboard.html">
          <i class="layui-icon layui-icon-home"></i> æ•°æ®ä»ªè¡¨ç›˜
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="table-management.html">
          <i class="layui-icon layui-icon-table"></i> è¡¨æ ¼ç®¡ç†
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="data-upload.html">
          <i class="layui-icon layui-icon-upload-drag"></i> æ•°æ®å¯¼å…¥
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="virtual-inventory.html">
          <i class="layui-icon layui-icon-engine"></i> è™šæ‹Ÿåº“å­˜
        </a>
      </li>
      <li class="layui-nav-item layui-this">
        <a href="data-analysis.html">
          <i class="layui-icon layui-icon-chart"></i> æ•°æ®åˆ†æ
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="local-database.html">
          <i class="layui-icon layui-icon-database"></i> æœ¬åœ°æ•°æ®åº“
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="tmall-database.html">
          <i class="layui-icon layui-icon-cart"></i> å¤©çŒ«æ•°æ®åº“
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="tmall-order.html">
          <i class="layui-icon layui-icon-list"></i> å¤©çŒ«è®¢å•
        </a>
      </li>
      <li class="layui-nav-item" id="adminOnlyTopNav" style="display: none;">
        <a href="user-management.html">
          <i class="layui-icon layui-icon-username"></i> ç”¨æˆ·ç®¡ç†
        </a>
      </li>
    </ul>
    
    
  </div>
  
  <div class="content-wrapper">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
      <h1 class="page-title">ğŸ“ˆ æ•°æ®åˆ†æ</h1>
      <p class="page-subtitle">åº“å­˜å’Œé”€å”®æ•°æ®çš„æ·±åº¦åˆ†æä¸æ´å¯Ÿ</p>
      <div class="breadcrumb">
        <a href="dashboard.html">é¦–é¡µ</a> / æ•°æ®åˆ†æ
      </div>
    </div>
    
    <!-- çˆ†å“æ»é”€å“åˆ†ææŒ‰é’® -->
    <button class="hot-slow-btn" onclick="goToHotSlowAnalysis()">
      <i class="layui-icon layui-icon-fire"></i>
      çˆ†å“æ»é”€å“åˆ†æ
    </button>
    <button class="hot-slow-btn" style="background: linear-gradient(135deg, #1E9FFF 0%, #16baaa 100%);" onclick="goToTmallHotSlowAnalysis()">
      <i class="layui-icon layui-icon-cart"></i>
      å¤©çŒ«æ•°æ®åˆ†æ
    </button>
    
    <!-- ç­›é€‰é¢æ¿ -->
    <div class="filter-panel">
      <div class="filter-title">ğŸ” åˆ†æç­›é€‰</div>
      <form class="layui-form" lay-filter="analysisFilter">
        <div class="layui-row layui-col-space15">
          <div class="layui-col-md3">
            <label class="layui-form-label">æ—¶é—´èŒƒå›´</label>
            <div class="layui-input-block">
              <select name="timeRange">
                <option value="7d">æœ€è¿‘7å¤©</option>
                <option value="30d" selected>æœ€è¿‘30å¤©</option>
                <option value="90d">æœ€è¿‘90å¤©</option>
                <option value="custom">è‡ªå®šä¹‰</option>
              </select>
            </div>
          </div>
          <div class="layui-col-md3">
            <label class="layui-form-label">åˆ†æç»´åº¦</label>
            <div class="layui-input-block">
              <select name="dimension">
                <option value="sku">æŒ‰SKUåˆ†æ</option>
                <option value="category">æŒ‰åˆ†ç±»åˆ†æ</option>
                <option value="time">æŒ‰æ—¶é—´åˆ†æ</option>
              </select>
            </div>
          </div>
          <div class="layui-col-md3">
            <label class="layui-form-label">æ•°æ®ç±»å‹</label>
            <div class="layui-input-block">
              <select name="dataType">
                <option value="all">å…¨éƒ¨æ•°æ®</option>
                <option value="stock">ä»…åº“å­˜æ•°æ®</option>
                <option value="sales">ä»…é”€å”®æ•°æ®</option>
              </select>
            </div>
          </div>
          <div class="layui-col-md3">
            <label class="layui-form-label">æ“ä½œ</label>
            <div class="layui-input-block">
              <button type="button" class="layui-btn layui-btn-normal" onclick="updateAnalysis()">
                <i class="layui-icon layui-icon-search"></i> æ›´æ–°åˆ†æ
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-cards">
      <div class="stats-card blue">
        <div class="stats-icon">ğŸ“¦</div>
        <div class="stats-value">1,234</div>
        <div class="stats-label">æ€»SKUæ•°é‡</div>
        <div class="stats-trend trend-up">â†— +5.2%</div>
      </div>
      <div class="stats-card green">
        <div class="stats-icon">ğŸ“ˆ</div>
        <div class="stats-value">89.2%</div>
        <div class="stats-label">åº“å­˜å¥åº·ç‡</div>
        <div class="stats-trend trend-up">â†— +2.1%</div>
      </div>
      <div class="stats-card orange">
        <div class="stats-icon">ğŸ”„</div>
        <div class="stats-value">24.5</div>
        <div class="stats-label">å¹³å‡å‘¨è½¬ç‡</div>
        <div class="stats-trend trend-down">â†˜ -1.3%</div>
      </div>
      <div class="stats-card red">
        <div class="stats-icon">âš ï¸</div>
        <div class="stats-value">12</div>
        <div class="stats-label">åº“å­˜é¢„è­¦</div>
        <div class="stats-trend trend-down">â†˜ -4</div>
      </div>
      <div class="stats-card purple">
        <div class="stats-icon">ğŸ’°</div>
        <div class="stats-value">Â¥456.7ä¸‡</div>
        <div class="stats-label">åº“å­˜ä»·å€¼</div>
        <div class="stats-trend trend-up">â†— +8.9%</div>
      </div>
    </div>

    <!-- åº“å­˜è¶‹åŠ¿å›¾è¡¨ -->
    <div class="chart-container">
      <div class="chart-header">
        <h3 class="chart-title">ğŸ“Š åº“å­˜è¶‹åŠ¿åˆ†æ</h3>
        <div class="chart-controls">
          <button class="layui-btn layui-btn-xs" onclick="exportChart('stock')">
            <i class="layui-icon layui-icon-download-circle"></i> å¯¼å‡º
          </button>
          <button class="layui-btn layui-btn-xs layui-btn-primary" onclick="refreshChart('stock')">
            <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°
          </button>
        </div>
      </div>
      <div class="chart-content">
        <div id="stockChart" class="chart"></div>
      </div>
    </div>

    <!-- é”€å”®è¶‹åŠ¿å›¾è¡¨ -->
    <div class="chart-container">
      <div class="chart-header">
        <h3 class="chart-title">ğŸ“ˆ é”€å”®è¶‹åŠ¿åˆ†æ</h3>
        <div class="chart-controls">
          <button class="layui-btn layui-btn-xs" onclick="exportChart('sales')">
            <i class="layui-icon layui-icon-download-circle"></i> å¯¼å‡º
          </button>
          <button class="layui-btn layui-btn-xs layui-btn-primary" onclick="refreshChart('sales')">
            <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°
          </button>
        </div>
      </div>
      <div class="chart-content">
        <div id="salesChart" class="chart"></div>
      </div>
    </div>

    <!-- SKUåˆ†æè¡¨æ ¼ -->
    <div class="table-container">
      <div class="table-header">
        <h3>ğŸ” SKUè¯¦ç»†åˆ†æ</h3>
        <p>æ˜¾ç¤ºåº“å­˜å’Œé”€å”®è¡¨ç°æœ€çªå‡ºçš„äº§å“</p>
      </div>
      <div style="overflow-x: auto; padding: 20px;">
        <table class="analysis-table">
          <thead>
            <tr>
              <th>æ’å</th>
              <th>SKUç¼–ç </th>
              <th>å½“å‰åº“å­˜</th>
              <th>30å¤©é”€é‡</th>
              <th>å‘¨è½¬ç‡</th>
              <th>åº“å­˜çŠ¶æ€</th>
              <th>é”€å”®è¶‹åŠ¿</th>
              <th>å»ºè®®æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ä¸Šä¸‹æ¶ç®¡ç†åŒºåŸŸ -->
    <div class="listing-management-container">
      <div class="table-header">
        <h3>ğŸ“‹ å•†å“ä¸Šä¸‹æ¶ç®¡ç†</h3>
        <p>ç®¡ç†å•†å“çš„ä¸Šæ¶å’Œä¸‹æ¶çŠ¶æ€</p>
        <div class="management-controls">
          <button class="layui-btn layui-btn-normal" onclick="showListingCandidates()">
            <i class="layui-icon layui-icon-search"></i> æ£€æŸ¥å¾…ä¸Šæ¶å•†å“
          </button>
          <button class="layui-btn layui-btn-warm" onclick="showDelistingCandidates()">
            <i class="layui-icon layui-icon-close"></i> æ£€æŸ¥å¾…ä¸‹æ¶å•†å“
          </button>
          <button class="layui-btn layui-btn-primary" onclick="refreshListingData()">
            <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°æ•°æ®
          </button>
        </div>
      </div>
      
      <!-- å¾…ä¸Šæ¶å•†å“åˆ—è¡¨ -->
      <div id="listingSection" class="listing-section" style="display: none;">
        <div class="section-header">
          <h4 style="color: #52c41a;">ğŸ“ˆ å»ºè®®ä¸Šæ¶å•†å“ï¼ˆåº“å­˜ > 10ï¼‰</h4>
          <div class="section-controls">
            <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="selectAllListing()">å…¨é€‰</button>
            <button class="layui-btn layui-btn-sm" onclick="clearListingSelection()">å–æ¶ˆå…¨é€‰</button>
            <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="confirmListing()">ç¡®è®¤ä¸Šæ¶</button>
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table class="listing-table">
            <thead>
              <tr>
                <th width="60"><input type="checkbox" id="listingSelectAll" onchange="toggleAllListing(this)"></th>
                <th>SKUç¼–ç </th>
                <th>äº§å“åç§°</th>
                <th>å½“å‰åº“å­˜</th>
                <th>æœ€è¿‘é”€é‡</th>
                <th>ä¸‹æ¶æ—¶é—´</th>
                <th>ç½‘é¡µé“¾æ¥</th>
              </tr>
            </thead>
            <tbody id="listingTableBody">
              <!-- åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- å¾…ä¸‹æ¶å•†å“åˆ—è¡¨ -->
      <div id="delistingSection" class="listing-section" style="display: none;">
        <div class="section-header">
          <h4 style="color: #f5222d;">ğŸ“‰ å»ºè®®ä¸‹æ¶å•†å“ï¼ˆåº“å­˜ = 0ï¼‰</h4>
          <div class="section-controls">
            <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="selectAllDelisting()">å…¨é€‰</button>
            <button class="layui-btn layui-btn-sm" onclick="clearDelistingSelection()">å–æ¶ˆå…¨é€‰</button>
            <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="confirmDelisting()">ç¡®è®¤ä¸‹æ¶</button>
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table class="listing-table">
            <thead>
              <tr>
                <th width="60"><input type="checkbox" id="delistingSelectAll" onchange="toggleAllDelisting(this)"></th>
                <th>SKUç¼–ç </th>
                <th>äº§å“åç§°</th>
                <th>å½“å‰åº“å­˜</th>
                <th>æœ€è¿‘é”€é‡</th>
                <th>ç¼ºè´§å¤©æ•°</th>
                <th>ç½‘é¡µé“¾æ¥</th>
              </tr>
            </thead>
            <tbody id="delistingTableBody">
              <!-- åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="./src/layui.js"></script>
  <script>
    layui.use(['form', 'layer'], function(){
      var form = layui.form;
      var layer = layui.layer;
      
      var userInfo = JSON.parse(localStorage.getItem('currentUser') || '{}');
      
      // åˆå§‹åŒ–é¡µé¢
      initPage();
      
      function initPage() {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!userInfo.username) {
          layer.msg('è¯·å…ˆç™»å½•ï¼', {icon: 2}, function(){
            window.location.href = 'login.html';
          });
          return;
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
        var cu = document.getElementById('currentUser');
        if (cu) cu.textContent = userInfo.realname || userInfo.username;
        
        // æ˜¾ç¤ºç®¡ç†å‘˜ä¸“ç”¨å¯¼èˆª
        if (userInfo.role === 'admin') {
          document.getElementById('adminOnlyTopNav').style.display = 'block';
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        initCharts();
        
        // æ˜¾ç¤ºåŠ è½½å®Œæˆæ¶ˆæ¯
        setTimeout(function(){
          layer.msg('æ•°æ®åˆ†æåŠ è½½å®Œæˆï¼', {icon: 1, time: 2000});
        }, 1000);
        
        // å“åº”å¼å¤„ç†
        window.addEventListener('resize', function() {
          if (window.stockChartInstance) {
            window.stockChartInstance.resize();
          }
          if (window.salesChartInstance) {
            window.salesChartInstance.resize();
          }
        });
      }
      
      function initCharts() {
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        loadAnalysisData();
        
        // åº“å­˜è¶‹åŠ¿å›¾è¡¨
        var stockChart = echarts.init(document.getElementById('stockChart'));
        window.stockChartInstance = stockChart;
        
        // é”€å”®è¶‹åŠ¿å›¾è¡¨
        var salesChart = echarts.init(document.getElementById('salesChart'));
        window.salesChartInstance = salesChart;
      }
      
      // åŠ è½½åˆ†ææ•°æ®
      function loadAnalysisData() {
        const token = localStorage.getItem('token');
        if (!token) {
          layer.msg('è¯·å…ˆç™»å½•ï¼', {icon: 2}, function(){
            window.location.href = 'login.html';
          });
          return;
        }
        
        // åŠ è½½ç»Ÿè®¡æ¦‚è§ˆ
        fetch(window.apiConfig.baseURL + '/api/analytics/sales', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateStatsCards(data.data);
          }
        })
        .catch(error => {
          console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        });
        
        // åŠ è½½åº“å­˜è¶‹åŠ¿
        fetch(window.apiConfig.baseURL + '/api/analytics/trends', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderStockChart(data.data);
          }
        })
        .catch(error => {
          console.error('åŠ è½½åº“å­˜è¶‹åŠ¿å¤±è´¥:', error);
        });
        
        // åŠ è½½é”€å”®è¶‹åŠ¿
        fetch(window.apiConfig.baseURL + '/api/inventory/data', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderSalesChart(data.data);
          }
        })
        .catch(error => {
          console.error('åŠ è½½é”€å”®è¶‹åŠ¿å¤±è´¥:', error);
        });
        
        // åŠ è½½SKUè¯¦ç»†åˆ†æ
        fetch(window.apiConfig.baseURL + '/api/inventory/summary', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderSkuTable(data.data);
          }
        })
        .catch(error => {
          console.error('åŠ è½½SKUåˆ†æå¤±è´¥:', error);
        });
      }
      
      // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
      function updateStatsCards(data) {
        const cards = document.querySelectorAll('.stats-card');
        if (cards.length >= 5) {
          // æ€»SKUæ•°
          cards[0].querySelector('.stats-value').textContent = data.totalSku || 0;
          // åº“å­˜å¥åº·ç‡
          cards[1].querySelector('.stats-value').textContent = (data.healthRate || 0) + '%';
          // å¹³å‡å‘¨è½¬ç‡
          cards[2].querySelector('.stats-value').textContent = data.avgTurnover || 0;
          // åº“å­˜é¢„è­¦
          cards[3].querySelector('.stats-value').textContent = data.warningCount || 0;
          // åº“å­˜ä»·å€¼ï¼ˆç§»é™¤é‡‘é¢æ˜¾ç¤ºï¼Œæ”¹ä¸ºè®°å½•æ€»æ•°ï¼‰
          cards[4].querySelector('.stats-value').textContent = data.totalRecords || 0;
          cards[4].querySelector('.stats-label').textContent = 'å†å²è®°å½•';
        }
      }
      
      // æ¸²æŸ“åº“å­˜è¶‹åŠ¿å›¾è¡¨
      function renderStockChart(data) {
        const stockOption = {
          title: {
            text: 'åº“å­˜è¶‹åŠ¿å˜åŒ–',
            left: 'center',
            textStyle: { fontSize: 16, color: '#333' }
          },
          tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255,255,255,0.9)',
            borderColor: '#ddd',
            textStyle: { color: '#333' }
          },
          legend: {
            data: ['æ€»åº“å­˜', 'æ­£å¸¸åº“å­˜', 'é¢„è­¦åº“å­˜', 'ç¼ºè´§SKU'],
            bottom: 10
          },
          grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
          },
          xAxis: {
            type: 'category',
            boundaryGap: false,
            data: data.dates || []
          },
          yAxis: {
            type: 'value',
            name: 'æ•°é‡'
          },
          series: [
            {
              name: 'æ€»åº“å­˜',
              type: 'line',
              data: data.series.total || [],
              itemStyle: { color: '#16baaa' },
              smooth: true
            },
            {
              name: 'æ­£å¸¸åº“å­˜',
              type: 'line',
              data: data.series.healthy || [],
              itemStyle: { color: '#52c41a' },
              smooth: true
            },
            {
              name: 'é¢„è­¦åº“å­˜',
              type: 'line',
              data: data.series.warning || [],
              itemStyle: { color: '#fa8c16' },
              smooth: true
            },
            {
              name: 'ç¼ºè´§SKU',
              type: 'line',
              data: data.series.outOfStock || [],
              itemStyle: { color: '#f5222d' },
              smooth: true
            }
          ]
        };
        window.stockChartInstance.setOption(stockOption);
      }
      
      // æ¸²æŸ“é”€å”®è¶‹åŠ¿å›¾è¡¨
      function renderSalesChart(data) {
        const salesOption = {
          title: {
            text: 'é”€å”®è¶‹åŠ¿åˆ†æ',
            left: 'center',
            textStyle: { fontSize: 16, color: '#333' }
          },
          tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255,255,255,0.9)',
            borderColor: '#ddd',
            textStyle: { color: '#333' }
          },
          legend: {
            data: ['é”€å”®æ•°é‡'],
            bottom: 10
          },
          grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
          },
          xAxis: {
            type: 'category',
            data: data.dates || []
          },
          yAxis: {
            type: 'value',
            name: 'æ•°é‡'
          },
          series: [
            {
              name: 'é”€å”®æ•°é‡',
              type: 'bar',
              data: data.series.quantity || [],
              itemStyle: { color: '#16baaa' }
            }
          ]
        };
        window.salesChartInstance.setOption(salesOption);
      }
      
      // æ¸²æŸ“SKUåˆ†æè¡¨æ ¼
      function renderSkuTable(data) {
        const tbody = document.querySelector('.analysis-table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = data.map((item, index) => {
          const statusColor = getStatusColor(item.status);
          const trendColor = getTrendColor(item.trend);
          const skuClass = item.status === 'offline' ? 'style="color: #f5222d; font-weight: bold;"' : '';
          
          return `
            <tr>
              <td>${index + 1}</td>
              <td ${skuClass}>${item.sku}</td>
              <td>${item.currentStock}</td>
              <td>${item.totalSales}</td>
              <td>${item.turnover}</td>
              <td><span style="color: ${statusColor};">${getStatusText(item.status)}</span></td>
              <td><span style="color: ${trendColor};">${getTrendText(item.trend)}</span></td>
              <td>${item.suggestion}</td>
            </tr>
          `;
        }).join('');
      }
      
      // è·å–çŠ¶æ€é¢œè‰²
      function getStatusColor(status) {
        switch(status) {
          case 'healthy': return '#52c41a';
          case 'warning': return '#fa8c16';
          case 'outOfStock': return '#f5222d';
          case 'offline': return '#f5222d';
          default: return '#666';
        }
      }
      
      // è·å–çŠ¶æ€æ–‡æœ¬
      function getStatusText(status) {
        switch(status) {
          case 'healthy': return 'æ­£å¸¸';
          case 'warning': return 'é¢„è­¦';
          case 'outOfStock': return 'ç¼ºè´§';
          case 'offline': return 'å·²ä¸‹æ¶';
          default: return 'æœªçŸ¥';
        }
      }
      
      // è·å–è¶‹åŠ¿é¢œè‰²
      function getTrendColor(trend) {
        switch(trend) {
          case 'up': return '#52c41a';
          case 'down': return '#f5222d';
          case 'stable': return '#fa8c16';
          default: return '#666';
        }
      }
      
      // è·å–è¶‹åŠ¿æ–‡æœ¬
      function getTrendText(trend) {
        switch(trend) {
          case 'up': return 'â†— ä¸Šå‡';
          case 'down': return 'â†˜ ä¸‹é™';
          case 'stable': return 'â†’ å¹³ç¨³';
          default: return 'â†’ å¹³ç¨³';
        }
      }
      
      // æ›´æ–°åˆ†æ
      window.updateAnalysis = function() {
        layer.msg('æ­£åœ¨æ›´æ–°åˆ†ææ•°æ®...', {icon: 16, time: 1000});
        loadAnalysisData();
        setTimeout(function() {
          layer.msg('åˆ†ææ•°æ®æ›´æ–°å®Œæˆï¼', {icon: 1});
        }, 1000);
      };
      
      // å¯¼å‡ºå›¾è¡¨
      window.exportChart = function(type) {
        var chart = type === 'stock' ? window.stockChartInstance : window.salesChartInstance;
        var url = chart.getDataURL({
          type: 'png',
          backgroundColor: '#fff'
        });
        
        var link = document.createElement('a');
        link.href = url;
        link.download = (type === 'stock' ? 'åº“å­˜è¶‹åŠ¿' : 'é”€å”®è¶‹åŠ¿') + '_' + new Date().getTime() + '.png';
        link.click();
        
        layer.msg('å›¾è¡¨å¯¼å‡ºæˆåŠŸï¼', {icon: 1});
      };
      
      // åˆ·æ–°å›¾è¡¨
      window.refreshChart = function(type) {
        layer.msg('æ­£åœ¨åˆ·æ–°å›¾è¡¨æ•°æ®...', {icon: 16, time: 1500});
        
        setTimeout(function() {
          if (type === 'stock') {
            window.stockChartInstance.resize();
          } else {
            window.salesChartInstance.resize();
          }
          layer.msg('å›¾è¡¨åˆ·æ–°å®Œæˆï¼', {icon: 1});
        }, 1500);
      };
    });
    
    // é€€å‡ºç™»å½•
    function logout() {
      layer.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', {icon: 3, title: 'æç¤º'}, function(index){
        localStorage.removeItem('currentUser');
        layer.close(index);
        layer.msg('å·²å®‰å…¨é€€å‡ºï¼', {icon: 1}, function(){
          window.location.href = 'login.html';
        });
      });
    }
    
    // åˆ‡æ¢è´¦æˆ·
    function switchAccount() {
      layer.confirm('åˆ‡æ¢è´¦æˆ·å°†é€€å‡ºå½“å‰ç™»å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ', {
        icon: 3, 
        title: 'åˆ‡æ¢è´¦æˆ·',
        btn: ['ç¡®å®š', 'å–æ¶ˆ']
      }, function(index) {
        localStorage.removeItem('currentUser');
        layer.close(index);
        layer.msg('æ­£åœ¨åˆ‡æ¢è´¦æˆ·...', {icon: 16, time: 1000}, function(){
          window.location.href = 'login.html';
        });
      });
    }
    
    // è·³è½¬åˆ°çˆ†å“æ»é”€å“åˆ†æé¡µé¢
    function goToHotSlowAnalysis() {
      window.location.href = 'hot-slow-analysis.html';
    }

    // è·³è½¬åˆ°å¤©çŒ«æ•°æ®åˆ†æé¡µé¢
    function goToTmallHotSlowAnalysis() {
      window.location.href = 'tmall-hot-slow-analysis.html';
    }
    
    // ============= ä¸Šä¸‹æ¶ç®¡ç†åŠŸèƒ½ =============
    
    // æ˜¾ç¤ºå¾…ä¸Šæ¶å•†å“
    window.showListingCandidates = function() {
      document.getElementById('delistingSection').style.display = 'none';
      const listingSection = document.getElementById('listingSection');
      listingSection.style.display = 'block';
      loadListingCandidates();
    };
    
    // æ˜¾ç¤ºå¾…ä¸‹æ¶å•†å“
    window.showDelistingCandidates = function() {
      document.getElementById('listingSection').style.display = 'none';
      const delistingSection = document.getElementById('delistingSection');
      delistingSection.style.display = 'block';
      loadDelistingCandidates();
    };
    
    // åˆ·æ–°ä¸Šä¸‹æ¶æ•°æ®
    window.refreshListingData = function() {
      layer.msg('æ­£åœ¨åˆ·æ–°æ•°æ®...', {icon: 16, time: 1000});
      const listingSection = document.getElementById('listingSection');
      const delistingSection = document.getElementById('delistingSection');
      
      if (listingSection.style.display === 'block') {
        loadListingCandidates();
      }
      if (delistingSection.style.display === 'block') {
        loadDelistingCandidates();
      }
      
      setTimeout(() => {
        layer.msg('æ•°æ®åˆ·æ–°å®Œæˆï¼', {icon: 1});
      }, 1000);
    };
    
    // åŠ è½½å¾…ä¸Šæ¶å•†å“
    function loadListingCandidates() {
      const token = localStorage.getItem('token');
      if (!token) return;
      
      fetch('/api/listing/candidates', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderListingTable(data.data);
        } else {
          layer.msg('åŠ è½½å¾…ä¸Šæ¶å•†å“å¤±è´¥: ' + data.error, {icon: 2});
        }
      })
      .catch(error => {
        console.error('åŠ è½½å¾…ä¸Šæ¶å•†å“å¤±è´¥:', error);
        layer.msg('åŠ è½½å¤±è´¥', {icon: 2});
      });
    }
    
    // åŠ è½½å¾…ä¸‹æ¶å•†å“
    function loadDelistingCandidates() {
      const token = localStorage.getItem('token');
      if (!token) return;
      
      fetch('/api/delisting/candidates', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderDelistingTable(data.data);
        } else {
          layer.msg('åŠ è½½å¾…ä¸‹æ¶å•†å“å¤±è´¥: ' + data.error, {icon: 2});
        }
      })
      .catch(error => {
        console.error('åŠ è½½å¾…ä¸‹æ¶å•†å“å¤±è´¥:', error);
        layer.msg('åŠ è½½å¤±è´¥', {icon: 2});
      });
    }
    
    // æ¸²æŸ“ä¸Šæ¶è¡¨æ ¼
    function renderListingTable(data) {
      const tbody = document.getElementById('listingTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = data.map(item => `
        <tr>
          <td><input type="checkbox" name="listingSku" value="${item.sku}"></td>
          <td class="sku-cell">${item.sku}</td>
          <td>${item.name || 'æœªçŸ¥å•†å“'}</td>
          <td><span style="color: #52c41a; font-weight: bold;">${item.currentStock}</span></td>
          <td>${item.totalSales || 0}</td>
          <td>${item.delistedDate || 'æœªçŸ¥'}</td>
          <td class="url-cell">
            ${item.url ? `<a href="${item.url}" target="_blank">æŸ¥çœ‹å•†å“</a>` : 'æ— é“¾æ¥'}
          </td>
        </tr>
      `).join('');
    }
    
    // æ¸²æŸ“ä¸‹æ¶è¡¨æ ¼
    function renderDelistingTable(data) {
      const tbody = document.getElementById('delistingTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = data.map(item => `
        <tr>
          <td><input type="checkbox" name="delistingSku" value="${item.sku}"></td>
          <td class="sku-cell">${item.sku}</td>
          <td>${item.name || 'æœªçŸ¥å•†å“'}</td>
          <td><span style="color: #f5222d; font-weight: bold;">${item.currentStock}</span></td>
          <td>${item.totalSales || 0}</td>
          <td>${item.outOfStockDays || 0} å¤©</td>
          <td class="url-cell">
            ${item.url ? `<a href="${item.url}" target="_blank">æŸ¥çœ‹å•†å“</a>` : 'æ— é“¾æ¥'}
          </td>
        </tr>
      `).join('');
    }
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰ - ä¸Šæ¶
    window.toggleAllListing = function(checkbox) {
      const checkboxes = document.querySelectorAll('input[name="listingSku"]');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
    };
    
    window.selectAllListing = function() {
      document.getElementById('listingSelectAll').checked = true;
      toggleAllListing(document.getElementById('listingSelectAll'));
    };
    
    window.clearListingSelection = function() {
      document.getElementById('listingSelectAll').checked = false;
      toggleAllListing(document.getElementById('listingSelectAll'));
    };
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰ - ä¸‹æ¶
    window.toggleAllDelisting = function(checkbox) {
      const checkboxes = document.querySelectorAll('input[name="delistingSku"]');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
    };
    
    window.selectAllDelisting = function() {
      document.getElementById('delistingSelectAll').checked = true;
      toggleAllDelisting(document.getElementById('delistingSelectAll'));
    };
    
    window.clearDelistingSelection = function() {
      document.getElementById('delistingSelectAll').checked = false;
      toggleAllDelisting(document.getElementById('delistingSelectAll'));
    };
    
    // ç¡®è®¤ä¸Šæ¶
    window.confirmListing = function() {
      const selectedSkus = Array.from(document.querySelectorAll('input[name="listingSku"]:checked'))
        .map(cb => cb.value);
      
      if (selectedSkus.length === 0) {
        layer.msg('è¯·é€‰æ‹©è¦ä¸Šæ¶çš„å•†å“', {icon: 2});
        return;
      }
      
      layer.confirm(`ç¡®å®šè¦ä¸Šæ¶é€‰ä¸­çš„ ${selectedSkus.length} ä¸ªå•†å“å—ï¼Ÿ`, {
        icon: 3,
        title: 'ç¡®è®¤ä¸Šæ¶'
      }, function(index) {
        const token = localStorage.getItem('token');
        fetch('/api/listing/confirm', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ skus: selectedSkus })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            layer.msg(`æˆåŠŸä¸Šæ¶ ${data.count} ä¸ªå•†å“ï¼`, {icon: 1});
            loadListingCandidates(); // é‡æ–°åŠ è½½
            loadAnalysisData(); // åˆ·æ–°åˆ†ææ•°æ®
          } else {
            layer.msg('ä¸Šæ¶å¤±è´¥: ' + data.error, {icon: 2});
          }
        })
        .catch(error => {
          console.error('ä¸Šæ¶å¤±è´¥:', error);
          layer.msg('ä¸Šæ¶å¤±è´¥', {icon: 2});
        });
        layer.close(index);
      });
    };
    
    // ç¡®è®¤ä¸‹æ¶
    window.confirmDelisting = function() {
      const selectedSkus = Array.from(document.querySelectorAll('input[name="delistingSku"]:checked'))
        .map(cb => cb.value);
      
      if (selectedSkus.length === 0) {
        layer.msg('è¯·é€‰æ‹©è¦ä¸‹æ¶çš„å•†å“', {icon: 2});
        return;
      }
      
      layer.confirm(`ç¡®å®šè¦ä¸‹æ¶é€‰ä¸­çš„ ${selectedSkus.length} ä¸ªå•†å“å—ï¼Ÿ`, {
        icon: 3,
        title: 'ç¡®è®¤ä¸‹æ¶'
      }, function(index) {
        const token = localStorage.getItem('token');
        fetch('/api/delisting/confirm', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ skus: selectedSkus })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            layer.msg(`æˆåŠŸä¸‹æ¶ ${data.count} ä¸ªå•†å“ï¼`, {icon: 1});
            loadDelistingCandidates(); // é‡æ–°åŠ è½½
            loadAnalysisData(); // åˆ·æ–°åˆ†ææ•°æ®
          } else {
            layer.msg('ä¸‹æ¶å¤±è´¥: ' + data.error, {icon: 2});
          }
        })
        .catch(error => {
          console.error('ä¸‹æ¶å¤±è´¥:', error);
          layer.msg('ä¸‹æ¶å¤±è´¥', {icon: 2});
        });
        layer.close(index);
      });
    };
  </script>
</body>
</html> 