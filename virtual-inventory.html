<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è™šæ‹Ÿåº“å­˜</title>
    <link href="./src/css/layui.css" rel="stylesheet" />
    <link href="./src/css/app-header.css" rel="stylesheet" />
    <style>
        body { background: #f8f9fa; }
        .replenish { color: #d23; font-weight: 600; }
        .ok { color: #16b777; }
        .url a { color: #1e9fff; }
        .text-left { text-align: left; }
    </style>
    <script>
        function getToken() {
            try {
                return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
            } catch (_) { return ''; }
        }
        async function fetchOverview() {
            const token = getToken();
            const headers = {};
            if (token) headers['Authorization'] = 'Bearer ' + token;
            const resp = await fetch('/api/virtual-inventory/overview', { headers });
            if (!resp.ok) {
                const t = await resp.text();
                throw new Error('è¯·æ±‚å¤±è´¥: ' + resp.status + ' ' + t);
            }
            return resp.json();
        }
        function renderTable(items) {
            // å‰ç«¯å…œåº•æ’åºï¼šéœ€è¡¥è´§ä¼˜å…ˆã€æŒ‰ä»Šæ—¥è®¢å•æ•°é™åº
            items = (items || []).slice().sort((a,b)=>{
                const byNeed = Number(b.needReplenish) - Number(a.needReplenish);
                if (byNeed !== 0) return byNeed;
                const byOrders = (b.todayOrderCount||0) - (a.todayOrderCount||0);
                if (byOrders !== 0) return byOrders;
                return String(a.sku||'').localeCompare(String(b.sku||''));
            });
            const tbody = document.querySelector('#table-body');
            tbody.innerHTML = '';
            items.forEach(it => {
                const skuText = it.sku || it.SKU || it['SKU'] || '';
                const nameText = it.name || it['äº§å“ä¸­æ–‡å'] || it['äº§å“åç§°'] || it['å•†å“åç§°'] || it.title || '';
                const link = it.url || it['ç½‘é¡µé“¾æ¥'] || it['é“¾æ¥'] || it['URL'] || '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-left">${skuText}</td>
                    <td class="text-left">${nameText}</td>
                    <td class="url">${link ? `<a href="${link}" target="_blank">é“¾æ¥</a>` : ''}</td>
                    <td style="text-align:center;">${it.virtualStock}</td>
                    <td style="text-align:center;">${it.todayOrderCount}</td>
                    <td style="text-align:center;">${it.needReplenish ? '<span class="replenish">éœ€è¦è¡¥è´§</span>' : '<span class="ok">æ­£å¸¸</span>'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        function renderSummary(summary, pagination) {
            const el = document.querySelector('#summary');
            const pageInfo = pagination ? ` ï½œ ç¬¬ ${pagination.page}/${pagination.totalPages} é¡µï¼ˆæ¯é¡µ ${pagination.limit} æ¡ï¼‰` : '';
            el.textContent = `æ—¥æœŸ ${summary.date} ï½œ åœ¨çº¿å•†å“ ${summary.totalOnline} ï½œ ä»Šæ—¥æœ‰è®¢å• ${summary.withOrdersToday} ï½œ è™šæ‹Ÿåº“å­˜/ä»¶ ${summary.virtualStockPerSku}${pageInfo}`;
        }
        function renderPager(pagination) {
            const pager = document.querySelector('#pager');
            if (!pagination) { pager.innerHTML=''; return; }
            pager.innerHTML = '';
            const btnPrev = document.createElement('button');
            btnPrev.className = 'layui-btn layui-btn-sm';
            btnPrev.textContent = 'ä¸Šä¸€é¡µ';
            btnPrev.disabled = !pagination.hasPrev;
            btnPrev.onclick = () => changePage(pagination.page - 1);
            const btnNext = document.createElement('button');
            btnNext.className = 'layui-btn layui-btn-sm layui-btn-primary';
            btnNext.textContent = 'ä¸‹ä¸€é¡µ';
            btnNext.disabled = !pagination.hasNext;
            btnNext.onclick = () => changePage(pagination.page + 1);
            pager.appendChild(btnPrev); pager.appendChild(btnNext);
        }
        let currentPage = 1;
        const pageSize = 100;
        async function loadData(page=1) {
            currentPage = page;
            const loading = document.querySelector('#loading');
            const err = document.querySelector('#error');
            loading.style.display = 'block';
            err.style.display = 'none';
            try {
                const token = getToken();
                const headers = {};
                if (token) headers['Authorization'] = 'Bearer ' + token;
                const resp = await fetch(`/api/virtual-inventory/overview?page=${currentPage}&limit=${pageSize}`, { headers });
                const { success, data, error } = await resp.json();
                if (!success) throw new Error(error || 'æœªçŸ¥é”™è¯¯');
                renderSummary(data.summary, data.pagination);
                renderTable(data.items || []);
                renderPager(data.pagination);
            } catch (e) {
                err.style.display = 'block';
                err.textContent = e.message;
            } finally {
                loading.style.display = 'none';
            }
        }
        function changePage(p) { if (p>0) loadData(p); }
        document.addEventListener('DOMContentLoaded', () => loadData(1));
    </script>
</head>
<body>
    <style>
      .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:space-between; }
      .header .layui-nav { background: transparent; }
      .header .layui-nav .layui-nav-item a { color: rgba(255,255,255,0.9); }
      .header .layui-nav .layui-nav-item a:hover { color: white; }
      .logo { font-size: 18px; font-weight: bold; white-space: nowrap; }
      .main-nav { flex: 1; display:flex; justify-content:center; margin:0 20px; }
      .main-nav .layui-nav-item a { padding:0 20px; border-radius:6px; transition: all .3s; font-size:14px; }
      .main-nav .layui-nav-item a:hover, .main-nav .layui-this a { background: rgba(255,255,255,0.2); color:#fff; }
    </style>
    <div class="layui-header header">
        <div class="logo">ğŸ“Š æ•°æ®ç®¡ç†ç³»ç»Ÿ</div>
        <ul class="layui-nav main-nav">
            <li class="layui-nav-item"><a href="dashboard.html"><i class="layui-icon layui-icon-home"></i> æ•°æ®ä»ªè¡¨ç›˜</a></li>
            <li class="layui-nav-item"><a href="table-management.html"><i class="layui-icon layui-icon-table"></i> è¡¨æ ¼ç®¡ç†</a></li>
            <li class="layui-nav-item"><a href="data-upload.html"><i class="layui-icon layui-icon-upload-drag"></i> æ•°æ®å¯¼å…¥</a></li>
            <li class="layui-nav-item layui-this"><a href="virtual-inventory.html"><i class="layui-icon layui-icon-engine"></i> è™šæ‹Ÿåº“å­˜</a></li>
            <li class="layui-nav-item"><a href="data-analysis.html"><i class="layui-icon layui-icon-chart"></i> æ•°æ®åˆ†æ</a></li>
            <li class="layui-nav-item"><a href="local-database.html"><i class="layui-icon layui-icon-database"></i> æœ¬åœ°æ•°æ®åº“</a></li>
            <li class="layui-nav-item"><a href="tmall-database.html"><i class="layui-icon layui-icon-cart"></i> å¤©çŒ«æ•°æ®åº“</a></li>
            <li class="layui-nav-item"><a href="tmall-order.html"><i class="layui-icon layui-icon-list"></i> å¤©çŒ«è®¢å•</a></li>
            <li class="layui-nav-item" id="adminOnlyTopNav" style="display:none;"><a href="user-management.html"><i class="layui-icon layui-icon-username"></i> ç”¨æˆ·ç®¡ç†</a></li>
        </ul>
        
    </div>
    <div class="layui-card" style="margin:16px;">
        <div class="layui-card-header">è™šæ‹Ÿåº“å­˜ï¼ˆæ‰€æœ‰å·²ä¸Šæ¶å•†å“å›ºå®šæ˜¾ç¤ºåº“å­˜=2ï¼‰</div>
        <div class="layui-card-body">
            <div id="summary" style="margin-bottom:12px;color:#666"></div>
            <div id="loading" style="display:none;">æ­£åœ¨åŠ è½½...</div>
            <div id="pager" style="margin:8px 0;"></div>
            <div id="error" style="display:none;color:#d23"></div>
            <table class="layui-table">
                <thead>
                    <tr>
                        <th class="text-left">SKU</th>
                        <th class="text-left">äº§å“ä¸­æ–‡å</th>
                        <th>é“¾æ¥</th>
                        <th style="text-align:center;width:120px;">è™šæ‹Ÿåº“å­˜</th>
                        <th style="text-align:center;width:140px;">ä»Šæ—¥è®¢å•æ•°</th>
                        <th style="text-align:center;width:140px;">è¡¥è´§æé†’</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
    <script src="./src/layui.js"></script>
    <script>
        layui.use(['layer'], function(){
            var layer = layui.layer;
            var userInfo = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (!userInfo.username) {
                layer.msg('è¯·å…ˆç™»å½•ï¼', {icon: 2}, function(){ window.location.href = 'login.html'; });
                return;
            }
            var cu = document.getElementById('currentUser');
            if (cu) cu.textContent = userInfo.realname || userInfo.username;
            if (userInfo.role === 'admin') {
                var el = document.getElementById('adminOnlyTopNav');
                if (el) el.style.display = 'block';
            }
        });
        function logout() {
          layui.layer.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', {icon: 3, title: 'æç¤º'}, function(index){
            localStorage.removeItem('currentUser');
            layui.layer.close(index);
            layui.layer.msg('å·²å®‰å…¨é€€å‡ºï¼', {icon: 1}, function(){ window.location.href = 'login.html'; });
          });
        }
        function switchAccount() {
          layui.layer.confirm('åˆ‡æ¢è´¦å·å°†é€€å‡ºå½“å‰ç™»å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ', {icon: 3, title: 'åˆ‡æ¢è´¦å·', btn: ['ç¡®å®š', 'å–æ¶ˆ']}, function(index) {
            localStorage.removeItem('currentUser');
            layui.layer.close(index);
            layui.layer.msg('æ­£åœ¨åˆ‡æ¢è´¦å·...', {icon: 16, time: 1000}, function(){ window.location.href = 'login.html'; });
          });
        }
    </script>
</body>
</html>


