<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æœ¬åœ°æ•°æ®åº“ç®¡ç† - æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
  <link href="./src/css/layui.css" rel="stylesheet">
  <link href="./src/css/app-header.css" rel="stylesheet">
  <script src="./api-config.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@16.0.1/dist/handsontable.full.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@16.0.1/styles/ht-theme-main.min.css">
  <style>
    body {
      background: #f8f9fa;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header .layui-nav {
      background: transparent;
    }
    .header .layui-nav .layui-nav-item a {
      color: rgba(255,255,255,0.9);
    }
    .header .layui-nav .layui-nav-item a:hover {
      color: white;
    }
    .header .logo {
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
    }
    
    /* ä¸»å¯¼èˆªæ ·å¼ */
    .main-nav {
      flex: 1;
      display: flex;
      justify-content: center;
      margin: 0 20px;
    }
    .main-nav .layui-nav-item {
      margin: 0 5px;
    }
    .main-nav .layui-nav-item a {
      padding: 0 20px;
      border-radius: 6px;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .main-nav .layui-nav-item a:hover,
    .main-nav .layui-nav-item.layui-this a {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    .main-nav .layui-nav-item a i {
      margin-right: 6px;
    }
    
    .header .user-info {
      white-space: nowrap;
    }
    
    /* ç”¨æˆ·ä¸‹æ‹‰èœå•æ ·å¼ */
    .user-info .layui-nav-child dd a {
      padding: 10px 15px;
      color: #666;
      transition: all 0.3s ease;
    }
    .user-info .layui-nav-child dd a:hover {
      background: #f8f9fa;
      color: #16baaa;
    }
    .user-info .layui-nav-child dd a i {
      margin-right: 8px;
      font-size: 14px;
    }
    
    .content-wrapper {
      padding: 20px;
    }
    
    .page-header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .page-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin: 0;
    }
    .page-subtitle {
      color: #666;
      margin-top: 5px;
    }
    .breadcrumb {
      color: #999;
      font-size: 14px;
      margin-top: 10px;
    }
    .breadcrumb a {
      color: #16baaa;
      text-decoration: none;
    }
    
    .mode-switch {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
    }
    .mode-switch .layui-btn {
      margin: 0 10px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    .mode-switch .layui-btn.layui-btn-primary {
      background: #f8f9fa;
      border: 1px solid #e6e6e6;
      color: #666;
    }
    .mode-switch .layui-btn.active {
      background: #16baaa;
      color: white;
      border-color: #16baaa;
    }
    .mode-switch .layui-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .mode-description {
      text-align: center;
      color: #666;
      margin: 15px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #16baaa;
    }
    
    .table-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .table-header {
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
      background: #fafafa;
    }
    .table-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #666;
    }
    
    .action-buttons {
      text-align: right;
      margin-bottom: 15px;
    }
    .action-buttons .layui-btn {
      margin-left: 10px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    .action-buttons .layui-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .wide-table-container, .record-table-container {
      display: none;
    }
    .wide-table-container.active, .record-table-container.active {
      display: block;
    }
    
    .handsontable-container {
      padding: 20px;
    }
    
    /* è¡¨æ ¼æ ·å¼ç»Ÿä¸€ */
    .layui-table-cell {
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ç¼–è¾‘çŠ¶æ€æ æ ·å¼ */
    .edit-status-bar {
      background: linear-gradient(90deg, #52c41a, #73d13d);
      color: white;
      padding: 8px 20px;
      margin: 0 -20px 15px -20px;
      border-radius: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(82, 196, 26, 0.3);
    }
    
    .edit-status-bar .status-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .edit-status-bar .unsaved-indicator {
      margin-left: 20px;
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    /* å·²ä¸‹æ¶å•†å“æ ·å¼ */
    .sku-offline {
      background-color: #fff2f0 !important;
      color: #cf1322 !important;
      font-weight: bold !important;
    }
    
    /* æ‰¹é‡ä¸Šæ–°å¼¹çª—æ ·å¼ */
    .batch-upload-container {
      max-width: 500px;
    }
    
    .upload-instructions {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #52c41a;
    }
    
    .instruction-item {
      margin-bottom: 15px;
    }
    
    .instruction-item:last-child {
      margin-bottom: 0;
    }
    
    .upload-buttons {
      text-align: center;
    }
    
    .upload-buttons .layui-btn {
      margin: 0 5px;
    }
    
    .upload-status {
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .upload-status.success {
      background: #f6ffed;
      border: 1px solid #b7eb8f;
      color: #52c41a;
    }
    
    .upload-status.error {
      background: #fff2f0;
      border: 1px solid #ffccc7;
      color: #cf1322;
    }
    
    .upload-status.processing {
      background: #e6f7ff;
      border: 1px solid #91d5ff;
      color: #1890ff;
    }
  </style>
</head>
<body>
  <div class="layui-header header">
    <div class="logo">
      ğŸ“Š æ•°æ®ç®¡ç†ç³»ç»Ÿ
    </div>
    
    <!-- ä¸»å¯¼èˆªæŒ‰é’® -->
    <ul class="layui-nav main-nav">
      <li class="layui-nav-item">
        <a href="dashboard.html">
          <i class="layui-icon layui-icon-home"></i> æ•°æ®ä»ªè¡¨ç›˜
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="table-management.html">
          <i class="layui-icon layui-icon-table"></i> è¡¨æ ¼ç®¡ç†
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="data-upload.html">
          <i class="layui-icon layui-icon-upload-drag"></i> æ•°æ®å¯¼å…¥
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="arcteryx-data-analysis.html">
          <i class="layui-icon layui-icon-chart"></i> å§‹ç¥–é¸Ÿå¤–ç½‘æ•°æ®åˆ†æ
        </a>
      </li>
      <li class="layui-nav-item">
        </a>
      </li>
      <li class="layui-nav-item layui-this">
        <a href="local-database.html">
          <i class="layui-icon layui-icon-database"></i> æœ¬åœ°æ•°æ®åº“
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="tmall-database.html">
          <i class="layui-icon layui-icon-cart"></i> å¤©çŒ«æ•°æ®åº“
        </a>
      </li>
      <li class="layui-nav-item">
        <a href="tmall-order.html">
          <i class="layui-icon layui-icon-list"></i> å¤©çŒ«è®¢å•
        </a>
      </li>
      <li class="layui-nav-item" id="adminOnlyTopNav" style="display: none;">
        <a href="user-management.html">
          <i class="layui-icon layui-icon-username"></i> ç”¨æˆ·ç®¡ç†
        </a>
      </li>
    </ul>
    
    
  </div>
  
  <div class="content-wrapper">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
      <h1 class="page-title">ğŸ“Š æœ¬åœ°æ•°æ®åº“ç®¡ç†</h1>
      <p class="page-subtitle">ç®¡ç†æ‚¨çš„SKUåº“å­˜å’Œé”€å”®æ•°æ®</p>
      <div class="breadcrumb">
        <a href="dashboard.html">é¦–é¡µ</a> / æœ¬åœ°æ•°æ®åº“
      </div>
    </div>
    
    <!-- æ¨¡å¼åˆ‡æ¢ -->
    <div class="mode-switch">
      <button class="layui-btn layui-btn-primary active" id="wideTableMode">
        <i class="layui-icon layui-icon-table"></i> å®½è¡¨æ¨¡å¼ï¼ˆæœ€è¿‘5å¤©ï¼‰
      </button>
      <button class="layui-btn layui-btn-primary" id="recordMode">
        <i class="layui-icon layui-icon-list"></i> è¡Œè®°å½•æ¨¡å¼ï¼ˆå†å²æ•°æ®ï¼‰
      </button>
    </div>
    
    <div class="mode-description" id="modeDescription">
      å®½è¡¨æ¨¡å¼ï¼šé€‚åˆæ—¥å¸¸å¿«é€Ÿå½•å…¥å’ŒæŸ¥çœ‹æœ€è¿‘5å¤©çš„æ•°æ®ï¼Œæ”¯æŒæ‰¹é‡ç¼–è¾‘
    </div>

    <!-- å®½è¡¨æ¨¡å¼å®¹å™¨ -->
    <div class="wide-table-container active" id="wideTableContainer">
      <div class="table-container">
        <div class="table-header">
          <div class="table-stats">
            <span>å®½è¡¨æ•°æ®ç®¡ç†</span>
            <span>æœ€è¿‘5å¤©åº“å­˜æ•°æ®</span>
          </div>
        </div>
        <div class="action-buttons">
          <button class="layui-btn layui-btn-normal" id="enableEditBtn">
            <i class="layui-icon layui-icon-edit"></i> å¼€å§‹ç¼–è¾‘
          </button>
          <button class="layui-btn layui-btn-primary" id="refreshBtn">
            <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°
          </button>
          <button class="layui-btn layui-btn-danger" id="saveWideTableBtn" disabled>
            <i class="layui-icon layui-icon-ok"></i> ä¿å­˜ä¿®æ”¹
          </button>
          <button class="layui-btn layui-btn-warm" id="cancelEditBtn" disabled>
            <i class="layui-icon layui-icon-close"></i> å–æ¶ˆç¼–è¾‘
          </button>
          <button class="layui-btn layui-btn-normal" id="addNewProductBtn">
            <i class="layui-icon layui-icon-add-1"></i> ä¸Šæ–°äº§å“
          </button>
          <button class="layui-btn layui-btn-warm" id="batchAddProductBtn">
            <i class="layui-icon layui-icon-upload"></i> æ‰¹é‡ä¸Šæ–°
          </button>
          <button class="layui-btn" id="importBtn">
            <i class="layui-icon layui-icon-upload"></i> å¯¼å…¥Excel
          </button>
          <button class="layui-btn" id="exportBtn">
            <i class="layui-icon layui-icon-download-circle"></i> å¯¼å‡ºExcel
          </button>
          <button class="layui-btn layui-btn-danger" id="clearAllDataBtn">
            <i class="layui-icon layui-icon-close"></i> æ¸…ç©ºæ‰€æœ‰æ•°æ®
          </button>
        </div>
        
        <!-- ç¼–è¾‘çŠ¶æ€æç¤º -->
        <div class="edit-status-bar" id="editStatusBar" style="display: none;">
          <div class="status-info">
            <i class="layui-icon layui-icon-edit"></i>
            <span>ç¼–è¾‘æ¨¡å¼å·²å¯ç”¨ï¼Œå¯ä»¥ä¿®æ”¹è¡¨æ ¼æ•°æ®</span>
            <span class="unsaved-indicator" id="unsavedIndicator" style="display: none;">
              <i class="layui-icon layui-icon-tips"></i> æœ‰æœªä¿å­˜çš„ä¿®æ”¹
            </span>
          </div>
        </div>
        <div class="handsontable-container">
          <div id="wideTable" style="width:100%;min-height:500px;"></div>
        </div>
      </div>
    </div>

    <!-- è¡Œè®°å½•æ¨¡å¼å®¹å™¨ -->
    <div class="record-table-container" id="recordTableContainer">
      <div class="table-container">
        <div class="table-header">
          <div class="table-stats">
            <span>å†å²è®°å½•ç®¡ç†</span>
            <span>å†å²æ•°æ®æŸ¥è¯¢</span>
          </div>
        </div>
        <div class="action-buttons">
          <button class="layui-btn" id="addRecordBtn">
            <i class="layui-icon layui-icon-add-1"></i> æ–°å¢è®°å½•
          </button>
          <button class="layui-btn layui-btn-primary" id="refreshRecordBtn">
            <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°
          </button>
          <button class="layui-btn" id="importRecordBtn">
            <i class="layui-icon layui-icon-upload"></i> æ‰¹é‡å¯¼å…¥
          </button>
          <button class="layui-btn" id="exportRecordBtn">
            <i class="layui-icon layui-icon-download-circle"></i> å¯¼å‡ºæ•°æ®
          </button>
          <button class="layui-btn layui-btn-warm" id="downloadRecordTemplateBtn">
            <i class="layui-icon layui-icon-template"></i> ä¸‹è½½æ¨¡æ¿
          </button>
          <button class="layui-btn layui-btn-danger" id="clearAllRecordDataBtn">
            <i class="layui-icon layui-icon-close"></i> æ¸…ç©ºæ‰€æœ‰æ•°æ®
          </button>
        </div>
        <div style="padding: 20px;">
          <table class="layui-hide" id="recordTable" lay-filter="recordTable"></table>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
  <div id="editFormModal" style="display:none;padding:20px 30px 0 0;">
    <form class="layui-form" lay-filter="editForm">
      <div class="layui-form-item">
        <label class="layui-form-label">SKU</label>
        <div class="layui-input-block">
          <input type="text" name="sku" required lay-verify="required" placeholder="è¯·è¾“å…¥SKU" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">äº§å“ä¸­æ–‡å</label>
        <div class="layui-input-block">
          <input type="text" name="name" required lay-verify="required" placeholder="è¯·è¾“å…¥äº§å“ä¸­æ–‡å" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">ç½‘é¡µé“¾æ¥</label>
        <div class="layui-input-block">
          <input type="url" name="url" placeholder="è¯·è¾“å…¥ç½‘é¡µé“¾æ¥" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">åˆå§‹åº“å­˜</label>
        <div class="layui-input-block">
          <input type="number" name="initialStock" required lay-verify="required|number" placeholder="è¯·è¾“å…¥åˆå§‹åº“å­˜æ•°é‡" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">æ—¥æœŸ</label>
        <div class="layui-input-block">
          <input type="text" name="date" required lay-verify="required|date" placeholder="å¦‚ 2024-07-18 11:30" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">åº“å­˜</label>
        <div class="layui-input-block">
          <input type="number" name="stock" required lay-verify="required|number" placeholder="è¯·è¾“å…¥åº“å­˜æ•°é‡" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-input-block">
          <button class="layui-btn" lay-submit lay-filter="submitEdit">ä¿å­˜</button>
        </div>
      </div>
    </form>
  </div>

  <!-- ä¸Šæ–°äº§å“å¼¹çª— -->
  <div id="addNewProductModal" style="display:none;padding:20px 30px 0 0;">
    <form class="layui-form" lay-filter="addNewProductForm">
      <div class="layui-form-item">
        <label class="layui-form-label">SKU</label>
        <div class="layui-input-block">
          <input type="text" name="sku" required lay-verify="required" placeholder="è¯·è¾“å…¥æ–°äº§å“SKU" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">äº§å“ä¸­æ–‡å</label>
        <div class="layui-input-block">
          <input type="text" name="name" required lay-verify="required" placeholder="è¯·è¾“å…¥äº§å“ä¸­æ–‡å" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">ç½‘é¡µé“¾æ¥</label>
        <div class="layui-input-block">
          <input type="url" name="url" placeholder="è¯·è¾“å…¥ç½‘é¡µé“¾æ¥" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">åˆå§‹åº“å­˜</label>
        <div class="layui-input-block">
          <input type="number" name="initialStock" required lay-verify="required|number" placeholder="è¯·è¾“å…¥åˆå§‹åº“å­˜æ•°é‡" autocomplete="off" class="layui-input">
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-input-block">
          <button class="layui-btn layui-btn-normal" lay-submit lay-filter="submitNewProduct">æ·»åŠ æ–°äº§å“</button>
          <button type="button" class="layui-btn layui-btn-primary" id="cancelNewProduct">å–æ¶ˆ</button>
        </div>
      </div>
    </form>
  </div>

  <!-- æ‰¹é‡ä¸Šæ–°äº§å“å¼¹çª— -->
  <div id="batchAddProductModal" style="display:none;padding:20px;">
    <div class="batch-upload-container">
      <div class="upload-instructions">
        <h3 style="margin-top:0;color:#333;">ğŸ“‹ æ‰¹é‡ä¸Šæ–°äº§å“è¯´æ˜</h3>
        <div class="instruction-item">
          <strong>ğŸ“„ Excelæ ¼å¼è¦æ±‚ï¼š</strong>
          <ul style="margin:8px 0;padding-left:20px;color:#666;">
            <li>ç¬¬ä¸€åˆ—ï¼šSKU ï¼ˆå¿…å¡«ï¼‰</li>
            <li>ç¬¬äºŒåˆ—ï¼šäº§å“ä¸­æ–‡å ï¼ˆå¿…å¡«ï¼‰</li>
            <li>ç¬¬ä¸‰åˆ—ï¼šç½‘é¡µé“¾æ¥ ï¼ˆé€‰å¡«ï¼‰</li>
            <li>ç¬¬å››åˆ—ï¼šåˆå§‹åº“å­˜ ï¼ˆå¿…å¡«ï¼Œæ•°å­—ï¼‰</li>
          </ul>
        </div>
        <div class="instruction-item">
          <strong>âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</strong>
          <ul style="margin:8px 0;padding-left:20px;color:#666;">
            <li>è¯·ç¡®ä¿SKUä¸é‡å¤ï¼Œé‡å¤çš„SKUå°†è¢«è·³è¿‡</li>
            <li>æ–°äº§å“å°†è‡ªåŠ¨è®¾ç½®ä¸ºä¸Šæ¶çŠ¶æ€</li>
            <li>åº“å­˜æ•°æ®å°†è®°å½•åˆ°ä»Šå¤©çš„æ—¥æœŸ</li>
          </ul>
        </div>
      </div>
      
      <div class="upload-area" style="margin:20px 0;">
        <div class="upload-buttons">
          <button class="layui-btn layui-btn-normal" id="downloadBatchTemplate">
            <i class="layui-icon layui-icon-download-circle"></i> ä¸‹è½½Excelæ¨¡æ¿
          </button>
          <button class="layui-btn layui-btn-warm" id="selectBatchFile">
            <i class="layui-icon layui-icon-upload"></i> é€‰æ‹©Excelæ–‡ä»¶
          </button>
        </div>
        <div class="upload-status" id="batchUploadStatus" style="margin-top:15px;display:none;">
          <div class="status-info"></div>
        </div>
      </div>
      
      <div style="text-align:right;margin-top:20px;">
        <button type="button" class="layui-btn layui-btn-primary" id="cancelBatchAdd">å…³é—­</button>
      </div>
    </div>
  </div>

  <script src="./src/modules/jquery.js"></script>
  <script src="./src/layui.js"></script>
  <script>
    layui.use(['table', 'layer', 'form'], function(){
      var table = layui.table;
      var layer = layui.layer;
      var form = layui.form;
      var $ = layui.$;

      var currentMode = 'wide'; // å½“å‰æ¨¡å¼ï¼šwide æˆ– record
      var modeVersion = 0; // ç”¨äºé¿å…å¼‚æ­¥å›è°ƒä¸é”€æ¯å®ä¾‹çš„ç«æ€
      var hot = null; // Handsontableå®ä¾‹
      var isEditMode = false; // ç¼–è¾‘æ¨¡å¼çŠ¶æ€
      var hasUnsavedChanges = false; // æ˜¯å¦æœ‰æœªä¿å­˜çš„ä¿®æ”¹
      var originalData = null; // åŸå§‹æ•°æ®å¤‡ä»½

      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      var userInfo = JSON.parse(localStorage.getItem('currentUser') || '{}');
      if (!userInfo.username) {
        layer.msg('è¯·å…ˆç™»å½•ï¼', {icon: 2}, function(){
          window.location.href = 'login.html';
        });
        return;
      }

      // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
      var cu = document.getElementById('currentUser');
      if (cu) cu.textContent = userInfo.realname || userInfo.username;

      // æ¨¡å¼åˆ‡æ¢
      $('#wideTableMode').on('click', function() {
        switchMode('wide');
      });

      $('#recordMode').on('click', function() {
        switchMode('record');
      });

      function switchMode(mode) {
        currentMode = mode;
        modeVersion++;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        $('.mode-switch .layui-btn').removeClass('active');
        if (mode === 'wide') {
          $('#wideTableMode').addClass('active');
          $('#modeDescription').text('å®½è¡¨æ¨¡å¼ï¼šé€‚åˆæ—¥å¸¸å¿«é€Ÿå½•å…¥å’ŒæŸ¥çœ‹æœ€è¿‘5å¤©çš„æ•°æ®ï¼Œæ”¯æŒæ‰¹é‡ç¼–è¾‘');
        } else {
          $('#recordMode').addClass('active');
          $('#modeDescription').text('è¡Œè®°å½•æ¨¡å¼ï¼šç®¡ç†å†å²æ•°æ®ï¼Œæ”¯æŒå•æ¡è®°å½•æ“ä½œå’Œæ‰¹é‡å¯¼å…¥å¯¼å‡º');
        }

        // åˆ‡æ¢å®¹å™¨æ˜¾ç¤º
        $('.wide-table-container, .record-table-container').removeClass('active');
        if (mode === 'wide') {
          $('#wideTableContainer').addClass('active');
          initWideTable();
        } else {
          $('#recordTableContainer').addClass('active');
          initRecordTable();
        }
      }

      // åˆå§‹åŒ–å®½è¡¨æ¨¡å¼
      function initWideTable() {
        if (hot) {
          hot.destroy();
          hot = null;
        }

        // å­—æ®µå®šä¹‰ - å®½è¡¨æ¨¡å¼ï¼ŒæŒ‰æ—¥æœŸåˆ†åˆ—
        const today = new Date();
        const columns = [
          {data: 'SKU', type: 'text'},
          {data: 'äº§å“ä¸­æ–‡å', type: 'text'},
          {data: 'ç½‘é¡µé“¾æ¥', type: 'text'},
          {data: 'åˆå§‹åº“å­˜', type: 'numeric'}
        ];
        const colHeaders = ['SKU', 'äº§å“ä¸­æ–‡å', 'ç½‘é¡µé“¾æ¥', 'åˆå§‹åº“å­˜'];
        
        // ç”Ÿæˆæœ€è¿‘5å¤©çš„åˆ—ï¼ˆåº“å­˜å’Œé”€é‡ï¼‰
        for (let i = 4; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];
          
          // åº“å­˜åˆ—
          columns.push({data: dateStr, type: 'numeric'});
          colHeaders.push(dateStr + '(åº“å­˜)');
          
          // é”€é‡åˆ—
          columns.push({data: dateStr + '_é”€é‡', type: 'numeric'});
          colHeaders.push(dateStr + '(é”€é‡)');
        }

        // ä»åç«¯åŠ è½½å®½è¡¨æ•°æ®
        const requestVersion = modeVersion;
        loadWideTableData(columns, colHeaders, requestVersion);
      }

      // åŠ è½½å®½è¡¨æ•°æ®
      function loadWideTableData(columns, colHeaders, requestVersion) {
        var token = localStorage.getItem('token');
        var headers = {};
        if (token) {
          headers['Authorization'] = 'Bearer ' + token;
        }
        
        $.ajax({
          url: window.apiConfig.baseURL + '/api/localdb/wide',
          type: 'GET',
          headers: headers,
          success: function(res) {
            // å¦‚æœåœ¨è¯·æ±‚æœŸé—´ç”¨æˆ·åˆ‡æ¢äº†æ¨¡å¼æˆ–å®ä¾‹è¢«é”€æ¯ï¼Œåˆ™ä¸¢å¼ƒç»“æœ
            if (currentMode !== 'wide' || requestVersion !== modeVersion) {
              return;
            }
            if(res.success) {
              // ä¿å­˜åŸå§‹æ•°æ®
              originalData = JSON.parse(JSON.stringify(res.data));
              
              // åˆå§‹åŒ–Handsontable
              hot = new Handsontable(document.getElementById('wideTable'), {
                data: res.data,
                columns: columns,
                colHeaders: colHeaders,
                rowHeaders: true,
                minSpareRows: 0, // é»˜è®¤ä¸å…è®¸æ–°å¢è¡Œ
                contextMenu: false, // é»˜è®¤ç¦ç”¨å³é”®èœå•
                manualColumnResize: true,
                manualRowResize: true,
                stretchH: 'all',
                height: 600,
                licenseKey: 'non-commercial-and-evaluation',
                language: 'zh-CN',
                dropdownMenu: false, // é»˜è®¤ç¦ç”¨ä¸‹æ‹‰èœå•
                filters: true,
                columnSorting: true,
                autoWrapRow: true,
                autoWrapCol: true,
                readOnly: true, // é»˜è®¤åªè¯»æ¨¡å¼
                beforeChange: function(changes, source) {
                  // æ£€æŸ¥æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡å¼
                  if (!isEditMode && source !== 'loadData') {
                    layer.msg('è¯·å…ˆç‚¹å‡»"å¼€å§‹ç¼–è¾‘"æŒ‰é’®æ‰èƒ½ä¿®æ”¹æ•°æ®', {icon: 2});
                    return false;
                  }
                  // æ ‡è®°æœ‰æœªä¿å­˜çš„ä¿®æ”¹
                  if (isEditMode && source !== 'loadData') {
                    hasUnsavedChanges = true;
                    updateUnsavedIndicator();
                  }
                },
                afterChange: function(changes, source) {
                  // æ•°æ®å˜æ›´åé‡æ–°åº”ç”¨æ ·å¼
                  if (source !== 'loadData') {
                    setTimeout(function() {
                      applyOfflineStyles();
                    }, 100);
                  }
                },
                afterLoadData: function() {
                  // åº”ç”¨ä¸‹æ¶å•†å“æ ·å¼
                  applyOfflineStyles();
                }
              });
              // åŠ è½½åè‡ªåŠ¨è®¡ç®—é”€é‡ï¼ˆå†æ¬¡ç¡®è®¤å®ä¾‹æœ‰æ•ˆï¼‰
              if (hot) {
                calculateSales(hot.getSourceData(), columns);
                hot.render();
              }
              applyOfflineStyles();
            } else {
              layer.msg('æ•°æ®åŠ è½½å¤±è´¥: ' + res.error, {icon:2});
            }
          },
          error: function(xhr) {
            if (xhr.status === 401) {
              layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){
                window.location.href = 'login.html';
              });
            } else {
              layer.msg('æ•°æ®åŠ è½½å¤±è´¥', {icon:2});
            }
          }
        });
      }

      // è®¡ç®—æ‰€æœ‰è¡Œçš„é”€é‡
      function calculateSales(tableData, columns) {
        // è·å–æ‰€æœ‰æ—¥æœŸåˆ—
        const dateCols = columns
          .map(col => col.data)
          .filter(key => /^\d{4}-\d{2}-\d{2}$/.test(key));
        tableData.forEach(row => {
          let lastStock = null;
          let lastDate = null;
          dateCols.forEach((dateKey, idx) => {
            const stock = parseInt(row[dateKey]) || 0;
            // æŸ¥æ‰¾å‰é¢æœ€è¿‘çš„æœ‰åº“å­˜æ•°æ®çš„æ—¥æœŸ
            let prevStock = null;
            for (let j = idx - 1; j >= 0; j--) {
              const prevKey = dateCols[j];
              if (row[prevKey] !== undefined && row[prevKey] !== null && row[prevKey] !== '') {
                prevStock = parseInt(row[prevKey]) || 0;
                break;
              }
            }
            // å¦‚æœæ‰¾ä¸åˆ°å‰ä¸€å¤©ï¼Œåˆ™é”€é‡ä¸º0
            let sales = 0;
            if (prevStock !== null) {
              sales = Math.max(0, prevStock - stock);
            }
            row[dateKey + '_é”€é‡'] = sales;
          });
        });
      }

      // åˆå§‹åŒ–è¡Œè®°å½•æ¨¡å¼
      function initRecordTable() {
        renderRecordTable();
      }

      // æ¸²æŸ“è¡Œè®°å½•è¡¨æ ¼
      function renderRecordTable() {
        var token = localStorage.getItem('token');
        var headers = {};
        if (token) {
          headers['Authorization'] = 'Bearer ' + token;
        }
        
        $.ajax({
          url: window.apiConfig.baseURL + '/api/localdb/records',
          type: 'GET',
          headers: headers,
          success: function(res) {
            if(res.success) {
              table.render({
                elem: '#recordTable',
                data: res.data,
                page: true,
                limit: 20,
                cols: [[
                  {field:'SKU', title:'SKU', width:150, sort:true},
                  {field:'äº§å“ä¸­æ–‡å', title:'äº§å“ä¸­æ–‡å', width:180},
                  {field:'ç½‘é¡µé“¾æ¥', title:'ç½‘é¡µé“¾æ¥', width:220, templet: function(d){ return d['ç½‘é¡µé“¾æ¥'] ? '<a href="'+d['ç½‘é¡µé“¾æ¥']+'" target="_blank">'+d['ç½‘é¡µé“¾æ¥']+'</a>' : ''; }},
                  {field:'åˆå§‹åº“å­˜', title:'åˆå§‹åº“å­˜', width:100, sort:true},
                  {field:'æ—¥æœŸ', title:'æ—¥æœŸ', width:160, sort:true},
                  {field:'åº“å­˜', title:'åº“å­˜', width:100, sort:true},
                  {field:'é”€é‡', title:'é”€é‡', width:100, sort:true, templet: function(d){ 
                    return '<span style="color: ' + (d['é”€é‡'] > 0 ? '#52c41a' : '#999') + ';">' + d['é”€é‡'] + '</span>'; 
                  }},
                  {title:'æ“ä½œ', width:180, align:'center', toolbar:'#rowBar'}
                ]],
                text: {none: 'æš‚æ— æ•°æ®'}
              });
            } else {
              layer.msg('æ•°æ®åŠ è½½å¤±è´¥: ' + res.error, {icon:2});
            }
          },
          error: function(xhr) {
            if (xhr.status === 401) {
              layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){
                window.location.href = 'login.html';
              });
            } else {
              layer.msg('æ•°æ®åŠ è½½å¤±è´¥', {icon:2});
            }
          }
        });
      }

      // å·¥å…·æ¡æ¨¡æ¿
      var rowBarHtml = '<div class="layui-btn-group">'
        +'<button class="layui-btn layui-btn-xs" lay-event="edit">ç¼–è¾‘</button>'
        +'<button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">åˆ é™¤</button>'
        +'</div>';
      $(document.body).append('<script type="text/html" id="rowBar">'+rowBarHtml+'<\/script>');

      // ç¼–è¾‘æ¨¡å¼æ§åˆ¶å‡½æ•°
      function enableEditMode() {
        isEditMode = true;
        hasUnsavedChanges = false;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        $('#enableEditBtn').prop('disabled', true).removeClass('layui-btn-normal').addClass('layui-btn-disabled');
        $('#saveWideTableBtn').prop('disabled', false).removeClass('layui-btn-disabled');
        $('#cancelEditBtn').prop('disabled', false).removeClass('layui-btn-disabled');
        
        // æ˜¾ç¤ºç¼–è¾‘çŠ¶æ€æ 
        $('#editStatusBar').show();
        
        // å¯ç”¨è¡¨æ ¼ç¼–è¾‘
        if (hot) {
          hot.updateSettings({
            readOnly: false,
            contextMenu: true,
            minSpareRows: 1
          });
        }
        
        layer.msg('ç¼–è¾‘æ¨¡å¼å·²å¯ç”¨ï¼Œå¯ä»¥ä¿®æ”¹è¡¨æ ¼æ•°æ®', {icon: 1});
      }
      
      function disableEditMode() {
        isEditMode = false;
        hasUnsavedChanges = false;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        $('#enableEditBtn').prop('disabled', false).removeClass('layui-btn-disabled').addClass('layui-btn-normal');
        $('#saveWideTableBtn').prop('disabled', true).addClass('layui-btn-disabled');
        $('#cancelEditBtn').prop('disabled', true).addClass('layui-btn-disabled');
        
        // éšè—ç¼–è¾‘çŠ¶æ€æ 
        $('#editStatusBar').hide();
        updateUnsavedIndicator();
        
        // ç¦ç”¨è¡¨æ ¼ç¼–è¾‘
        if (hot) {
          hot.updateSettings({
            readOnly: true,
            contextMenu: false,
            minSpareRows: 0
          });
        }
      }
      
      function updateUnsavedIndicator() {
        if (hasUnsavedChanges) {
          $('#unsavedIndicator').show();
        } else {
          $('#unsavedIndicator').hide();
        }
      }
      
      // åº”ç”¨ä¸‹æ¶å•†å“æ ·å¼
      function applyOfflineStyles() {
        if (!hot) return;
        
        const data = hot.getSourceData();
        data.forEach((row, rowIndex) => {
          // å…ˆæ¸…é™¤ä¹‹å‰çš„æ ·å¼
          hot.setCellMeta(rowIndex, 0, 'className', '');
          
          // æ£€æŸ¥å•†å“æ˜¯å¦ä¸‹æ¶ï¼ˆé€šè¿‡ä¸Šä¸‹æ¶ç®¡ç†çŠ¶æ€ï¼‰
          if (row.status === 'offline') {
            // å¯¹SKUåˆ—ï¼ˆç¬¬ä¸€åˆ—ï¼‰åº”ç”¨çº¢è‰²æ ·å¼
            hot.setCellMeta(rowIndex, 0, 'className', 'sku-offline');
          }
        });
        hot.render();
      }
      
      // é¡µé¢ç¦»å¼€ç¡®è®¤
      window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
          e.preventDefault();
          e.returnValue = '';
          return 'æ‚¨æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
        }
      });

      // æ–°çš„æŒ‰é’®äº‹ä»¶
      $('#enableEditBtn').on('click', function(){
        enableEditMode();
      });

      $('#cancelEditBtn').on('click', function(){
        if (hasUnsavedChanges) {
          layer.confirm('æ‚¨æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿ', {
            icon: 3,
            title: 'ç¡®è®¤å–æ¶ˆ'
          }, function(index) {
            // æ¢å¤åŸå§‹æ•°æ®
            if (hot && originalData) {
              hot.loadData(JSON.parse(JSON.stringify(originalData)));
              calculateSales(hot.getSourceData(), hot.getSettings().columns);
              applyOfflineStyles();
            }
            disableEditMode();
            layer.close(index);
          });
        } else {
          disableEditMode();
        }
      });

      $('#addNewProductBtn').on('click', function(){
        // æ¸…ç©ºè¡¨å•
        form.val('addNewProductForm', {
          sku: '',
          name: '',
          url: '',
          initialStock: ''
        });
        
        layer.open({
          type: 1,
          title: 'ä¸Šæ–°äº§å“',
          area: ['450px', '400px'],
          content: $('#addNewProductModal'),
          btn: [],
          shadeClose: true
        });
      });

      $('#cancelNewProduct').on('click', function(){
        layer.closeAll();
      });

      $('#batchAddProductBtn').on('click', function(){
        layer.open({
          type: 1,
          title: 'æ‰¹é‡ä¸Šæ–°äº§å“',
          area: ['600px', '500px'],
          content: $('#batchAddProductModal'),
          btn: [],
          shadeClose: true
        });
      });

      $('#cancelBatchAdd').on('click', function(){
        layer.closeAll();
      });

      // ä¸‹è½½æ‰¹é‡ä¸Šæ–°æ¨¡æ¿
      $('#downloadBatchTemplate').on('click', function() {
        const colHeaders = ['SKU', 'äº§å“ä¸­æ–‡å', 'ç½‘é¡µé“¾æ¥', 'åˆå§‹åº“å­˜'];
        const sampleData = [
          ['X000001234_Black_M', 'Arc\'teryx Beta AR å¤¹å…‹ é»‘è‰² Mç ', 'https://arcteryx.com/fr/zh/shop/mens/beta-ar-jacket', '15'],
          ['X000001234_Black_L', 'Arc\'teryx Beta AR å¤¹å…‹ é»‘è‰² Lç ', 'https://arcteryx.com/fr/zh/shop/mens/beta-ar-jacket', '20'],
          ['X000005678_Blue_S', 'Arc\'teryx Gamma SL çŸ­è£¤ è“è‰² Sç ', 'https://arcteryx.com/fr/zh/shop/mens/gamma-sl-short', '10']
        ];
        
        const ws = XLSX.utils.aoa_to_sheet([colHeaders, ...sampleData]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'æ‰¹é‡ä¸Šæ–°æ¨¡æ¿');
        XLSX.writeFile(wb, 'batch-add-products-template.xlsx');
        
        layer.msg('æ¨¡æ¿ä¸‹è½½æˆåŠŸ', {icon: 1});
      });

      // é€‰æ‹©æ‰¹é‡ä¸Šæ–°æ–‡ä»¶
      $('#selectBatchFile').on('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls,.csv';
        input.onchange = function(e) {
          const file = e.target.files[0];
          if (!file) return;
          
          processBatchFile(file);
        };
        input.click();
      });

      // å¤„ç†æ‰¹é‡æ–‡ä»¶
      function processBatchFile(file) {
        const statusDiv = $('#batchUploadStatus');
        const statusInfo = statusDiv.find('.status-info');
        
        statusDiv.removeClass('success error processing').addClass('processing').show();
        statusInfo.html('<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> æ­£åœ¨è§£æExcelæ–‡ä»¶...');
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            if (jsonData.length < 2) {
              throw new Error('Excelæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šè‡³å°‘éœ€è¦åŒ…å«æ ‡é¢˜è¡Œå’Œä¸€è¡Œæ•°æ®');
            }
            
            // è·³è¿‡æ ‡é¢˜è¡Œï¼Œå¤„ç†æ•°æ®è¡Œ
            const products = [];
            const errors = [];
            const today = new Date();
            const todayKey = today.toISOString().split('T')[0];
            
            for (let i = 1; i < jsonData.length; i++) {
              const row = jsonData[i];
              if (!row || row.length < 4) {
                errors.push(`ç¬¬${i+1}è¡Œï¼šæ•°æ®ä¸å®Œæ•´`);
                continue;
              }
              
              const [sku, name, url, stock] = row;
              
              if (!sku || !name || !stock) {
                errors.push(`ç¬¬${i+1}è¡Œï¼šSKUã€äº§å“åç§°å’Œåº“å­˜ä¸ºå¿…å¡«é¡¹`);
                continue;
              }
              
              if (isNaN(stock) || parseInt(stock) < 0) {
                errors.push(`ç¬¬${i+1}è¡Œï¼šåº“å­˜å¿…é¡»æ˜¯éè´Ÿæ•°å­—`);
                continue;
              }
              
              const product = {
                SKU: String(sku).trim(),
                'äº§å“ä¸­æ–‡å': String(name).trim(),
                'ç½‘é¡µé“¾æ¥': url ? String(url).trim() : '',
                'åˆå§‹åº“å­˜': parseInt(stock),
                status: 'online'
              };
              
              // æ·»åŠ ä»Šå¤©çš„åº“å­˜æ•°æ®
              product[todayKey] = parseInt(stock);
              product[todayKey + '_é”€é‡'] = 0;
              
              products.push(product);
            }
            
            if (products.length === 0) {
              throw new Error('æ²¡æœ‰æœ‰æ•ˆçš„äº§å“æ•°æ®');
            }
            
            // æ˜¾ç¤ºè§£æç»“æœ
            let resultHtml = `âœ… æˆåŠŸè§£æ ${products.length} ä¸ªäº§å“`;
            if (errors.length > 0) {
              resultHtml += `<br>âš ï¸ ${errors.length} ä¸ªé”™è¯¯ï¼š<br>${errors.slice(0, 3).join('<br>')}`;
              if (errors.length > 3) {
                resultHtml += `<br>...è¿˜æœ‰ ${errors.length - 3} ä¸ªé”™è¯¯`;
              }
            }
            
            statusDiv.removeClass('processing error').addClass('success');
            statusInfo.html(resultHtml + '<br><br><button class="layui-btn layui-btn-sm layui-btn-normal" onclick="confirmBatchAdd()">ç¡®è®¤æ·»åŠ </button>');
            
            // ä¿å­˜äº§å“æ•°æ®åˆ°å…¨å±€å˜é‡
            window.pendingBatchProducts = products;
            
          } catch (error) {
            statusDiv.removeClass('processing success').addClass('error');
            statusInfo.html(`âŒ è§£æå¤±è´¥ï¼š${error.message}`);
          }
        };
        
        reader.readAsArrayBuffer(file);
      }

      // ç¡®è®¤æ‰¹é‡æ·»åŠ 
      window.confirmBatchAdd = function() {
        if (!window.pendingBatchProducts || window.pendingBatchProducts.length === 0) {
          layer.msg('æ²¡æœ‰å¾…æ·»åŠ çš„äº§å“', {icon: 2});
          return;
        }
        
        const statusDiv = $('#batchUploadStatus');
        const statusInfo = statusDiv.find('.status-info');
        
        statusDiv.removeClass('success error').addClass('processing');
        statusInfo.html('<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> æ­£åœ¨æ·»åŠ äº§å“åˆ°æ•°æ®åº“...');
        
        // è·å–ç°æœ‰æ•°æ®å¹¶æ£€æŸ¥SKUé‡å¤
        if (hot) {
          const existingData = hot.getSourceData();
          const existingSkus = new Set(existingData.map(row => row.SKU).filter(Boolean));
          
          // è¿‡æ»¤æ‰é‡å¤çš„SKU
          const newProducts = window.pendingBatchProducts.filter(product => !existingSkus.has(product.SKU));
          const duplicateCount = window.pendingBatchProducts.length - newProducts.length;
          
          if (newProducts.length === 0) {
            statusDiv.removeClass('processing').addClass('error');
            statusInfo.html('âŒ æ‰€æœ‰äº§å“SKUéƒ½å·²å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ ');
            return;
          }
          
          // åˆå¹¶æ•°æ®
          const updatedData = [...existingData, ...newProducts];
          
          // ä¿å­˜åˆ°åç«¯
          var token = localStorage.getItem('token');
          var headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = 'Bearer ' + token;
          }
          
          $.ajax({
            url: window.apiConfig.baseURL + '/api/localdb/wide',
            type: 'POST',
            headers: headers,
            data: JSON.stringify({ data: updatedData }),
            success: function(res) {
              if(res.success) {
                let resultHtml = `âœ… æˆåŠŸæ·»åŠ  ${newProducts.length} ä¸ªæ–°äº§å“`;
                if (duplicateCount > 0) {
                  resultHtml += `<br>âš ï¸ è·³è¿‡ ${duplicateCount} ä¸ªé‡å¤SKU`;
                }
                
                statusDiv.removeClass('processing').addClass('success');
                statusInfo.html(resultHtml);
                
                // åˆ·æ–°è¡¨æ ¼
                setTimeout(() => {
                  layer.closeAll();
                  initWideTable();
                  layer.msg('æ‰¹é‡ä¸Šæ–°æˆåŠŸï¼', {icon: 1});
                }, 2000);
                
              } else {
                statusDiv.removeClass('processing').addClass('error');
                statusInfo.html('âŒ ä¿å­˜å¤±è´¥: ' + res.error);
              }
            },
            error: function(xhr) {
              statusDiv.removeClass('processing').addClass('error');
              if (xhr.status === 401) {
                statusInfo.html('âŒ è¯·å…ˆç™»å½•');
              } else {
                statusInfo.html('âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
              }
            }
          });
        }
      };

      $('#refreshBtn').on('click', function() {
        if (hasUnsavedChanges) {
          layer.confirm('æ‚¨æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œåˆ·æ–°å°†ä¸¢å¤±ä¿®æ”¹ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ', {
            icon: 3,
            title: 'ç¡®è®¤åˆ·æ–°'
          }, function(index) {
            disableEditMode();
            initWideTable();
            layer.close(index);
          });
        } else {
          initWideTable();
        }
      });

      // ä¿å­˜æŒ‰é’®äº‹ä»¶
      $('#saveWideTableBtn').on('click', function() {
        if (!hot) return;
        var data = hot.getSourceData();
        var columns = hot.getSettings().columns;
        calculateSales(data, columns);
        var token = localStorage.getItem('token');
        var headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['Authorization'] = 'Bearer ' + token;
        }
        layer.msg('æ­£åœ¨ä¿å­˜...', {icon: 16, time: 0});
        $.ajax({
          url: window.apiConfig.baseURL + '/api/localdb/wide',
          type: 'POST',
          headers: headers,
          data: JSON.stringify({ data: data }),
          success: function(res) {
            layer.closeAll();
            if(res.success) {
              layer.msg('ä¿å­˜æˆåŠŸ', {icon:1});
              // ä¿å­˜æˆåŠŸåæ›´æ–°åŸå§‹æ•°æ®å¹¶å…³é—­ç¼–è¾‘æ¨¡å¼
              originalData = JSON.parse(JSON.stringify(data));
              disableEditMode();
              initWideTable();
            } else {
              layer.msg('ä¿å­˜å¤±è´¥: ' + res.error, {icon:2});
            }
          },
          error: function(xhr) {
            layer.closeAll();
            if (xhr.status === 401) {
              layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){
                window.location.href = 'login.html';
              });
            } else {
              layer.msg('ä¿å­˜å¤±è´¥', {icon:2});
            }
          }
        });
      });

      $('#importBtn').on('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls,.csv';
        input.onchange = async function(e) {
          const file = e.target.files[0];
          if (!file) return;
          try {
            layer.msg('æ­£åœ¨è§£æExcel...', {icon: 16, time: 0});
            const data = await parseExcelToLocalWideJSON(file);
            layer.msg('æ­£åœ¨æäº¤æ•°æ®...', {icon: 16, time: 0});
            var token = localStorage.getItem('token');
            var headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = 'Bearer ' + token;
            $.ajax({
              url: window.apiConfig.baseURL + '/api/localdb/wide',
              type: 'POST',
              headers: headers,
              data: JSON.stringify({ data }),
              success: function(res) {
                layer.closeAll();
                if(res.success) { layer.msg('å¯¼å…¥æˆåŠŸ', {icon:1}); initWideTable(); }
                else { layer.msg('å¯¼å…¥å¤±è´¥: ' + (res.error||'æœªçŸ¥é”™è¯¯'), {icon:2}); }
              },
              error: function(xhr) { layer.closeAll(); if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href='login.html'; }); } else { layer.msg('å¯¼å…¥å¤±è´¥', {icon:2}); } }
            });
          } catch (err) {
            layer.closeAll();
            layer.msg('è§£æå¤±è´¥: ' + err.message, {icon:2});
          }
        };
        input.click();
      });

      $('#exportBtn').on('click', function() {
        var token = localStorage.getItem('token');
        var headers = {};
        if (token) {
          headers['Authorization'] = 'Bearer ' + token;
        }
        
        $.ajax({
          url: window.apiConfig.baseURL + '/api/localdb/wide/export',
          type: 'GET',
          headers: headers,
          xhrFields: {
            responseType: 'blob'
          },
          success: function(data) {
            const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'wide-table-export.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            layer.msg('å¯¼å‡ºæˆåŠŸ', {icon:1});
          },
          error: function(xhr) {
            if (xhr.status === 401) {
              layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){
                window.location.href = 'login.html';
              });
            } else {
              layer.msg('å¯¼å‡ºå¤±è´¥', {icon:2});
            }
          }
        });
      });

      $('#clearAllDataBtn').on('click', function() {
        layer.confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰å®½è¡¨æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ', {
          icon: 3,
          title: 'ç¡®è®¤æ¸…ç©º',
          btn: ['ç¡®å®šæ¸…ç©º', 'å–æ¶ˆ']
        }, function(index) {
          var token = localStorage.getItem('token');
          var headers = {};
          if (token) {
            headers['Authorization'] = 'Bearer ' + token;
          }
          
          $.ajax({
            url: window.apiConfig.baseURL + '/api/localdb/wide/clear-all',
            type: 'POST',
            headers: headers,
            success: function(res) {
              if(res.success) {
                layer.msg('æ¸…ç©ºæˆåŠŸ: ' + res.message, {icon:1});
                initWideTable();
              } else {
                layer.msg('æ¸…ç©ºå¤±è´¥: ' + res.error, {icon:2});
              }
            },
            error: function(xhr) {
              if (xhr.status === 401) {
                layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){
                  window.location.href = 'login.html';
                });
              } else {
                layer.msg('æ¸…ç©ºå¤±è´¥', {icon:2});
              }
            }
          });
          layer.close(index);
        });
      });

      // è¡Œè®°å½•æ¨¡å¼æŒ‰é’®äº‹ä»¶
      $('#addRecordBtn').on('click', function(){
        form.val('editForm', {sku:'', name:'', url:'', initialStock:'', date:'', stock:''});
        layer.open({
          type:1, title:'æ–°å¢è®°å½•', area:['400px','480px'], content:$('#editFormModal'),
          btn:[], shadeClose:true
        });
      });

      $('#refreshRecordBtn').on('click', renderRecordTable);

      $('#importRecordBtn').on('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls,.csv';
        input.onchange = function(e) {
          const file = e.target.files[0];
          if (!file) return;
          
          var token = localStorage.getItem('token');
          var formData = new FormData();
          formData.append('file', file);
          
          var headers = {};
          if (token) {
            headers['Authorization'] = 'Bearer ' + token;
          }
          
          $.ajax({
            url: window.apiConfig.baseURL + '/api/localdb/records/batch',
            type: 'POST',
            headers: headers,
            data: formData,
            processData: false,
            contentType: false,
            success: function(res) {
              if(res.success) {
                layer.msg('å¯¼å…¥æˆåŠŸ: ' + res.message, {icon:1});
                renderRecordTable();
              } else {
                layer.msg('å¯¼å…¥å¤±è´¥: ' + res.error, {icon:2});
              }
            },
            error: function(xhr) {
              if (xhr.status === 401) {
                layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){
                  window.location.href = 'login.html';
                });
              } else {
                layer.msg('å¯¼å…¥å¤±è´¥', {icon:2});
              }
            }
          });
        };
        input.click();
      });

      $('#exportRecordBtn').on('click', function() {
        var token = localStorage.getItem('token');
        var headers = {};
        if (token) {
          headers['Authorization'] = 'Bearer ' + token;
        }
        
        $.ajax({
          url: window.apiConfig.baseURL + '/api/localdb/records/export',
          type: 'GET',
          headers: headers,
          xhrFields: {
            responseType: 'blob'
          },
          success: function(data) {
            const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'records-export.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            layer.msg('å¯¼å‡ºæˆåŠŸ', {icon:1});
          },
          error: function(xhr) {
            if (xhr.status === 401) {
              layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){
                window.location.href = 'login.html';
              });
            } else {
              layer.msg('å¯¼å‡ºå¤±è´¥', {icon:2});
            }
          }
        });
      });

      $('#downloadRecordTemplateBtn').on('click', function() {
        const colHeaders = ['SKU', 'äº§å“ä¸­æ–‡å', 'ç½‘é¡µé“¾æ¥', 'åˆå§‹åº“å­˜', 'æ—¥æœŸï¼ˆYYYY-MM-DD HH:mmï¼‰', 'åº“å­˜'];
        const ws = XLSX.utils.aoa_to_sheet([colHeaders]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'è®°å½•æ¨¡æ¿');
        XLSX.writeFile(wb, 'records-template.xlsx');
      });

      // è§£æâ€œæœ¬åœ°æ•°æ®åº“å®½è¡¨â€Excel â†’ JSON
      async function parseExcelToLocalWideJSON(file) {
        const arrayBuffer = await file.arrayBuffer();
        const wb = XLSX.read(arrayBuffer, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        if (!rows.length) throw new Error('æœªè¯†åˆ«åˆ°æ•°æ®');
        // æ”¯æŒä¸¤ç§è¡¨å¤´ï¼š
        // A) SKU/äº§å“ä¸­æ–‡å/ç½‘é¡µé“¾æ¥/åˆå§‹åº“å­˜/æ—¥æœŸåˆ—...
        // B) ç³»ç»Ÿå±¥çº¦å•å·/åº—é“ºè®¢å•æ—¶é—´/SKU/å•†å“æ•°é‡ï¼ˆå°†èšåˆåˆ°ä»Šå¤©æ—¥æœŸåˆ—ï¼‰
        const first = rows[0];
        const hasLocalWide = ('SKU' in first) && ('äº§å“ä¸­æ–‡å' in first);
        const hasTmallDetail = ('ç³»ç»Ÿå±¥çº¦å•å·' in first) && ('åº—é“ºè®¢å•æ—¶é—´' in first) && ('SKU' in first) && ('å•†å“æ•°é‡' in first);
        const todayKey = new Date().toISOString().split('T')[0];
        if (hasLocalWide) {
          // ç›´æ¥è¿”å›ä¸ºå®½è¡¨ç»“æ„
          return rows.map(r => ({ ...r }));
        } else if (hasTmallDetail) {
          // å°†æ˜ç»†èšåˆä¸ºæœ¬åœ°å®½è¡¨ç»“æ„ï¼ˆä»¥ä»Šå¤©ä¸ºåº“å­˜åˆ—ï¼Œæ•°é‡ç´¯åŠ ï¼‰
          const skuMap = {};
          rows.forEach(r => {
            const sku = String(r['SKU']).trim();
            const qty = parseInt(r['å•†å“æ•°é‡'] || 0) || 0;
            if (!sku) return;
            if (!skuMap[sku]) skuMap[sku] = { SKU: sku, 'äº§å“ä¸­æ–‡å': '', 'ç½‘é¡µé“¾æ¥': '', 'åˆå§‹åº“å­˜': 0 };
            skuMap[sku][todayKey] = (skuMap[sku][todayKey] || 0) + qty;
            skuMap[sku][todayKey + '_é”€é‡'] = 0;
          });
          return Object.values(skuMap);
        }
        throw new Error('æ— æ³•è¯†åˆ«è¡¨å¤´ï¼Œè¯·æä¾›â€œSKU/äº§å“ä¸­æ–‡å/ç½‘é¡µé“¾æ¥/åˆå§‹åº“å­˜â€æˆ–â€œç³»ç»Ÿå±¥çº¦å•å·/åº—é“ºè®¢å•æ—¶é—´/SKU/å•†å“æ•°é‡â€æ ¼å¼');
      }

      $('#clearAllRecordDataBtn').on('click', function() {
        layer.confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ', {
          icon: 3,
          title: 'ç¡®è®¤æ¸…ç©º',
          btn: ['ç¡®å®šæ¸…ç©º', 'å–æ¶ˆ']
        }, function(index) {
          var token = localStorage.getItem('token');
          var headers = {};
          if (token) {
            headers['Authorization'] = 'Bearer ' + token;
          }
          
          $.ajax({
            url: window.apiConfig.baseURL + '/api/localdb/records/clear-all',
            type: 'POST',
            headers: headers,
            success: function(res) {
              if(res.success) {
                layer.msg('æ¸…ç©ºæˆåŠŸ: ' + res.message, {icon:1});
                renderRecordTable();
              } else {
                layer.msg('æ¸…ç©ºå¤±è´¥: ' + res.error, {icon:2});
              }
            },
            error: function(xhr) {
              if (xhr.status === 401) {
                layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){
                  window.location.href = 'login.html';
                });
              } else {
                layer.msg('æ¸…ç©ºå¤±è´¥', {icon:2});
              }
            }
          });
          layer.close(index);
        });
      });

      // ç¼–è¾‘/åˆ é™¤
      table.on('tool(recordTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'edit'){
          form.val('editForm', {
            sku: data.SKU,
            name: data['äº§å“ä¸­æ–‡å'],
            url: data['ç½‘é¡µé“¾æ¥'],
            initialStock: data['åˆå§‹åº“å­˜'],
            date: data['æ—¥æœŸ'],
            stock: data['åº“å­˜']
          });
          layer.open({
            type:1, title:'ç¼–è¾‘è®°å½•', area:['400px','480px'], content:$('#editFormModal'),
            btn:[], shadeClose:true
          });
          $('#editFormModal').data('editId', data.id);
        } else if(obj.event === 'del'){
          layer.confirm('ç¡®å®šè¦åˆ é™¤è¯¥è®°å½•å—ï¼Ÿ', function(index){
            var token = localStorage.getItem('token');
            var headers = {};
            if (token) {
              headers['Authorization'] = 'Bearer ' + token;
            }
            
            $.ajax({
              url: window.apiConfig.baseURL + '/api/localdb/records/'+data.id,
              type: 'DELETE',
              headers: headers,
              success: function(res){
                if(res.success){
                  layer.msg('åˆ é™¤æˆåŠŸ', {icon:1});
                  renderRecordTable();
                }else{
                  layer.msg('åˆ é™¤å¤±è´¥: '+res.error, {icon:2});
                }
              },
              error: function(xhr) {
                if (xhr.status === 401) {
                  layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){
                    window.location.href = 'login.html';
                  });
                } else {
                  layer.msg('åˆ é™¤å¤±è´¥', {icon:2});
                }
              }
            });
            layer.close(index);
          });
        }
      });

      // è¡¨å•æäº¤
      form.on('submit(submitEdit)', function(formObj){
        var editId = $('#editFormModal').data('editId');
        var method = editId ? 'PUT' : 'POST';
        var url = window.apiConfig.baseURL + '/api/localdb/records' + (editId ? ('/'+editId) : '');
        var data = {
          SKU: formObj.field.sku,
          'äº§å“ä¸­æ–‡å': formObj.field.name,
          'ç½‘é¡µé“¾æ¥': formObj.field.url,
          'åˆå§‹åº“å­˜': formObj.field.initialStock,
          'æ—¥æœŸ': formObj.field.date,
          'åº“å­˜': formObj.field.stock
        };
        
        var token = localStorage.getItem('token');
        var headers = {
          'Content-Type': 'application/json'
        };
        if (token) {
          headers['Authorization'] = 'Bearer ' + token;
        }
        
        $.ajax({
          url: url,
          type: method,
          headers: headers,
          data: JSON.stringify(data),
          success: function(res){
            if(res.success){
              layer.msg('ä¿å­˜æˆåŠŸ', {icon:1});
              layer.closeAll();
              if (currentMode === 'record') {
                renderRecordTable();
              }
            }else{
              layer.msg('ä¿å­˜å¤±è´¥: '+res.error, {icon:2});
            }
          },
          error: function(xhr) {
            if (xhr.status === 401) {
              layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){
                window.location.href = 'login.html';
              });
            } else {
              layer.msg('ä¿å­˜å¤±è´¥', {icon:2});
            }
          }
        });
        return false;
      });

      // æ–°äº§å“è¡¨å•æäº¤
      form.on('submit(submitNewProduct)', function(formObj){
        var today = new Date();
        var dateStr = today.getFullYear() + '-' + 
                     String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                     String(today.getDate()).padStart(2, '0') + ' ' +
                     String(today.getHours()).padStart(2, '0') + ':' +
                     String(today.getMinutes()).padStart(2, '0');
        
        var newProduct = {
          SKU: formObj.field.sku,
          'äº§å“ä¸­æ–‡å': formObj.field.name,
          'ç½‘é¡µé“¾æ¥': formObj.field.url,
          'åˆå§‹åº“å­˜': parseInt(formObj.field.initialStock),
          status: 'online' // æ–°äº§å“é»˜è®¤ä¸Šæ¶
        };
        
        // æ·»åŠ ä»Šå¤©çš„åº“å­˜æ•°æ®
        var todayKey = today.toISOString().split('T')[0];
        newProduct[todayKey] = parseInt(formObj.field.initialStock);
        newProduct[todayKey + '_é”€é‡'] = 0;
        
        // æ£€æŸ¥SKUæ˜¯å¦å·²å­˜åœ¨
        if (hot) {
          var existingData = hot.getSourceData();
          var skuExists = existingData.some(row => row.SKU === formObj.field.sku);
          if (skuExists) {
            layer.msg('SKUå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„SKU', {icon: 2});
            return false;
          }
          
          // æ·»åŠ åˆ°è¡¨æ ¼
          existingData.push(newProduct);
          
          // ä¿å­˜æ•°æ®
          var token = localStorage.getItem('token');
          var headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = 'Bearer ' + token;
          }
          
          layer.msg('æ­£åœ¨æ·»åŠ æ–°äº§å“...', {icon: 16, time: 0});
          $.ajax({
            url: window.apiConfig.baseURL + '/api/localdb/wide',
            type: 'POST',
            headers: headers,
            data: JSON.stringify({ data: existingData }),
            success: function(res) {
              layer.closeAll();
              if(res.success) {
                layer.msg('æ–°äº§å“æ·»åŠ æˆåŠŸ', {icon:1});
                layer.closeAll();
                initWideTable();
              } else {
                layer.msg('æ·»åŠ å¤±è´¥: ' + res.error, {icon:2});
              }
            },
            error: function(xhr) {
              layer.closeAll();
              if (xhr.status === 401) {
                layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){
                  window.location.href = 'login.html';
                });
              } else {
                layer.msg('æ·»åŠ å¤±è´¥', {icon:2});
              }
            }
          });
        }
        return false;
      });

      // åˆå§‹åŠ è½½å®½è¡¨æ¨¡å¼
      initWideTable();
    });

    // é€€å‡ºç™»å½•
    function logout() {
      layer.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', {icon: 3, title: 'æç¤º'}, function(index){
        localStorage.removeItem('currentUser');
        layer.close(index);
        layer.msg('å·²å®‰å…¨é€€å‡ºï¼', {icon: 1}, function(){
          window.location.href = 'login.html';
        });
      });
    }

    // åˆ‡æ¢è´¦æˆ·
    function switchAccount() {
      layer.confirm('åˆ‡æ¢è´¦æˆ·å°†é€€å‡ºå½“å‰ç™»å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ', {
        icon: 3, 
        title: 'åˆ‡æ¢è´¦æˆ·',
        btn: ['ç¡®å®š', 'å–æ¶ˆ']
      }, function(index) {
        localStorage.removeItem('currentUser');
        layer.close(index);
        layer.msg('æ­£åœ¨åˆ‡æ¢è´¦æˆ·...', {icon: 16, time: 1000}, function(){
          window.location.href = 'login.html';
        });
      });
    }
  </script>
  <!-- Handsontable JS -->
  <script src="https://cdn.jsdelivr.net/npm/handsontable@16.0.1/dist/handsontable.full.min.js"></script>
  <script>
    // æ³¨å†Œä¸­æ–‡è¯­è¨€ï¼Œé¿å… zh-CN æœªæ‰¾åˆ°
    (function(){
      try {
        if (window.Handsontable && window.Handsontable.languages && window.Handsontable.languages.registerLanguageDictionary) {
          const zhCN = {
            languageCode: 'zh-CN'
          };
          window.Handsontable.languages.registerLanguageDictionary(zhCN);
        }
      } catch (e) { console.warn('Handsontable i18n æ³¨å†Œå¤±è´¥', e); }
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</body>
</html>