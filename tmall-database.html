<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å¤©çŒ«æ•°æ®åº“ç®¡ç† - æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
  <link href="./src/css/layui.css" rel="stylesheet">
  <link href="./src/css/app-header.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@16.0.1/dist/handsontable.full.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@16.0.1/styles/ht-theme-main.min.css">
  <style>
    body { background: #f8f9fa; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; }
    .header .layui-nav { background: transparent; }
    .header .layui-nav .layui-nav-item a { color: rgba(255,255,255,0.9); }
    .header .layui-nav .layui-nav-item a:hover { color: white; }
    .header .logo { font-size: 18px; font-weight: bold; white-space: nowrap; }
    .main-nav { flex: 1; display: flex; justify-content: center; margin: 0 20px; }
    .main-nav .layui-nav-item { margin: 0 5px; }
    .main-nav .layui-nav-item a { padding: 0 20px; border-radius: 6px; transition: all 0.3s ease; font-size: 14px; }
    .main-nav .layui-nav-item a:hover, .main-nav .layui-nav-item.layui-this a { background: rgba(255,255,255,0.2); color: white; }
    .main-nav .layui-nav-item a i { margin-right: 6px; }
    .header .user-info { white-space: nowrap; }
    .user-info .layui-nav-child dd a { padding: 10px 15px; color: #666; transition: all 0.3s ease; }
    .user-info .layui-nav-child dd a:hover { background: #f8f9fa; color: #16baaa; }
    .user-info .layui-nav-child dd a i { margin-right: 8px; font-size: 14px; }
    .content-wrapper { padding: 20px; }
    .page-header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .page-title { font-size: 24px; font-weight: bold; color: #333; margin: 0; }
    .page-subtitle { color: #666; margin-top: 5px; }
    .breadcrumb { color: #999; font-size: 14px; margin-top: 10px; }
    .breadcrumb a { color: #16baaa; text-decoration: none; }
    .mode-switch { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
    .mode-switch .layui-btn { margin: 0 10px; border-radius: 6px; transition: all 0.3s ease; }
    .mode-switch .layui-btn.layui-btn-primary { background: #f8f9fa; border: 1px solid #e6e6e6; color: #666; }
    .mode-switch .layui-btn.active { background: #16baaa; color: white; border-color: #16baaa; }
    .mode-switch .layui-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .mode-description { text-align: center; color: #666; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #16baaa; }
    .table-container { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 20px; }
    .table-header { padding: 20px; border-bottom: 1px solid #f0f0f0; background: #fafafa; }
    .table-stats { display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #666; }
    .action-buttons { text-align: right; margin-bottom: 15px; }
    .action-buttons .layui-btn { margin-left: 10px; border-radius: 6px; transition: all 0.3s ease; }
    .action-buttons .layui-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .wide-table-container, .record-table-container { display: none; }
    .wide-table-container.active, .record-table-container.active { display: block; }
    .handsontable-container { padding: 20px; }
    .layui-table-cell { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>
<body>
  <div class="layui-header header">
    <div class="logo">ğŸ“Š æ•°æ®ç®¡ç†ç³»ç»Ÿ</div>
    <ul class="layui-nav main-nav">
      <li class="layui-nav-item"><a href="dashboard.html"><i class="layui-icon layui-icon-home"></i> æ•°æ®ä»ªè¡¨ç›˜</a></li>
      <li class="layui-nav-item"><a href="table-management.html"><i class="layui-icon layui-icon-table"></i> è¡¨æ ¼ç®¡ç†</a></li>
      <li class="layui-nav-item"><a href="data-upload.html"><i class="layui-icon layui-icon-upload-drag"></i> æ•°æ®å¯¼å…¥</a></li>
      <li class="layui-nav-item"><a href="data-analysis.html"><i class="layui-icon layui-icon-chart"></i> æ•°æ®åˆ†æ</a></li>
      <li class="layui-nav-item"><a href="local-database.html"><i class="layui-icon layui-icon-database"></i> æœ¬åœ°æ•°æ®åº“</a></li>
      <li class="layui-nav-item layui-this"><a href="tmall-database.html"><i class="layui-icon layui-icon-cart"></i> å¤©çŒ«æ•°æ®åº“</a></li>
      <li class="layui-nav-item" id="adminOnlyTopNav" style="display: none;"><a href="user-management.html"><i class="layui-icon layui-icon-username"></i> ç”¨æˆ·ç®¡ç†</a></li>
    </ul>
    <ul class="layui-nav layui-layout-right user-info">
      <li class="layui-nav-item">
        <a href="javascript:;"><span id="currentUser">ç”¨æˆ·</span></a>
        <dl class="layui-nav-child">
          <dd><a href="profile.html"><i class="layui-icon layui-icon-username"></i> ä¸ªäººä¿¡æ¯</a></dd>
          <dd><a href="javascript:;" onclick="switchAccount()"><i class="layui-icon layui-icon-refresh-3"></i> åˆ‡æ¢è´¦å·</a></dd>
          <dd><a href="javascript:;" onclick="logout()"><i class="layui-icon layui-icon-logout"></i> ç™»å‡º</a></dd>
        </dl>
      </li>
    </ul>
  </div>
  <div class="content-wrapper">
    <div class="page-header">
      <h1 class="page-title">ğŸ›’ å¤©çŒ«æ•°æ®åº“ç®¡ç†</h1>
      <p class="page-subtitle">ç®¡ç†æ‚¨çš„å¤©çŒ«è®¢å•SKUåº“å­˜å’Œé”€å”®æ•°æ®</p>
      <div class="breadcrumb"><a href="dashboard.html">é¦–é¡µ</a> / å¤©çŒ«æ•°æ®åº“</div>
    </div>
    <div class="mode-switch">
      <button class="layui-btn layui-btn-primary active" id="wideTableMode"><i class="layui-icon layui-icon-table"></i> å®½è¡¨æ¨¡å¼ï¼ˆæœ€è¿‘5å¤©ï¼‰</button>
      <button class="layui-btn layui-btn-primary" id="recordMode"><i class="layui-icon layui-icon-list"></i> è¡Œè®°å½•æ¨¡å¼ï¼ˆå†å²æ•°æ®ï¼‰</button>
    </div>
    <div class="mode-description" id="modeDescription">å®½è¡¨æ¨¡å¼ï¼šé€‚åˆæ—¥å¸¸å¿«é€Ÿå½•å…¥å’ŒæŸ¥çœ‹æœ€è¿‘5å¤©çš„å¤©çŒ«è®¢å•æ•°æ®ï¼Œæ”¯æŒæ‰¹é‡ç¼–è¾‘</div>
    <div class="wide-table-container active" id="wideTableContainer">
      <div class="table-container">
        <div class="table-header">
          <div class="table-stats"><span>å®½è¡¨æ•°æ®ç®¡ç†</span><span>æœ€è¿‘5å¤©å¤©çŒ«è®¢å•æ•°æ®</span></div>
        </div>
        <div class="action-buttons">
          <button class="layui-btn layui-btn-normal" id="addRowBtn"><i class="layui-icon layui-icon-add-1"></i> æ–°å¢è®°å½•</button>
          <button class="layui-btn layui-btn-primary" id="refreshBtn"><i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°</button>
          <button class="layui-btn layui-btn-danger" id="saveWideTableBtn"><i class="layui-icon layui-icon-ok"></i> ä¿å­˜</button>
          <button class="layui-btn layui-btn-lg" id="smartImportBtn"><i class="layui-icon layui-icon-magic"></i> æ™ºèƒ½å¯¼å…¥</button>
          <button class="layui-btn" id="importBtn"><i class="layui-icon layui-icon-upload"></i> å¯¼å…¥Excel</button>
          <button class="layui-btn" id="exportBtn"><i class="layui-icon layui-icon-download-circle"></i> å¯¼å‡ºExcel</button>
          <button class="layui-btn layui-btn-warm" id="downloadTemplateBtn"><i class="layui-icon layui-icon-template"></i> ä¸‹è½½æ¨¡æ¿</button>
          <button class="layui-btn layui-btn-danger" id="clearOldDataBtn"><i class="layui-icon layui-icon-delete"></i> æ¸…ç†æ—§æ•°æ®</button>
          <button class="layui-btn layui-btn-danger" id="clearAllDataBtn"><i class="layui-icon layui-icon-close"></i> æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>
        <div class="handsontable-container"><div id="wideTable" style="width:100%;min-height:500px;"></div></div>
      </div>
    </div>
    <div class="record-table-container" id="recordTableContainer">
      <div class="table-container">
        <div class="table-header"><div class="table-stats"><span>å†å²è®°å½•ç®¡ç†</span><span>å¤©çŒ«è®¢å•å†å²æ•°æ®æŸ¥è¯¢</span></div></div>
        <div class="action-buttons">
          <button class="layui-btn" id="addRecordBtn"><i class="layui-icon layui-icon-add-1"></i> æ–°å¢è®°å½•</button>
          <button class="layui-btn layui-btn-primary" id="refreshRecordBtn"><i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°</button>
          <button class="layui-btn" id="importRecordBtn"><i class="layui-icon layui-icon-upload"></i> æ‰¹é‡å¯¼å…¥</button>
          <button class="layui-btn" id="exportRecordBtn"><i class="layui-icon layui-icon-download-circle"></i> å¯¼å‡ºæ•°æ®</button>
          <button class="layui-btn layui-btn-warm" id="downloadRecordTemplateBtn"><i class="layui-icon layui-icon-template"></i> ä¸‹è½½æ¨¡æ¿</button>
          <button class="layui-btn layui-btn-danger" id="clearAllRecordDataBtn"><i class="layui-icon layui-icon-close"></i> æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>
        <div style="padding: 20px;"><table class="layui-hide" id="recordTable" lay-filter="recordTable"></table></div>
      </div>
    </div>
  </div>
  <div id="editFormModal" style="display:none;padding:20px 30px 0 0;">
    <form class="layui-form" lay-filter="editForm">
      <div class="layui-form-item"><label class="layui-form-label">SKU</label><div class="layui-input-block"><input type="text" name="sku" required lay-verify="required" placeholder="è¯·è¾“å…¥SKU" autocomplete="off" class="layui-input"></div></div>
      <div class="layui-form-item"><label class="layui-form-label">äº§å“ä¸­æ–‡å</label><div class="layui-input-block"><input type="text" name="name" required lay-verify="required" placeholder="è¯·è¾“å…¥äº§å“ä¸­æ–‡å" autocomplete="off" class="layui-input"></div></div>
      <div class="layui-form-item"><label class="layui-form-label">ç½‘é¡µé“¾æ¥</label><div class="layui-input-block"><input type="url" name="url" placeholder="è¯·è¾“å…¥ç½‘é¡µé“¾æ¥" autocomplete="off" class="layui-input"></div></div>
      <div class="layui-form-item"><label class="layui-form-label">åˆå§‹åº“å­˜</label><div class="layui-input-block"><input type="number" name="initialStock" required lay-verify="required|number" placeholder="è¯·è¾“å…¥åˆå§‹åº“å­˜æ•°é‡" autocomplete="off" class="layui-input"></div></div>
      <div class="layui-form-item"><label class="layui-form-label">æ—¥æœŸ</label><div class="layui-input-block"><input type="text" name="date" required lay-verify="required|date" placeholder="å¦‚ 2024-07-18 11:30" autocomplete="off" class="layui-input"></div></div>
      <div class="layui-form-item"><label class="layui-form-label">åº“å­˜</label><div class="layui-input-block"><input type="number" name="stock" required lay-verify="required|number" placeholder="è¯·è¾“å…¥åº“å­˜æ•°é‡" autocomplete="off" class="layui-input"></div></div>
      <div class="layui-form-item"><div class="layui-input-block"><button class="layui-btn" lay-submit lay-filter="submitEdit">ä¿å­˜</button></div></div>
    </form>
  </div>
  <script src="./src/modules/jquery.js"></script>
  <script src="./src/layui.js"></script>
  <script src="./api-config.js"></script>
  <script>
    layui.use(['table', 'layer', 'form'], function(){
      var table = layui.table;
      var layer = layui.layer;
      var form = layui.form;
      var $ = layui.$;

      var currentMode = 'wide';
      var hot = null;
      var userInfo = JSON.parse(localStorage.getItem('currentUser') || '{}');
      if (!userInfo.username) {
        layer.msg('è¯·å…ˆç™»å½•ï¼', {icon: 2}, function(){ window.location.href = 'login.html'; });
        return;
      }
      document.getElementById('currentUser').textContent = userInfo.realname || userInfo.username;
      $('#wideTableMode').on('click', function() { switchMode('wide'); });
      $('#recordMode').on('click', function() { switchMode('record'); });
      function switchMode(mode) {
        currentMode = mode;
        $('.mode-switch .layui-btn').removeClass('active');
        if (mode === 'wide') {
          $('#wideTableMode').addClass('active');
          $('#modeDescription').text('å®½è¡¨æ¨¡å¼ï¼šé€‚åˆæ—¥å¸¸å¿«é€Ÿå½•å…¥å’ŒæŸ¥çœ‹æœ€è¿‘5å¤©çš„å¤©çŒ«è®¢å•æ•°æ®ï¼Œæ”¯æŒæ‰¹é‡ç¼–è¾‘');
        } else {
          $('#recordMode').addClass('active');
          $('#modeDescription').text('è¡Œè®°å½•æ¨¡å¼ï¼šç®¡ç†å¤©çŒ«è®¢å•å†å²æ•°æ®ï¼Œæ”¯æŒå•æ¡è®°å½•æ“ä½œå’Œæ‰¹é‡å¯¼å…¥å¯¼å‡º');
        }
        $('.wide-table-container, .record-table-container').removeClass('active');
        if (mode === 'wide') {
          $('#wideTableContainer').addClass('active');
          initWideTable();
        } else {
          $('#recordTableContainer').addClass('active');
          initRecordTable();
        }
      }
      function initWideTable() {
        if (hot) { hot.destroy(); hot = null; }
        const columns = [
          {data: 'ç³»ç»Ÿå±¥çº¦å•å·', type: 'text'},
          {data: 'åº—é“ºè®¢å•æ—¶é—´', type: 'text'},
          {data: 'SKU', type: 'text'},
          {data: 'å•†å“æ•°é‡', type: 'numeric'}
        ];
        const colHeaders = ['ç³»ç»Ÿå±¥çº¦å•å·', 'åº—é“ºè®¢å•æ—¶é—´', 'SKU', 'å•†å“æ•°é‡'];
        loadWideTableData(columns, colHeaders);
      }
      function loadWideTableData(columns, colHeaders) {
        var token = localStorage.getItem('token');
        var headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        $.ajax({
          url: window.apiConfig.baseURL + '/api/tmall-orders/wide',
          type: 'GET',
          headers: headers,
          success: function(res) {
            if(res.success) {
              hot = new Handsontable(document.getElementById('wideTable'), {
                data: res.data,
                columns: columns,
                colHeaders: colHeaders,
                rowHeaders: true,
                minSpareRows: 1,
                contextMenu: true,
                manualColumnResize: true,
                manualRowResize: true,
                stretchH: 'all',
                height: 600,
                licenseKey: 'non-commercial-and-evaluation',
                language: 'zh-CN',
                dropdownMenu: true,
                filters: true,
                columnSorting: true,
                autoWrapRow: true,
                autoWrapCol: true
              });
              calculateSales(hot.getSourceData(), columns);
              hot.render();
            } else {
              layer.msg('æ•°æ®åŠ è½½å¤±è´¥: ' + res.error, {icon:2});
            }
          },
          error: function(xhr) {
            if (xhr.status === 401) {
              layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; });
            } else {
              layer.msg('æ•°æ®åŠ è½½å¤±è´¥', {icon:2});
            }
          }
        });
      }
      function calculateSales(tableData, columns) {
        const dateCols = columns.map(col => col.data).filter(key => /^\d{4}-\d{2}-\d{2}$/.test(key));
        tableData.forEach(row => {
          dateCols.forEach((dateKey, idx) => {
            const stock = parseInt(row[dateKey]) || 0;
            let prevStock = null;
            for (let j = idx - 1; j >= 0; j--) {
              const prevKey = dateCols[j];
              if (row[prevKey] !== undefined && row[prevKey] !== null && row[prevKey] !== '') {
                prevStock = parseInt(row[prevKey]) || 0;
                break;
              }
            }
            let sales = 0;
            if (prevStock !== null) sales = Math.max(0, prevStock - stock);
            row[dateKey + '_é”€é‡'] = sales;
          });
        });
      }
      function initRecordTable() { renderRecordTable(); }
      function renderRecordTable() {
        var token = localStorage.getItem('token');
        var headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        $.ajax({
          url: window.apiConfig.baseURL + '/api/tmall-orders/records',
          type: 'GET',
          headers: headers,
          success: function(res) {
            if(res.success) {
              table.render({
                elem: '#recordTable',
                data: res.data,
                page: true,
                limit: 20,
                cols: [[
                  {field:'SKU', title:'SKU', width:150, sort:true},
                  {field:'äº§å“ä¸­æ–‡å', title:'äº§å“ä¸­æ–‡å', width:180},
                  {field:'ç½‘é¡µé“¾æ¥', title:'ç½‘é¡µé“¾æ¥', width:220, templet: function(d){ return d['ç½‘é¡µé“¾æ¥'] ? '<a href="'+d['ç½‘é¡µé“¾æ¥']+'" target="_blank">'+d['ç½‘é¡µé“¾æ¥']+'</a>' : ''; }},
                  {field:'åˆå§‹åº“å­˜', title:'åˆå§‹åº“å­˜', width:100, sort:true},
                  {field:'æ—¥æœŸ', title:'æ—¥æœŸ', width:160, sort:true},
                  {field:'åº“å­˜', title:'åº“å­˜', width:100, sort:true},
                  {field:'é”€é‡', title:'é”€é‡', width:100, sort:true, templet: function(d){ return '<span style="color: ' + (d['é”€é‡'] > 0 ? '#52c41a' : '#999') + ';">' + d['é”€é‡'] + '</span>'; }},
                  {title:'æ“ä½œ', width:180, align:'center', toolbar:'#rowBar'}
                ]],
                text: {none: 'æš‚æ— æ•°æ®'}
              });
            } else {
              layer.msg('æ•°æ®åŠ è½½å¤±è´¥: ' + res.error, {icon:2});
            }
          },
          error: function(xhr) {
            if (xhr.status === 401) {
              layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; });
            } else {
              layer.msg('æ•°æ®åŠ è½½å¤±è´¥', {icon:2});
            }
          }
        });
      }
      var rowBarHtml = '<div class="layui-btn-group">'
        +'<button class="layui-btn layui-btn-xs" lay-event="edit">ç¼–è¾‘</button>'
        +'<button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">åˆ é™¤</button>'
        +'</div>';
      $(document.body).append('<script type="text/html" id="rowBar">'+rowBarHtml+'<\/script>');
      $('#addRowBtn').on('click', function(){ if (hot) hot.alter('insert_row', hot.countRows()); });
      $('#refreshBtn').on('click', function() { if (hot) { calculateSales(hot.getSourceData(), hot.getSettings().columns); hot.render(); } initWideTable(); });
      $('#saveWideTableBtn').on('click', function() {
        if (!hot) return;
        var data = hot.getSourceData();
        var columns = hot.getSettings().columns;
        calculateSales(data, columns);
        var token = localStorage.getItem('token');
        var headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = 'Bearer ' + token;
        layer.msg('æ­£åœ¨ä¿å­˜...', {icon: 16, time: 0});
        $.ajax({
          url: '/api/tmall-orders/wide',
          type: 'POST',
          headers: headers,
          data: JSON.stringify({ data: data }),
          success: function(res) {
            layer.closeAll();
            if(res.success) { layer.msg('ä¿å­˜æˆåŠŸ', {icon:1}); initWideTable(); } else { layer.msg('ä¿å­˜å¤±è´¥: ' + res.error, {icon:2}); }
          },
          error: function(xhr) { layer.closeAll(); if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; }); } else { layer.msg('ä¿å­˜å¤±è´¥', {icon:2}); } }
        });
      });
      $('#smartImportBtn').on('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls,.csv';
        input.onchange = async function(e) {
          const file = e.target.files[0];
          if (!file) return;
          try {
            layer.msg('æ­£åœ¨è§£æExcel...', {icon: 16, time: 0});
            const data = await parseExcelToWideJSON(file);
            layer.msg('æ­£åœ¨æäº¤æ•°æ®...', {icon: 16, time: 0});
            const token = localStorage.getItem('token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = 'Bearer ' + token;
            $.ajax({
              url: '/api/tmall-orders/wide/batch',
              type: 'POST',
              headers: headers,
              data: JSON.stringify({ data }),
              success: function(res) {
                layer.closeAll();
                if(res.success) { layer.msg('å¯¼å…¥æˆåŠŸ', {icon:1}); initWideTable(); if (currentMode === 'record') { renderRecordTable(); } }
                else { layer.msg('å¯¼å…¥å¤±è´¥: ' + (res.error||'æœªçŸ¥é”™è¯¯'), {icon:2}); }
              },
              error: function(xhr) { layer.closeAll(); if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; }); } else { layer.msg('å¯¼å…¥å¤±è´¥', {icon:2}); } }
            });
          } catch (err) {
            layer.closeAll();
            layer.msg('è§£æå¤±è´¥: ' + err.message, {icon:2});
          }
        };
        input.click();
      });
      $('#importBtn').on('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls,.csv';
        input.onchange = async function(e) {
          const file = e.target.files[0];
          if (!file) return;
          try {
            layer.msg('æ­£åœ¨è§£æExcel...', {icon: 16, time: 0});
            const data = await parseExcelToWideJSON(file);
            layer.msg('æ­£åœ¨æäº¤æ•°æ®...', {icon: 16, time: 0});
            const token = localStorage.getItem('token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = 'Bearer ' + token;
            $.ajax({
              url: '/api/tmall-orders/wide/batch',
              type: 'POST',
              headers: headers,
              data: JSON.stringify({ data }),
              success: function(res) { layer.closeAll(); if(res.success) { layer.msg('å¯¼å…¥æˆåŠŸ', {icon:1}); initWideTable(); } else { layer.msg('å¯¼å…¥å¤±è´¥: ' + (res.error||'æœªçŸ¥é”™è¯¯'), {icon:2}); } },
              error: function(xhr) { layer.closeAll(); if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; }); } else { layer.msg('å¯¼å…¥å¤±è´¥', {icon:2}); } }
            });
          } catch (err) {
            layer.closeAll();
            layer.msg('è§£æå¤±è´¥: ' + err.message, {icon:2});
          }
        };
        input.click();
      });
      $('#exportBtn').on('click', function() {
        var token = localStorage.getItem('token');
        var headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        $.ajax({
          url: '/api/tmall-orders/wide/export',
          type: 'GET',
          headers: headers,
          xhrFields: { responseType: 'blob' },
          success: function(data) {
            const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tmall-wide-table-export.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            layer.msg('å¯¼å‡ºæˆåŠŸ', {icon:1});
          },
          error: function(xhr) { if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; }); } else { layer.msg('å¯¼å‡ºå¤±è´¥', {icon:2}); } }
        });
      });
      $('#downloadTemplateBtn').on('click', function() {
        const today = new Date();
        const colHeaders = ['SKU', 'äº§å“ä¸­æ–‡å', 'ç½‘é¡µé“¾æ¥', 'åˆå§‹åº“å­˜'];
        for (let i = 4; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];
          colHeaders.push(dateStr);
        }
        const ws = XLSX.utils.aoa_to_sheet([colHeaders]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'å¤©çŒ«å®½è¡¨æ¨¡æ¿');
        XLSX.writeFile(wb, 'tmall-wide-table-template.xlsx');
      });

      // è§£æExcelä¸ºå®½è¡¨JSONï¼ˆç³»ç»Ÿå±¥çº¦å•å·/åº—é“ºè®¢å•æ—¶é—´/SKU/å•†å“æ•°é‡ï¼‰
      async function parseExcelToWideJSON(file) {
        const arrayBuffer = await file.arrayBuffer();
        const wb = XLSX.read(arrayBuffer, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });

        // å°è¯•æ ¹æ®å¸¸è§ä¸­æ–‡åˆ—å¤´è‡ªåŠ¨åŒ¹é…
        const mapKey = (obj, keys) => keys.find(k => Object.prototype.hasOwnProperty.call(obj, k));
        const data = rows.map((row, idx) => {
          const idKey = mapKey(row, ['ç³»ç»Ÿå±¥çº¦å•å·','ç³»ç»Ÿå±¥çº¦å•ç¼–å·','ç³»ç»Ÿå±¥çº¦å•å· ']);
          const timeKey = mapKey(row, ['åº—é“ºè®¢å•æ—¶é—´','ä¸‹å•æ—¶é—´','åº—é“ºä¸‹å•æ—¶é—´']);
          const skuKey = mapKey(row, ['SKU','Sku','sku']);
          const qtyKey = mapKey(row, ['å•†å“æ•°é‡','æ•°é‡','ä»¶æ•°','qty','Qty']);

          const item = {
            'ç³»ç»Ÿå±¥çº¦å•å·': idKey ? String(row[idKey]).trim() : String(row['A']||'').trim(),
            'åº—é“ºè®¢å•æ—¶é—´': timeKey ? String(row[timeKey]).trim() : '',
            'SKU': skuKey ? String(row[skuKey]).trim() : '',
            'å•†å“æ•°é‡': qtyKey ? Number(row[qtyKey]||0) : 0
          };
          return item;
        }).filter(x => x['ç³»ç»Ÿå±¥çº¦å•å·'] || x['SKU']);

        if (!data.length) throw new Error('æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥è¡¨å¤´æ˜¯å¦ä¸ºï¼šç³»ç»Ÿå±¥çº¦å•å·/åº—é“ºè®¢å•æ—¶é—´/SKU/å•†å“æ•°é‡');
        return data;
      }
      $('#clearOldDataBtn').on('click', function() {
        layer.confirm('ç¡®å®šè¦æ¸…ç†5å¤©å‰çš„æ•°æ®å—ï¼Ÿæ¸…ç†åçš„æ•°æ®å°†ç§»åŠ¨åˆ°å†å²è®°å½•ä¸­ã€‚', function(index) {
          var token = localStorage.getItem('token');
          var headers = {};
          if (token) headers['Authorization'] = 'Bearer ' + token;
          $.ajax({
            url: window.apiConfig.baseURL + '/api/tmall-orders/wide/clear',
            type: 'POST',
            headers: headers,
            success: function(res) { if(res.success) { layer.msg('æ¸…ç†æˆåŠŸ: ' + res.message, {icon:1}); initWideTable(); } else { layer.msg('æ¸…ç†å¤±è´¥: ' + res.error, {icon:2}); } },
            error: function(xhr) { if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; }); } else { layer.msg('æ¸…ç†å¤±è´¥', {icon:2}); } }
          });
          layer.close(index);
        });
      });
      $('#clearAllDataBtn').on('click', function() {
        layer.confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰å¤©çŒ«å®½è¡¨æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ', {
          icon: 3, title: 'ç¡®è®¤æ¸…ç©º', btn: ['ç¡®å®šæ¸…ç©º', 'å–æ¶ˆ']
        }, function(index) {
          var token = localStorage.getItem('token');
          var headers = {};
          if (token) headers['Authorization'] = 'Bearer ' + token;
          $.ajax({
            url: window.apiConfig.baseURL + '/api/tmall-orders/wide/clear-all',
            type: 'POST',
            headers: headers,
            success: function(res) { if(res.success) { layer.msg('æ¸…ç©ºæˆåŠŸ: ' + res.message, {icon:1}); initWideTable(); } else { layer.msg('æ¸…ç©ºå¤±è´¥: ' + res.error, {icon:2}); } },
            error: function(xhr) { if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; }); } else { layer.msg('æ¸…ç©ºå¤±è´¥', {icon:2}); } }
          });
          layer.close(index);
        });
      });
      $('#addRecordBtn').on('click', function(){ form.val('editForm', {sku:'', name:'', url:'', initialStock:'', date:'', stock:''}); layer.open({ type:1, title:'æ–°å¢è®°å½•', area:['400px','480px'], content:$('#editFormModal'), btn:[], shadeClose:true }); });
      $('#refreshRecordBtn').on('click', renderRecordTable);
      $('#importRecordBtn').on('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls,.csv';
        input.onchange = function(e) {
          const file = e.target.files[0];
          if (!file) return;
          var token = localStorage.getItem('token');
          var formData = new FormData();
          formData.append('file', file);
          var headers = {};
          if (token) headers['Authorization'] = 'Bearer ' + token;
          $.ajax({
            url: window.apiConfig.baseURL + '/api/tmall-orders/records/batch',
            type: 'POST',
            headers: headers,
            data: formData,
            processData: false,
            contentType: false,
            success: function(res) { if(res.success) { layer.msg('å¯¼å…¥æˆåŠŸ: ' + res.message, {icon:1}); renderRecordTable(); } else { layer.msg('å¯¼å…¥å¤±è´¥: ' + res.error, {icon:2}); } },
            error: function(xhr) { if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; }); } else { layer.msg('å¯¼å…¥å¤±è´¥', {icon:2}); } }
          });
        };
        input.click();
      });
      $('#exportRecordBtn').on('click', function() {
        var token = localStorage.getItem('token');
        var headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        $.ajax({
          url: window.apiConfig.baseURL + '/api/tmall-orders/records/export',
          type: 'GET',
          headers: headers,
          xhrFields: { responseType: 'blob' },
          success: function(data) {
            const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tmall-records-export.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            layer.msg('å¯¼å‡ºæˆåŠŸ', {icon:1});
          },
          error: function(xhr) { if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; }); } else { layer.msg('å¯¼å‡ºå¤±è´¥', {icon:2}); } }
        });
      });
      $('#downloadRecordTemplateBtn').on('click', function() {
        const colHeaders = ['SKU', 'äº§å“ä¸­æ–‡å', 'ç½‘é¡µé“¾æ¥', 'åˆå§‹åº“å­˜', 'æ—¥æœŸï¼ˆYYYY-MM-DD HH:mmï¼‰', 'åº“å­˜'];
        const ws = XLSX.utils.aoa_to_sheet([colHeaders]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'å¤©çŒ«è®°å½•æ¨¡æ¿');
        XLSX.writeFile(wb, 'tmall-records-template.xlsx');
      });
      $('#clearAllRecordDataBtn').on('click', function() {
        layer.confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰å¤©çŒ«å†å²è®°å½•æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ', {
          icon: 3, title: 'ç¡®è®¤æ¸…ç©º', btn: ['ç¡®å®šæ¸…ç©º', 'å–æ¶ˆ']
        }, function(index) {
          var token = localStorage.getItem('token');
          var headers = {};
          if (token) headers['Authorization'] = 'Bearer ' + token;
          $.ajax({
            url: window.apiConfig.baseURL + '/api/tmall-orders/records/clear-all',
            type: 'POST',
            headers: headers,
            success: function(res) { if(res.success) { layer.msg('æ¸…ç©ºæˆåŠŸ: ' + res.message, {icon:1}); renderRecordTable(); } else { layer.msg('æ¸…ç©ºå¤±è´¥: ' + res.error, {icon:2}); } },
            error: function(xhr) { if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; }); } else { layer.msg('æ¸…ç©ºå¤±è´¥', {icon:2}); } }
          });
          layer.close(index);
        });
      });
      table.on('tool(recordTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'edit'){
          form.val('editForm', {
            sku: data.SKU,
            name: data['äº§å“ä¸­æ–‡å'],
            url: data['ç½‘é¡µé“¾æ¥'],
            initialStock: data['åˆå§‹åº“å­˜'],
            date: data['æ—¥æœŸ'],
            stock: data['åº“å­˜']
          });
          layer.open({ type:1, title:'ç¼–è¾‘è®°å½•', area:['400px','480px'], content:$('#editFormModal'), btn:[], shadeClose:true });
          $('#editFormModal').data('editId', data.id);
        } else if(obj.event === 'del'){
          layer.confirm('ç¡®å®šè¦åˆ é™¤è¯¥è®°å½•å—ï¼Ÿ', function(index){
            var token = localStorage.getItem('token');
            var headers = {};
            if (token) headers['Authorization'] = 'Bearer ' + token;
            $.ajax({
              url: window.apiConfig.baseURL + '/api/tmall-orders/records/'+data.id,
              type: 'DELETE',
              headers: headers,
              success: function(res){ if(res.success){ layer.msg('åˆ é™¤æˆåŠŸ', {icon:1}); renderRecordTable(); }else{ layer.msg('åˆ é™¤å¤±è´¥: '+res.error, {icon:2}); } },
              error: function(xhr) { if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; }); } else { layer.msg('åˆ é™¤å¤±è´¥', {icon:2}); } }
            });
            layer.close(index);
          });
        }
      });
      form.on('submit(submitEdit)', function(formObj){
        var editId = $('#editFormModal').data('editId');
        var method = editId ? 'PUT' : 'POST';
        var url = window.apiConfig.baseURL + '/api/tmall-orders/records' + (editId ? ('/'+editId) : '');
        var data = {
          SKU: formObj.field.sku,
          'äº§å“ä¸­æ–‡å': formObj.field.name,
          'ç½‘é¡µé“¾æ¥': formObj.field.url,
          'åˆå§‹åº“å­˜': formObj.field.initialStock,
          'æ—¥æœŸ': formObj.field.date,
          'åº“å­˜': formObj.field.stock
        };
        var token = localStorage.getItem('token');
        var headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = 'Bearer ' + token;
        $.ajax({
          url: url,
          type: method,
          headers: headers,
          data: JSON.stringify(data),
          success: function(res){ if(res.success){ layer.msg('ä¿å­˜æˆåŠŸ', {icon:1}); layer.closeAll(); if (currentMode === 'record') { renderRecordTable(); } }else{ layer.msg('ä¿å­˜å¤±è´¥: '+res.error, {icon:2}); } },
          error: function(xhr) { if (xhr.status === 401) { layer.msg('è¯·å…ˆç™»å½•', {icon:2}, function(){ window.location.href = 'login.html'; }); } else { layer.msg('ä¿å­˜å¤±è´¥', {icon:2}); } }
        });
        return false;
      });
      initWideTable();
    });
    function logout() {
      layer.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', {icon: 3, title: 'æç¤º'}, function(index){
        localStorage.removeItem('currentUser');
        layer.close(index);
        layer.msg('å·²å®‰å…¨é€€å‡ºï¼', {icon: 1}, function(){ window.location.href = 'login.html'; });
      });
    }
    function switchAccount() {
      layer.confirm('åˆ‡æ¢è´¦å·å°†é€€å‡ºå½“å‰ç™»å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ', {icon: 3, title: 'åˆ‡æ¢è´¦å·', btn: ['ç¡®å®š', 'å–æ¶ˆ']}, function(index) {
        localStorage.removeItem('currentUser');
        layer.close(index);
        layer.msg('æ­£åœ¨åˆ‡æ¢è´¦å·...', {icon: 16, time: 1000}, function(){ window.location.href = 'login.html'; });
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/handsontable@16.0.1/dist/handsontable.full.min.js"></script>
  <script>
    (function(){
      try {
        if (window.Handsontable && window.Handsontable.languages && window.Handsontable.languages.registerLanguageDictionary) {
          const zhCN = { languageCode: 'zh-CN' };
          window.Handsontable.languages.registerLanguageDictionary(zhCN);
        }
      } catch(e) { console.warn('Handsontable i18n æ³¨å†Œå¤±è´¥', e); }
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</body>
</html> 